<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geo Link Navi</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet.fullscreen plugin -->
<link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
<!-- Proj4JS for Coordinate Conversion -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>
<!-- GPX/KML Importer Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
<!-- [è¿½åŠ ] QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
:root {
/* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¤‰æ•° */
--primary-color: #667eea;
--secondary-color: #764ba2;
--bg-light: #f8f9fa;
--bg-page: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
--bg-container: white;
--text-dark: #333;
--text-medium: #666;
--border-color: #e0e0e0;
--card-bg: white;
--shadow-base: 0 20px 60px rgba(0,0,0,0.3);
--shadow-hover: 0 8px 24px rgba(0,0,0,0.12);

/* å…±é€š */
--radius-base: 10px;
--red-alert: #E64A19;
--btn-bulk: #90CAF9;
--btn-bulk-hover: #42A5F5;
--btn-toggle-all: #80CBC4;
--btn-toggle-all-hover: #26A69A;
--success-color: #1a621c;
--error-color: #E64A19;
--bookmark-color: #FFC107;

/* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼å¤‰æ•° */
--btn-current-location-bg: #A1C9FA;
--btn-current-location-hover-bg: #2563EB;
--btn-googlemap-bg: #98D7B1;
--btn-googlemap-hover-bg: #2d8e47;
--btn-paste-bg: #B1B9F5;
--btn-paste-hover-bg: #5568d3;
--btn-save-bookmark-bg: #FFE082;
--btn-save-bookmark-hover-bg: #e6b000;
--btn-address-search-bg: #607D8B;
--btn-address-search-hover-bg: #455A64;
--btn-export-kml-bg: #FBC02D;
--btn-export-kml-hover-bg: #F9A825;
--btn-format-toggle-bg: #d1c4e9;
--btn-format-toggle-hover-bg: #9575cd;

/* ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ç”¨ã®æ·¡ã„èƒŒæ™¯è‰² */
--btn-pin-bg: rgba(102, 126, 234, 0.7);
--btn-pin-pinned-bg: rgba(118, 75, 162, 0.7);
--btn-pin-hover-bg: rgba(118, 75, 162, 0.9);

/* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®å¤‰æ•° */
--autocomplete-bg: var(--card-bg);
--autocomplete-border: var(--border-color);
--autocomplete-item-hover-bg: var(--bg-light);

/* ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ç”¨ã®å¤‰æ•° */
--usage-guide-bg: rgba(248, 249, 250, 0.97);
--usage-guide-color: var(--text-dark);


/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚·ãƒ£ãƒ‰ã‚¦ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰) */
--shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.3);
--shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.4);
--shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.3);
--shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.3);
--shadow-other: 0 8px 24px rgba(156, 39, 176, 0.4);
--shadow-mylink: 0 8px 24px rgba(255, 193, 7, 0.4);
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¤‰æ•° */
body.dark-mode {
--primary-color: #4f46e5;
--secondary-color: #a855f7;
--bg-light: #1f2937;
--bg-page: #111827;
--bg-container: #1f2937;
--text-dark: #f3f4f6;
--text-medium: #d1d5db;
--border-color: #374151;
--card-bg: #374151;
--shadow-base: 0 10px 30px rgba(0,0,0,0.6);
--shadow-hover: 0 8px 24px rgba(255,255,255,0.1);

--btn-bulk: #448AFF;
--btn-bulk-hover: #2962FF;
--btn-toggle-all: #26A69A;
--btn-toggle-all-hover: #00897B;

/* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
--btn-current-location-bg: #3B82F6;
--btn-current-location-hover-bg: #2563EB;
--btn-googlemap-bg: #34A853;
--btn-googlemap-hover-bg: #2d8e47;
--btn-paste-bg: var(--primary-color);
--btn-paste-hover-bg: #5568d3;
--btn-save-bookmark-bg: var(--bookmark-color);
--btn-save-bookmark-hover-bg: #e6b000;
--btn-address-search-bg: #607D8B;
--btn-address-search-hover-bg: #455A64;
--btn-export-kml-bg: #FFC107;
--btn-export-kml-hover-bg: #E6B300;
--btn-format-toggle-bg: #5e35b1;
--btn-format-toggle-hover-bg: #4527a0;

/* ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ç”¨ã®æ·¡ã„èƒŒæ™¯è‰² (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
--btn-pin-bg: rgba(79, 70, 229, 0.6);
--btn-pin-pinned-bg: rgba(168, 85, 247, 0.6);
--btn-pin-hover-bg: rgba(168, 85, 247, 0.8);

/* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
--autocomplete-bg: var(--card-bg);
--autocomplete-border: var(--border-color);
--autocomplete-item-hover-bg: #2d3748;

/* ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ç”¨ã®å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
--usage-guide-bg: rgba(31, 41, 55, 0.97);
--usage-guide-color: var(--text-dark);

/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚·ãƒ£ãƒ‰ã‚¦ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
--shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.4);
--shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.4);
--shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.4);
--shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.4);
--shadow-other: 0 8px 24px rgba(156, 39, 176, 0.4);
--shadow-mylink: 0 8px 24px rgba(255, 193, 7, 0.4);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
background: var(--bg-page);
padding: 0;
min-height: 100vh;
color: var(--text-dark);
transition: background 0.5s, color 0.5s;
display: flex;
flex-direction: column;
}

.container {
max-width: 100%;
margin: 0;
width: 100vw;
background: var(--bg-container);
border-radius: 0;
box-shadow: var(--shadow-base);
overflow: hidden;
transition: background 0.5s, box-shadow 0.5s;
display: flex;
flex-direction: column;
flex-grow: 1;
}

.header {
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: white;
padding: 8px 15px;
position: relative;
flex-shrink: 0;
}

.header h1 { font-size: 24px; margin-bottom: 5px; }
.header p { display: none; }
.header-buttons { position: absolute; top: 10px; right: 15px; display: flex; gap: 10px; }
.header-button-wrapper { display: flex; flex-direction: column; align-items: center; gap: 3px; position: relative; }
.header-button-label { font-size: 10px; color: white; white-space: nowrap; opacity: 0.9; }

.mode-toggle, .history-button, .bookmark-button, .share-button, .nav-button, .settings-button, .usage-button, .qr-button {
background: rgba(255, 255, 255, 0.2);
border: none;
color: white;
width: 40px; height: 40px;
border-radius: 50%;
cursor: pointer;
font-size: 20px;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s;
}

.mode-toggle:hover, .history-button:hover, .bookmark-button:hover, .share-button:hover, .nav-button:hover:not(:disabled), .settings-button:hover, .usage-button:hover, .qr-button:hover {
background: rgba(255, 255, 255, 0.4);
transform: scale(1.05);
}

.nav-button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}


.history-popup, .bookmark-popup {
position: absolute;
background: var(--bg-container);
border: 1px solid var(--border-color);
border-radius: var(--radius-base);
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
width: 320px;
max-height: 450px;
padding: 10px;
z-index: 1050;
display: none;
color: var(--text-dark);
top: calc(100% + 10px);
right: 0;
}

.history-popup h4, .bookmark-popup h4 { margin-bottom: 10px; padding: 5px; border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-size: 14px; }
.popup-buttons { display: flex; gap: 5px; margin: 0 5px 10px; }
.popup-buttons button { flex: 1; min-width: 80px; padding: 8px 5px; font-size: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; border: none; color: white; }
.btn-clear-history, .btn-clear-bookmarks { background-color: var(--error-color); }
.btn-clear-history:hover, .btn-clear-bookmarks:hover { background-color: #C62828; }
.btn-export-csv { background-color: var(--primary-color); }
.btn-export-csv:hover { background-color: #5568d3; }
.btn-export-kml { background-color: var(--btn-export-kml-bg); }
.btn-export-kml:hover { background-color: var(--btn-export-kml-hover-bg); }

#historyList, #bookmarkList { max-height: 360px; overflow-y: auto; }

.history-item, .bookmark-item { padding: 8px 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: background-color: 0.2s; border: 1px solid transparent; }
.history-item:hover, .bookmark-item:hover { background-color: var(--bg-light); border-color: var(--primary-color); }
.bookmark-actions { margin-top: 5px; display: flex; gap: 5px; }
.bookmark-actions button { flex: 1; padding: 6px 8px; font-size: 11px; font-weight: 700; border-radius: 6px; border: none; transition: opacity 0.2s; color: white; }
.btn-bookmark-load { background-color: var(--primary-color); }
.btn-bookmark-open { background-color: var(--success-color); }
.btn-bookmark-delete { background-color: var(--error-color); }
.btn-bookmark-load:hover, .btn-bookmark-open:hover, .btn-bookmark-delete:hover { opacity: 0.8; }
.history-item strong, .bookmark-item strong { display: block; font-weight: 600; color: var(--text-dark); }
.history-item span, .bookmark-item span { color: var(--text-medium); font-size: 12px; display: block; margin-top: 3px; }

/* ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.usage-guide {
    background: var(--usage-guide-bg);
    color: var(--usage-guide-color);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-base);
    border-radius: 10px;
    padding: 20px 25px;
    font-size: 13px;
    display: none;
    animation: slideDown 0.3s ease;
    position: absolute;
    top: 65px;
    right: 15px;
    width: 1400px;
    max-width: 95vw;
    z-index: 1100;
}
.usage-guide.show { display: block; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.popup-warning { color: #FFF3CD; background-color: var(--red-alert); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 13px; font-weight: 700; }
.usage-guide ul { list-style: disc inside; padding-left: 20px; margin-top: 10px; }
.usage-guide li { margin-bottom: 5px; line-height: 1.5; }

.main-layout {
    display: flex;
    flex-grow: 1;
    background: var(--bg-light);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease-in-out;
}

.left-panel {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    transition: width 0.4s ease-in-out;
}

.right-panel {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 500px;
    max-width: 90%;

    display: flex;
    flex-direction: column;
    gap: 8px;
    overflow-y: auto;
    padding: 8px;
    background: var(--bg-container);
    border-radius: var(--radius-base);
    box-shadow: var(--shadow-base);
    border: 1px solid var(--border-color);
    
    transition: transform 0.4s ease-in-out;
    z-index: 1002;
}

#osmClickMap {
width: 100%;
height: 75vh;
border: 2px solid var(--secondary-color);
border-radius: 0;
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
flex-shrink: 0;
}

.input-section {
background: var(--bg-container);
padding: 10px 15px;
border-radius: var(--radius-base);
box-shadow: var(--shadow-hover);
border: 1px solid var(--border-color);
margin-top: 0;
}

.map-preview-container {
background: var(--bg-container);
padding: 5px;
border-radius: var(--radius-base);
box-shadow: var(--shadow-hover);
border: 1px solid var(--border-color);
margin-top: 0;
}

.input-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
}
.input-buttons-group {
    display: flex;
    gap: 8px;
}
.input-button-wrapper, .input-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.input-button-label, .input-field-label {
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
    color: var(--text-medium);
}
.input-group label {
    display: none;
}
.input-group.lat-group { flex: 2.5; min-width: 140px; }
.input-group.lon-group { flex: 2.5; min-width: 140px; }
.input-group.address-group { flex: 3; min-width: 220px; }
.input-row-bottom-buttons { display: contents; } /* Gridãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ */

.input-group input, .input-group select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--card-bg); color: var(--text-dark); height: 42px; }
.input-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
#latitude, #longitude { font-size: 14px; }
#addressInput { font-size: 15px; }

.input-wrapper {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
}
.btn-copy {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-medium);
    padding: 0 8px;
    height: 100%;
    position: absolute;
    right: 0;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-copy:hover {
    color: var(--primary-color);
}
.input-wrapper input {
    padding-right: 35px;
}

.btn-base { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 13px; color: white; min-width: 100px; height: 42px; display: inline-flex; align-items: center; justify-content: center; }
.btn-icon { min-width: 0; width: 42px; padding: 0; font-size: 22px; }

/* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-base:disabled, .bulk-toggle-container button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
    box-shadow: none;
    background-color: var(--border-color) !important;
    color: var(--text-medium) !important;
}

/* ãƒ‘ãƒãƒ«ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#toggleRightPanelBtn { background-color: var(--primary-color); }
#toggleRightPanelBtn:hover:not(:disabled) {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
}


.btn-current-location { background-color: var(--btn-current-location-bg); }
.btn-current-location:hover { background-color: var(--btn-current-location-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
.btn-paste { background-color: var(--btn-paste-bg); }
.btn-paste:hover { background-color: var(--btn-paste-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
.btn-googlemap { background-color: var(--btn-googlemap-bg); }
.btn-googlemap:hover { background-color: var(--btn-googlemap-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4); }
.btn-save-bookmark { color: var(--text-dark); background-color: var(--btn-save-bookmark-bg); }
.btn-save-bookmark:hover { background-color: var(--btn-save-bookmark-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4); }
.btn-address-search { font-size: 22px; color: white; background-color: var(--btn-address-search-bg); min-width: 0; width: 42px; padding: 0; height: 42px; border-radius: 8px; }
.btn-address-search:hover { background-color: var(--btn-address-search-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(96, 125, 139, 0.4); }
.btn-format-toggle { background-color: var(--btn-format-toggle-bg); color: var(--text-dark); font-size: 20px; }
.btn-format-toggle:hover { background-color: var(--btn-format-toggle-hover-bg); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(149, 117, 205, 0.4); }

.zoom-slider-overlay { position: absolute; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; }
body.dark-mode .zoom-slider-overlay { background: rgba(31, 41, 55, 0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.6); }
.zoom-slider-overlay label { font-size: 13px; font-weight: 600; white-space: nowrap; }
.zoom-slider-overlay input[type="range"] { width: 120px; height: 8px; -webkit-appearance: none; appearance: none; background: var(--border-color); border-radius: 4px; outline: none; padding: 0; margin: 0; cursor: pointer; }
.zoom-slider-overlay input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 2px solid var(--bg-container); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.zoom-slider-overlay input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: 2px solid var(--bg-container); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.zoom-slider-overlay input[type="range"]:hover::-webkit-slider-thumb, .zoom-slider-overlay input[type="range"]:active::-webkit-slider-thumb { background: var(--secondary-color); transform: scale(1.1); }
.zoom-slider-overlay input[type="range"]:hover::-moz-range-thumb, .zoom-slider-overlay input[type="range"]:active::-moz-range-thumb { background: var(--secondary-color); transform: scale(1.1); }
.zoom-slider-overlay #zoomLevelDisplay { font-weight: 700; color: var(--primary-color); width: 25px; text-align: center; font-size: 14px; }
body.dark-mode .zoom-slider-overlay #zoomLevelDisplay { color: var(--text-dark); }

.map-preview-container { margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
.preview-header { display: flex; align-items: center; font-size: 16px; margin-bottom: 10px; cursor: pointer; }
.preview-header h3 { font-size: 16px; margin: 0; padding-right: 10px; display: flex; align-items: center; gap: 8px; }
.preview-header h3 .btn-copy { position: static; height: auto; padding: 0 4px; }
.preview-header-icon { font-size: 14px; transition: transform 0.3s; margin-left: auto; }
.map-preview-wrapper { max-height: 600px; overflow: hidden; transition: max-height 0.3s ease-in-out; }
.map-preview-container.collapsed .map-preview-wrapper { max-height: 0; }
.map-preview-container.collapsed .preview-header-icon { transform: rotate(-90deg); }

#mapPreview {
width: 100%;
height: 600px;
border: 2px solid var(--secondary-color);
border-radius: 0;
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.osm-map-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }

.osm-map-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0px;
    padding-bottom: 0px;
}
.osm-map-wrapper {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}
.osm-map-container.collapsed .osm-map-wrapper {
    max-height: 0;
}
.osm-map-container.collapsed .preview-header-icon {
    transform: rotate(-90deg);
}

.content { padding: 8px; }

.category { margin-bottom: 8px; }

.category-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 8px;
padding: 5px 0;
border-bottom: 2px solid var(--border-color);
cursor: pointer;
flex-wrap: wrap;
gap: 8px;
}

.category-header:hover { border-bottom-color: var(--primary-color); }
.category-title-group { display: flex; align-items: center; flex-grow: 1; }
.category-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
.category-icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 8px; color: white; flex-shrink: 0; }
.accordion-icon { font-size: 18px; font-weight: 900; margin-left: 10px; transition: transform 0.3s; }
.category-header.collapsed .accordion-icon { transform: rotate(-90deg); }

.btn-bulk-open, .btn-toggle-all-checks {
color: white;
border: none;
padding: 0;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
font-size: 0;
width: 40px; height: 40px;
display: flex;
align-items: center;
justify-content: center;
white-space: nowrap;
overflow: hidden;
position: relative;
transition: background 0.3s, box-shadow 0.3s;
}

.btn-bulk-open { background: var(--btn-bulk); }
.btn-bulk-open:hover { background: var(--btn-bulk-hover); box-shadow: 0 4px 8px rgba(66, 165, 245, 0.4); }
.btn-toggle-all-checks { background: var(--btn-toggle-all); }
.btn-toggle-all-checks:hover { background: var(--btn-toggle-all-hover); box-shadow: 0 4px 8px rgba(38, 166, 154, 0.4); }


.btn-bulk-open::before {
content: 'â–¶ï¸';
font-size: 18px;
position: absolute;
color: white;
}
.btn-toggle-all-checks::before {
content: 'âœ…';
font-size: 18px;
position: absolute;
color: white;
}
.btn-toggle-all-checks.checked::before {
content: 'âŒ';
}

.map-grid.hidden { display: none; }
.terrain-icon { background: linear-gradient(135deg, #4CAF50, #45a049); }
.disaster-icon { background: linear-gradient(135deg, #FF5722, #E64A19); }
.geology-icon { background: linear-gradient(135deg, #FF9800, #F57C00); }
.survey-icon { background: linear-gradient(135deg, #2196F3, #1976D2); }
.other-icon { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
.mylink-icon { background: linear-gradient(135deg, #FFC107, #FFA000); }

.map-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
gap: 8px;
}

.map-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-base);
    padding: 6px;
    transition: all 0.3s;
    position: relative;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    min-height: 50px;
    justify-content: center;
}
.map-card:hover { transform: translateY(-4px); border-color: transparent; }
.map-card[data-category="terrain"]:hover { box-shadow: var(--shadow-terrain); }
.map-card[data-category="disaster"]:hover { box-shadow: var(--shadow-disaster); }
.map-card[data-category="geology"]:hover { box-shadow: var(--shadow-geology); }
.map-card[data-category="survey"]:hover { box-shadow: var(--shadow-survey); }
.map-card[data-category="other"]:hover { box-shadow: var(--shadow-other); }
.map-card[data-category="mylink"]:hover { box-shadow: var(--shadow-mylink); }
.map-card[data-category="terrain"] { border-left: 3px solid #4CAF50; }
.map-card[data-category="disaster"] { border-left: 3px solid #FF5722; }
.map-card[data-category="geology"] { border-left: 3px solid #FF9800; }
.map-card[data-category="survey"] { border-left: 3px solid #2196F3; }
.map-card[data-category="other"] { border-left: 3px solid #9C27B0; }
.map-card[data-category="mylink"] { border-left: 3px solid #FFC107; }

.map-header-with-check { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding-right: 5px; }
.map-title {
font-weight: 600;
font-size: 13px;
display: flex;
align-items: center;
gap: 5px;
margin-bottom: 0;
flex-grow: 1;
}
.map-title .map-icon-in-title {
font-size: 16px;
}

.map-checkbox { width: 16px; height: 16px; flex-shrink: 0; cursor: pointer; margin-left: 10px; z-index: 10; }
.map-description { display: none; }
.manual-input-warning { color: var(--red-alert); font-size: 11px; margin-top: 5px; font-weight: 600; }

.status-bar { background: var(--bg-light); padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-medium); gap: 15px; flex-shrink: 0; }
.status-bar strong { color: var(--text-dark); }
.notification { position: fixed; top: 20px; right: 20px; background: var(--success-color); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; animation: slideIn 0.3s ease; z-index: 2000; font-weight: 600; }
.notification.error { background: var(--error-color); }
@keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

#autocompleteList { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--autocomplete-bg); border: 1px solid var(--autocomplete-border); border-radius: var(--radius-base); box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 1001; list-style: none; padding: 5px 0; margin-top: 5px; display: none; }
#autocompleteList.show { display: block; }
.autocomplete-item { padding: 10px 15px; cursor: pointer; font-size: 14px; transition: background-color: 0.2s; }
.autocomplete-item:hover, .autocomplete-item.selected { background-color: var(--autocomplete-item-hover-bg); }
.autocomplete-item span { display: block; font-size: 12px; color: var(--text-medium); margin-top: 2px; }

.footer-copyright { text-align: center; color: var(--text-medium); font-size: 12px; padding: 10px 0; flex-shrink: 0; }
body.dark-mode .footer-copyright { color: var(--text-medium); }

.coord-conversion-section { padding: 15px; margin-top: 20px; border: 1px solid var(--border-color); border-radius: var(--radius-base); background-color: var(--card-bg); }
.coord-conversion-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
.coord-display-group { font-size: 13px; }
.coord-display-group label { font-weight: 700; color: var(--primary-color); display: block; margin-bottom: 5px; }
.coord-display-group p { font-family: 'Courier New', Courier, monospace; font-size: 14px; font-weight: 600; background-color: var(--bg-light); padding: 8px 12px; border-radius: 8px; word-wrap: break-word; min-height: 38px; }

.analysis-tools-overlay {
position: absolute;
bottom: 30px;
left: 10px;
z-index: 1000;
background: rgba(255, 255, 255, 0.8);
border-radius: 10px;
padding: 10px;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
body.dark-mode .analysis-tools-overlay { background: rgba(31, 41, 55, 0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.6); }
.analysis-tools-overlay h3 { font-size: 14px; margin: 0 0 8px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; }
.analysis-tools-overlay.collapsed h3 { margin-bottom: 0; border-bottom: none; }
.analysis-tools-overlay h3 .toggle-icon { display: inline-block; transition: transform 0.3s; }
.analysis-tools-overlay:not(.collapsed) h3 .toggle-icon { transform: rotate(90deg); }
.analysis-tools-controls { display: flex; flex-direction: column; gap: 8px; align-items: flex-start; overflow: hidden; transition: max-height 0.3s ease-in-out; max-height: 200px; }
.analysis-tools-overlay.collapsed .analysis-tools-controls { max-height: 0; }
.analysis-tool-row { display: flex; gap: 5px; align-items: center; }
.analysis-tools-controls .btn-base { height: 32px; width: 110px; padding: 0 10px; font-size: 12px; }
.analysis-tools-controls input[type="number"] { height: 32px; width: 60px; padding: 5px 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px; background-color: var(--card-bg); color: var(--text-dark); }
.btn-measure { background-color: #009688; }
.btn-measure:hover { background-color: #00796B; }
.btn-buffer { background-color: #E91E63; }
.btn-buffer:hover { background-color: #C2185B; }
.btn-clear-analysis { background-color: var(--error-color); }
.btn-clear-analysis:hover { background-color: #C62828; }
.btn-measure.active { background-color: #004D40; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }

.btn-area { background-color: #9C27B0; }
.btn-area:hover { background-color: #7B1FA2; }
.btn-area.active { background-color: #4A148C; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); }

.area-display-label {
font-size: 13px;
font-weight: 700;
color: var(--primary-color);
margin-left: 10px;
display: none;
white-space: nowrap;
background-color: var(--bg-light);
padding: 6px 10px;
border-radius: 6px;
}
body.dark-mode .area-display-label {
color: var(--text-dark);
}

.btn-add-mylink { width: 100%; padding: 10px; font-size: 14px; font-weight: bold; background-color: var(--btn-save-bookmark-bg); color: var(--text-dark); border: 2px dashed var(--bookmark-color); border-radius: var(--radius-base); cursor: pointer; }
.btn-add-mylink:hover { background-color: var(--btn-save-bookmark-hover-bg); border-color: var(--btn-save-bookmark-hover-bg); }
.map-card-actions { display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 10px; }
.map-card-actions button { flex: 1; padding: 8px; font-size: 12px; font-weight: 700; border-radius: 8px; border: none; color: white; cursor: pointer; }
.btn-mylink-edit { background-color: var(--primary-color); }
.btn-mylink-delete { background-color: var(--error-color); }
.btn-mylink-edit:hover, .btn-mylink-delete:hover { opacity: 0.8; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; display: none; }
.modal-content { background: var(--bg-container); padding: 25px; border-radius: var(--radius-base); width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.modal-content h3 { margin-top: 0; color: var(--primary-color); margin-bottom: 20px; }
.modal-form-group { margin-bottom: 15px; }
.modal-form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
.modal-form-group input, .modal-form-group textarea, .modal-form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-light); color: var(--text-dark); font-size: 14px; }
.modal-form-group small { font-size: 12px; color: var(--text-medium); }
.modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
.modal-buttons button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
.btn-modal-save { background-color: var(--success-color); color: white; }
.btn-modal-cancel { background-color: var(--border-color); color: var(--text-dark); }
.url-converter-group { display: flex; gap: 10px; align-items: center; }
.url-converter-group input { flex-grow: 1; }
.url-converter-group button { padding: 8px 12px; height: auto; min-width: 0; background-color: var(--btn-paste-bg); }

.bulk-toggle-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.bulk-toggle-container button {
    flex: 1;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background-color: var(--bg-light);
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    transition: background-color 0.2s, color 0.2s, border-color 0.2s;
}
.bulk-toggle-container button:hover:not(:disabled) {
    background-color: var(--border-color);
}
/* ãƒ”ãƒ³ç•™ã‚ãƒœã‚¿ãƒ³ã®å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
#pinPanelBtn {
    background-color: var(--btn-pin-bg);
    color: white;
    border-color: transparent;
    flex-grow: 0.5;
}
#pinPanelBtn:hover:not(:disabled) {
    background-color: var(--btn-pin-hover-bg);
}
#pinPanelBtn.pinned {
    background-color: var(--btn-pin-pinned-bg);
    color: white;
    border-color: var(--secondary-color);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.favorite-sets-container {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}
.favorite-sets-container label {
    font-size: 13px;
    font-weight: 600;
    margin-right: 10px;
    flex-shrink: 0;
}
.favorite-sets-container select {
    flex-grow: 1;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background-color: var(--card-bg);
    color: var(--text-dark);
    font-size: 13px;
}
.favorite-sets-container button {
    cursor: pointer;
    margin-left: 5px;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    font-size: 13px;
    flex-shrink: 0;
}
.btn-save-set {
    background-color: var(--btn-save-bookmark-bg);
    color: var(--text-dark);
}
.btn-delete-set {
    background-color: var(--error-color);
    color: white;
}
.btn-open-set {
    background-color: var(--btn-bulk);
    color: white;
}
.btn-open-set:hover {
    background-color: var(--btn-bulk-hover);
}

/* [è¿½åŠ ] QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#qr-modal .modal-content { max-width: 320px; }
#qrcode {
    padding: 20px;
    background: white;
    border-radius: var(--radius-base);
    display: flex;
    justify-content: center;
    align-items: center;
}
#qrcode img {
    max-width: 100%;
    height: auto;
}


@media (min-width: 1800px) {
    .left-panel {
        flex: 5;
    }
}

@media (max-width: 1400px) {
    .input-row {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    .input-buttons-group {
        justify-content: space-around;
    }
    .input-group {
        align-items: stretch;
    }
    .input-group label {
        display: block;
    }
    .input-field-label {
        display: none;
    }
}

@media (max-width: 1024px) {
    #osmClickMap {
        height: 60vh;
    }
    #mapPreview {
        height: 400px;
    }
}

/* [å¤‰æ›´ç‚¹] ã‚¹ãƒãƒ›/ç‹­ã„ç”»é¢ã§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’CSS Gridã§æ”¹å–„ */
@media (max-width: 768px) {
    .header-buttons { right: 10px; top: 15px; gap: 5px; }
    .mode-toggle, .history-button, .bookmark-button, .share-button, .settings-button, .usage-button, .qr-button { width: 35px; height: 35px; font-size: 16px; }
    .header-button-label { font-size: 9px; }
    .history-popup, .bookmark-popup {
        width: calc(100vw - 20px);
        left: 10px;
        right: auto;
        top: 60px;
    }
    .analysis-tools-overlay { bottom: 10px; }
    
    .input-row {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
            "buttons buttons"
            "lat lon"
            "address address"
            "search panel";
    }
    .input-buttons-group {
        grid-area: buttons;
        width: 100%;
        justify-content: space-between;
    }
    .input-group.lat-group { grid-area: lat; }
    .input-group.lon-group { grid-area: lon; }
    .input-group.address-group { grid-area: address; }
    .input-row-bottom-buttons {
        grid-area: search / span 2;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
    }
    
    #osmClickMap {
        height: 50vh;
    }
}

/* --- ãƒ‘ãƒãƒ«é–‹é–‰ï¼‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä»˜ãã‚¹ãƒ©ã‚¤ãƒ‰å‹•ä½œ --- */
.right-panel.hidden {
    transform: translateX(100%);
    pointer-events: none;
}

/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#panelOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(2px);
    z-index: 1000;
    display: block;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease-in-out;
}
#panelOverlay.show {
    opacity: 1;
    pointer-events: auto;
}

/* main-layoutãŒpinnedã‚¯ãƒ©ã‚¹ã‚’æŒã¤æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ */
.main-layout.pinned {
    overflow-x: auto;
}

.main-layout.pinned .left-panel {
    width: calc(100% - 510px);
}

.main-layout.pinned .right-panel {
    position: relative;
    transform: translateX(0) !important;
    height: auto;
    pointer-events: auto;
}

.main-layout.pinned #panelOverlay {
    display: none !important;
}

</style>
</head>
<body class="light-mode">
<div class="notification" id="notification"></div>
<div class="container">
<div class="header">
<h1>ğŸ—ºï¸ Geo Link Navi</h1>
<div class="header-buttons">
    <div class="header-button-wrapper">
        <button class="nav-button" id="navBack" title="å‰ã®åº§æ¨™ã«æˆ»ã‚‹" disabled>â—€</button>
        <span class="header-button-label">æˆ»ã‚‹</span>
    </div>
    <div class="header-button-wrapper">
        <button class="nav-button" id="navForward" title="æ¬¡ã®åº§æ¨™ã«é€²ã‚€" disabled>â–¶</button>
        <span class="header-button-label">é€²ã‚€</span>
    </div>
    <div class="header-button-wrapper">
        <button class="share-button" id="shareButton" onclick="generateShareUrl()" aria-label="ãƒªãƒ³ã‚¯å…±æœ‰" title="ç¾åœ¨ã®çŠ¶æ…‹ã‚’å…±æœ‰">ğŸ”—</button>
        <span class="header-button-label">ãƒªãƒ³ã‚¯å…±æœ‰</span>
    </div>
    <!-- [è¿½åŠ ] QRã‚³ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
    <div class="header-button-wrapper">
        <button class="qr-button" onclick="openQrModal()" aria-label="QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰" title="QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰">ğŸ“±</button>
        <span class="header-button-label">QRã‚³ãƒ¼ãƒ‰</span>
    </div>
    <div class="header-button-wrapper">
        <button class="bookmark-button" id="bookmarkButton" onclick="toggleBookmarkPopup()" aria-label="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º">â­</button>
        <span class="header-button-label">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</span>
        <div class="bookmark-popup" id="bookmarkPopup">
            <h4>â­ åœ°ç‚¹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h4>
            <div class="popup-buttons">
            <button class="btn-clear-bookmarks" onclick="clearBookmarks()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
            <button class="btn-export-csv" onclick="exportBookmarksToCSV()">ğŸ’¾ CSV</button>
            <button class="btn-export-kml" onclick="exportBookmarksToKML()">ğŸŒ KML</button>
            </div>
            <div id="bookmarkList"></div>
        </div>
    </div>
    <div class="header-button-wrapper">
        <button class="history-button" id="historyButton" onclick="toggleHistoryPopup()" aria-label="å±¥æ­´" title="å±¥æ­´ã‚’è¡¨ç¤º">â±ï¸</button>
        <span class="header-button-label">å±¥æ­´</span>
        <div class="history-popup" id="historyPopup">
            <h4>åº§æ¨™å±¥æ­´</h4>
            <div class="popup-buttons">
            <button class="btn-clear-history" onclick="clearHistory()">ğŸ—‘ï¸ å±¥æ­´ã‚¯ãƒªã‚¢</button>
            <button class="btn-export-csv" onclick="exportHistoryToCSV()">ğŸ’¾ CSV</button>
            <button class="btn-export-kml" onclick="exportHistoryToKML()">ğŸŒ KML</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
    <div class="header-button-wrapper">
        <button class="settings-button" id="settingsButton" title="è¨­å®š">âš™ï¸</button>
        <span class="header-button-label">è¨­å®š</span>
    </div>
    <div class="header-button-wrapper">
        <button class="mode-toggle" id="modeToggle" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ" title="ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>
        <span class="header-button-label">ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</span>
    </div>
    <div class="header-button-wrapper">
        <button class="usage-button" onclick="toggleUsage()" title="ä½¿ã„æ–¹ã‚’è¡¨ç¤º">ï¼Ÿ</button>
        <span class="header-button-label">ä½¿ã„æ–¹</span>
    </div>
</div>
<div class="usage-guide" id="usageGuide">
    <p>â˜…çŸ¥ã‚ŠãŸã„å ´æ‰€ã®ç·¯åº¦ãƒ»çµŒåº¦ã‹ã‚‰ã€è¤‡æ•°ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åœ°å›³ã‚„å°‚é–€å›³é¢ã‚µã‚¤ãƒˆã¸ç¬æ™‚ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚æƒ…å ±åé›†ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚â˜…</p>
    <p class="popup-warning">âš ï¸ **æ³¨æ„:** è¤‡æ•°ã®åœ°å›³ã‚’ä¸€æ‹¬ã§é–‹ãã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ï¼‰ã—ã¦ãã ã•ã„ã€‚</p>
    <ul>
    <li>ã€ŒğŸ—ºï¸ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å–å¾— åœ°å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€:ğŸ–±ï¸ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã®åº§æ¨™ã‚’ç·¯åº¦çµŒåº¦ã«åæ˜ ã—ã¾ã™ã€‚å…¨ç”»é¢ã§é¸æŠã—ãŸå ´åˆã¯ESCã§æˆ»ã£ã¦ãã ã•ã„ã€‚OpenStreetã¨åœ°ç†é™¢åœ°å›³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
    <li>ã€ŒğŸ› ï¸æ¸¬é‡ãƒ„ãƒ¼ãƒ«ã€: ã€ŒğŸ“ è·é›¢è¨ˆæ¸¬ã€ã€ŒğŸ“ é¢ç©è¨ˆæ¸¬ã€ã€Œâ­• å††ä½œæˆã€ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚é¢ç©ã¯3ç‚¹ç›®ä»¥é™ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãŸã³ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¨ˆæ¸¬ãŒå®Œäº†ã—ã¾ã™ã€‚</li>
    <li>ã€ŒğŸ—ºï¸ç¾åœ¨ã®åº§æ¨™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ï¼šğŸ–±ï¸ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ãŒåŸ‹ã‚è¾¼ã¾ã‚ŒãŸGoogleãƒãƒƒãƒ—ã«åæ˜ ã•ã‚Œã¾ã™ã€‚ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‰±ã„ã§ã™ï¼‰</li>
    <li>ã€ŒğŸ“ç¾åœ¨åœ°ã€ãƒœã‚¿ãƒ³:ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã®ä½ç½®æƒ…å ±æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€ç¾åœ¨åœ°ã®åº§æ¨™ã‚’è‡ªå‹•ã§å…¥åŠ›ã—ã¾ã™ã€‚ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</li>
    <li>ã€ŒğŸŒGoogleãƒãƒƒãƒ—ã§æ¢ã™ã€ãƒœã‚¿ãƒ³ï¼šãƒãƒƒãƒ—ã‚’é–‹ã„ã¦èª¿ã¹ãŸã„å ´æ‰€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ åº§æ¨™ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</li>
    <li>ã€ŒğŸ“„ è²¼ã‚Šä»˜ã‘ã€ãƒœã‚¿ãƒ³ï¼šã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç·¯åº¦ãƒ»çµŒåº¦ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</li>
    <li>ã€Œâ­ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ï¼šãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€ã«åå‰ã‚’ã¤ã‘ã¦ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜ã§ãã¾ã™ã€‚</li>
    <li>ã€Œâš™ï¸å½¢å¼åˆ‡æ›¿ã€: ã€Œåº§æ¨™è¡¨ç¤ºå½¢å¼åˆ‡æ›¿ã€ãƒœã‚¿ãƒ³ã§ã€ç·¯åº¦çµŒåº¦ã®è¡¨ç¤ºã‚’ã€Œåé€²æ•°å½¢å¼ã€ã¨ã€Œåº¦åˆ†ç§’å½¢å¼ã€ã§åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
    <li>ã€ŒğŸ”ä½æ‰€æ¤œç´¢ã€ãƒœã‚¿ãƒ³:ä½æ‰€ã‚„ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãªã©ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã™ã‚‹ã¨ã€ãã“ã®ç·¯åº¦ãƒ»çµŒåº¦ã‚’åœ°å›³ã«åæ˜ ã§ãã¾ã™ã€‚å…¥åŠ›ä¸­ã«å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
    <li>ã€Œâ—€ ãƒ‘ãƒãƒ«ã€ãƒœã‚¿ãƒ³ï¼šç”»é¢å³ã®åœ°å›³é¸æŠãƒ‘ãƒãƒ«ã‚’é–‹é–‰ã—ã¾ã™ã€‚</li>
    <li>ã€ŒğŸ“Œ ãƒ”ãƒ³ç•™ã‚ã€ãƒœã‚¿ãƒ³ï¼šãƒ‘ãƒãƒ«ã‚’é–‹ã„ãŸçŠ¶æ…‹ã§ç”»é¢ã«å›ºå®šã—ã¾ã™ã€‚åºƒã„ç”»é¢ã§åœ°å›³ã¨æƒ…å ±ã‚’åŒæ™‚ã«è¦‹ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚ãƒ”ãƒ³ç•™ã‚ã‚’è§£é™¤ã™ã‚‹ã¨ãƒ‘ãƒãƒ«ã¯è‡ªå‹•çš„ã«é–‰ã˜ã¾ã™ã€‚</li>
    <li>å„ç¨®åœ°å›³ã‚«ãƒ¼ãƒ‰:ç”»é¢ä¸‹éƒ¨ã®ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã€åˆ©ç”¨ã—ãŸã„åœ°å›³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…¥åŠ›åº§æ¨™ã‚’ä¸­å¿ƒã¨ã—ãŸåœ°å›³ãŒæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚</li>
    <li>å…¨é¸æŠ/å…¨è§£é™¤ãƒœã‚¿ãƒ³:å„ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ã‚‹ã€Œâœ… å…¨é¸æŠ/è§£é™¤ã€ãƒœã‚¿ãƒ³ã§ã€ãã®ã‚«ãƒ†ã‚´ãƒªå†…ã®ã™ã¹ã¦ã®åœ°å›³ã‚«ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
    <li>ä¸€æ‹¬é¸æŠãƒ»ã‚ªãƒ¼ãƒ—ãƒ³:å„ã‚«ãƒ†ã‚´ãƒªã®ã€Œâ–¶ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä¸€æ‹¬ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å°ã‚’ä»˜ã‘ãŸè¤‡æ•°ã®åœ°å›³ã‚’ä¸€åº¦ã«é–‹ãã“ã¨ãŒã§ãã¾ã™ã€‚</li>
    <li>ã€ŒğŸ”— ãƒªãƒ³ã‚¯å…±æœ‰ã€: ç¾åœ¨ã®åº§æ¨™ã‚„ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãã®ã¾ã¾ä»–ã®äººã«å…±æœ‰ã§ãã‚‹URLã‚’ç”Ÿæˆã—ã¾ã™ã€‚</li>
    <li>ã€Œâ­ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€ï¼šä»»æ„ã®åœ°ç‚¹ã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã§ãã¾ã™ã€‚ã€Œâ±ï¸å±¥æ­´ã€ï¼šã‚¯ãƒªãƒƒã‚¯ä½ç½®ãŒè‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã©ã¡ã‚‰ã‚‚ã€è¨˜éŒ²ã¯ğŸ’¾ CSVã¾ãŸã¯ğŸŒ KMLã§æ›¸ãå‡ºã›ã¾ã™ã€‚</li>
    <li>ã€Œâš™ï¸è¨­å®šã€: èµ·å‹•æ™‚ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã€ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºçŠ¶æ…‹ãªã©ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚</li>
    <li>â­ ãƒã‚¤ãƒªãƒ³ã‚¯: è‡ªåˆ†å°‚ç”¨ã®Webåœ°å›³ã¸ã®ãƒªãƒ³ã‚¯ã‚’è‡ªç”±ã«è¿½åŠ ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚</li>
    </ul>
</div>
</div>

<!-- åŠé€æ˜ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="panelOverlay" onclick="toggleRightPanel()"></div>

<div class="main-layout">
    <div class="left-panel">
        <div class="input-section">
            <div class="input-row">
                <div class="input-buttons-group">
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-current-location" onclick="initGeolocation()" title="ç¾åœ¨åœ°ã‚’å–å¾—">ğŸ“</button>
                        <span class="input-button-label">ç¾åœ¨åœ°</span>
                    </div>
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-googlemap" onclick="openGoogleMap()" title="Googleãƒãƒƒãƒ—ã§æ¢ã™">ğŸŒ</button>
                        <span class="input-button-label">Googleãƒãƒƒãƒ—</span>
                    </div>
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-paste" onclick="pasteCoordinates()" title="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘">ğŸ“„</button>
                        <span class="input-button-label">è²¼ã‚Šä»˜ã‘</span>
                    </div>
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-save-bookmark" onclick="saveCurrentAsBookmark()" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜">â­</button>
                        <span class="input-button-label">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</span>
                    </div>
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-format-toggle" id="coord-format-toggle" title="è¡¨ç¤ºå½¢å¼åˆ‡æ›¿">âš™ï¸</button>
                        <span class="input-button-label">å½¢å¼åˆ‡æ›¿</span>
                    </div>
                </div>
                <div class="input-group lat-group">
                    <label for="latitude">ğŸ“ ç·¯åº¦ (Latitude)</label>
                    <div class="input-wrapper">
                        <input type="text" id="latitude" value="35.68107447">
                        <button class="btn-copy" title="ç·¯åº¦ã‚’ã‚³ãƒ”ãƒ¼" onclick="copyToClipboard('latitude')">ğŸ“‹</button>
                    </div>
                    <span class="input-field-label">ğŸ“ ç·¯åº¦ (Latitude)</span>
                </div>
                <div class="input-group lon-group">
                    <label for="longitude">ğŸ“ çµŒåº¦ (Longitude)</label>
                    <div class="input-wrapper">
                        <input type="text" id="longitude" value="139.76784396">
                        <button class="btn-copy" title="çµŒåº¦ã‚’ã‚³ãƒ”ãƒ¼" onclick="copyToClipboard('longitude')">ğŸ“‹</button>
                    </div>
                    <span class="input-field-label">ğŸ“ çµŒåº¦ (Longitude)</span>
                </div>
                <div class="input-group address-group">
                    <label for="addressInput">ğŸ  ä½æ‰€ã‚„åç§°ãªã©ã‹ã‚‰æ¤œç´¢</label>
                    <div class="input-wrapper">
                        <input type="text" id="addressInput" placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1">
                        <div id="autocompleteList" class="autocomplete-list"></div>
                    </div>
                    <span class="input-field-label">ğŸ  ä½æ‰€ã‚„åç§°ãªã©</span>
                </div>
                <!-- [å¤‰æ›´ç‚¹] ã‚¹ãƒãƒ›è¡¨ç¤ºã§grid-areaã‚’é©ç”¨ã™ã‚‹ãŸã‚ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ  -->
                <div class="input-row-bottom-buttons">
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon btn-address-search" onclick="searchAddress()" title="ä½æ‰€ã‚’æ¤œç´¢">ğŸ”</button>
                        <span class="input-button-label">æ¤œç´¢</span>
                    </div>
                    <div class="input-button-wrapper">
                        <button class="btn-base btn-icon" id="toggleRightPanelBtn" onclick="toggleRightPanel()" title="ãƒ‘ãƒãƒ«ã‚’é–‹ã">â—€</button>
                        <span class="input-button-label">ãƒ‘ãƒãƒ«</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="osm-map-container" id="mainMapContainer">
            <div class="osm-map-header" onclick="toggleMainMap()">
                <h3>ğŸ—ºï¸ ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å–å¾— / åœ°å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <span class="preview-header-icon" id="mainMapToggleIcon">â–¼</span>
            </div>
            <div class="osm-map-wrapper">
                <div id="osmClickMap">
                    <div class="analysis-tools-overlay collapsed" id="analysis-tools">
                        <h3 id="analysis-tools-header">ğŸ› ï¸ æ¸¬é‡ãƒ»è§£æãƒ„ãƒ¼ãƒ« <span class="toggle-icon">â–¶</span></h3>
                        <div class="analysis-tools-controls">
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-measure" id="measure-tool-btn">ğŸ“ è·é›¢è¨ˆæ¸¬</button>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-area" id="area-tool-btn">ğŸ“ é¢ç©è¨ˆæ¸¬</button>
                                <span id="area-display" class="area-display-label"></span>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-buffer" id="buffer-tool-btn">â­• å††ä½œæˆ</button>
                                <label for="buffer-radius-input" style="font-size: 13px; font-weight: 600; margin: 0 5px;">åŠå¾„</label>
                                <input type="number" id="buffer-radius-input" value="500" min="1">
                                <label for="buffer-radius-input" style="font-size: 13px; font-weight: 600;">m</label>
                            </div>
                            <div class="analysis-tool-row">
                                <button class="btn-base btn-clear-analysis" id="clear-analysis-btn">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                            </div>
                        </div>
                    </div>
                    <div class="zoom-slider-overlay">
                        <label for="zoomLevel">ã‚ºãƒ¼ãƒ :</label>
                        <input type="range" id="zoomLevel" value="16" min="1" max="20">
                        <span id="zoomLevelDisplay">16</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-preview-container" id="previewContainer">
            <div class="preview-header" onclick="togglePreview(event)">
                <h3>ğŸ—ºï¸ ç¾åœ¨ã®åº§æ¨™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Google):
                    <strong id="currentCoords">...</strong>
                    <button class="btn-copy" title="åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ (lat, lon)" onclick="copyToClipboard('currentCoords')">ğŸ“‹</button>
                     (Zoom: <strong id="currentZoom">...</strong>)
                </h3>
                <span class="preview-header-icon">â–¼</span>
            </div>
            <div class="map-preview-wrapper">
                <iframe id="mapPreview" width="100%" height="600" frameborder="0" allowfullscreen="" aria-hidden="false" tabindex="0" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <div class="right-panel hidden">
        <div class="bulk-toggle-container">
            <button id="expandAllCategories">â• ã™ã¹ã¦å±•é–‹</button>
            <button id="collapseAllCategories">â– ã™ã¹ã¦æŠ˜ã‚ŠãŸãŸã¿</button>
            <button id="pinPanelBtn" onclick="togglePinPanel()">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</button>
        </div>
        <div class="favorite-sets-container">
            <label for="favorite-sets">ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆ:</label>
            <select id="favorite-sets"></select>
            <button id="open-set" class="btn-open-set">é–‹ã</button>
            <button id="clear-all-checks">è§£é™¤</button>
            <button id="save-set" class="btn-save-set">âœ“ä¿å­˜</button>
            <button id="delete-set" class="btn-delete-set">ğŸ—‘ï¸å‰Šé™¤</button>
        </div>
        <div class="content" id="map-categories-container"></div>
    </div>
</div>

<div class="status-bar">
    <span id="lastUpdated"></span>
</div>
</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ã«è¿½åŠ æ¨å¥¨ -->
<div class="legal-notice">
  â€»æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŠã‚ˆã³å…¬çš„æ©Ÿé–¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™:
  - åœ°å›³ãƒ‡ãƒ¼ã‚¿: Â© å›½åœŸåœ°ç†é™¢, Â© OpenStreetMap contributors
  - ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: Leaflet (BSD-2), QRCode.js (MIT), proj4js (MIT)
</div>

<div class="modal-overlay" id="mylink-modal">
<div class="modal-content">
<h3 id="modal-title"></h3>
<form id="mylink-form">
<input type="hidden" id="mylink-id">
<div class="modal-form-group">
<label for="mylink-name">åå‰</label>
<input type="text" id="mylink-name" required placeholder="ä¾‹: My Favorite Map">
</div>

<div class="modal-form-group">
    <label for="mylink-example-url">â‘  å®ŸURLã‹ã‚‰å¤‰æ›</label>
    <div class="url-converter-group">
        <input type="text" id="mylink-example-url" placeholder="åº§æ¨™ã‚’å«ã‚€URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘">
        <button type="button" id="btn-convert-url" class="btn-base">å¤‰æ›</button>
    </div>
    <small>ä¾‹: https://maps.app.goo.gl/xxxxx ã®ã‚ˆã†ãªURL</small>
</div>

<div class="modal-form-group">
<label for="mylink-url">â‘¡ URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
<input type="text" id="mylink-url" required placeholder="https://example.com/?lat={lat}&lon={lon}&z={z}">
<small>ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€: {lat}, {lon}, {z} ãŒä½¿ç”¨ã§ãã¾ã™ã€‚</small>
</div>
<div class="modal-form-group">
<label for="mylink-desc">èª¬æ˜ (ä»»æ„)</label>
<textarea id="mylink-desc" rows="2" placeholder="ã“ã®ãƒªãƒ³ã‚¯ã«ã¤ã„ã¦ã®ç°¡å˜ãªèª¬æ˜"></textarea>
</div>
<div class="modal-buttons">
<button type="button" class="btn-modal-cancel" id="btn-mylink-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button type="submit" class="btn-modal-save">ä¿å­˜</button>
</div>
</form>
</div>
</div>

<div class="modal-overlay" id="settings-modal">
    <div class="modal-content">
        <h3>âš™ï¸ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h3>
        <form id="settings-form">
            <div class="modal-form-group">
                <label for="settings-zoom">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«: <span id="settings-zoom-value">16</span></label>
                <input type="range" id="settings-zoom" min="1" max="20" step="1">
                <small>èµ·å‹•æ™‚ã®åœ°å›³ã®ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-default-layer">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼</label>
                <select id="settings-default-layer"></select>
                <small>èµ·å‹•æ™‚ã«æœ€åˆã«è¡¨ç¤ºã•ã‚Œã‚‹åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¾ã™ã€‚</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-theme">ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒ</label>
                <select id="settings-theme">
                    <option value="light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
                    <option value="dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
                </select>
                <small>ã‚¢ãƒ—ãƒªå…¨ä½“ã®è¦‹ãŸç›®ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-coord-format">åº§æ¨™ã®è¡¨ç¤ºå½¢å¼</label>
                <select id="settings-coord-format">
                    <option value="decimal">åé€²æ•° (ä¾‹: 35.123456)</option>
                    <option value="dms">åº¦åˆ†ç§’ (ä¾‹: 35Â°07'24.4" N)</option>
                </select>
                <small>ç·¯åº¦çµŒåº¦ã®è¡¨ç¤ºãƒ»å…¥åŠ›å½¢å¼ã‚’é¸æŠã—ã¾ã™ã€‚</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-history-size">å±¥æ­´ã®ä¿æŒæ•°</label>
                <input type="number" id="settings-history-size" min="10" max="500" step="10">
                <small>åº§æ¨™ã®ã‚¯ãƒªãƒƒã‚¯å±¥æ­´ã‚’æœ€å¤§ä½•ä»¶ã¾ã§ä¿æŒã™ã‚‹ã‹è¨­å®šã—ã¾ã™ã€‚</small>
            </div>
            <div class="modal-form-group">
                <label for="settings-panel-state">èµ·å‹•æ™‚ã®ãƒ‘ãƒãƒ«è¡¨ç¤º</label>
                <select id="settings-panel-state">
                    <option value="closed">é–‰ã˜ã‚‹</option>
                    <option value="open">é–‹ã</option>
                    <option value="pinned">ãƒ”ãƒ³ç•™ã‚ã—ã¦é–‹ã</option>
                </select>
                <small>ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®å³å´ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’é¸æŠã—ã¾ã™ã€‚ï¼ˆPCè¡¨ç¤ºã®ã¿ï¼‰</small>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-modal-cancel" id="btn-settings-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn-modal-save">è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>
<!-- [è¿½åŠ ] QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="qr-modal" onclick="closeQrModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>ğŸ“± QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰</h3>
        <div id="qrcode"></div>
        <div class="modal-buttons">
            <button type="button" class="btn-modal-cancel" onclick="closeQrModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>
<script>
/**
 * ä¸–ç•Œæ¸¬åœ°ç³»(WGS84)ã‹ã‚‰æ—¥æœ¬æ¸¬åœ°ç³»(Tokyo Datum)ã¸åº§æ¨™ã‚’å¤‰æ›ã™ã‚‹é–¢æ•°
 * @param {number} lat ç·¯åº¦ (WGS84)
 * @param {number} lon çµŒåº¦ (WGS84)
 * @returns {{lat: number, lon: number}} å¤‰æ›å¾Œã®ç·¯åº¦çµŒåº¦ (Tokyo Datum)
 */
function convertWgs84ToTokyo(lat, lon) {
  try {
    // å¤‰æ›å…ƒã®åº§æ¨™ç³»: WGS84 (EPSG:4326)
    const sourceProj = 'EPSG:4326';
    // å¤‰æ›å…ˆã®åº§æ¨™ç³»: Tokyo Datum (EPSG:4301)
    const destProj = 'EPSG:4301';

    // proj4jsã«æ—¥æœ¬æ¸¬åœ°ç³»ã®å®šç¾©ã‚’è¿½åŠ ï¼ˆæœªå®šç¾©ã®å ´åˆã®ã¿ï¼‰
    if (proj4.defs(destProj) === undefined) {
      proj4.defs(destProj, "+proj=longlat +ellps=bessel +towgs84=-146.414,507.337,680.507,0,0,0,0 +no_defs");
    }

    // proj4jsã‚’ä½¿ã£ã¦å¤‰æ›ã‚’å®Ÿè¡Œ
    const [newLon, newLat] = proj4(sourceProj, destProj, [lon, lat]);

    return { lat: newLat, lon: newLon };
  } catch (e) {
    console.error("åº§æ¨™å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€å¤‰æ›ã›ãšã«å…ƒã®åº§æ¨™ã‚’è¿”ã™
    return { lat: lat, lon: lon };
  }
}
const CATEGORY_META = { 'all': { title: 'ã™ã¹ã¦ã®åœ°å›³', icon: 'ğŸŒ', class: '' }, 'terrain': { title: 'åœ°å›³ãƒ»åœ°ç†æƒ…å ±', icon: 'ğŸ—»', class: 'terrain-icon' }, 'geology': { title: 'åœ°è³ªãƒ»åœ°ç›¤æƒ…å ±', icon: 'ğŸ”ï¸', class: 'geology-icon' }, 'disaster': { title: 'é˜²ç½ãƒ»ãƒã‚¶ãƒ¼ãƒ‰æƒ…å ±', icon: 'âš ï¸', class: 'disaster-icon' }, 'survey': { title: 'æ¸¬é‡ãƒ»è§£æãƒ„ãƒ¼ãƒ«', icon: 'ğŸ“', class: 'survey-icon' }, 'other': { title: 'ãã®ä»–ã®æƒ…å ±', icon: 'ğŸ’¡', class: 'other-icon' }, 'mylink': { title: 'â­ ãƒã‚¤ãƒªãƒ³ã‚¯', icon: 'â­', class: 'mylink-icon'} };

const BASE_LAYERS = {
    'osm': { name: 'OpenStreetMap', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: 'Â© OpenStreetMap contributors', layer: null, maxZoom: 19 },
    'gsi_std': { name: 'åœ°ç†é™¢åœ°å›³ï¼ˆæ¨™æº–ï¼‰', url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', attribution: 'Â© å›½åœŸåœ°ç†é™¢', layer: null, maxZoom: 18 },
    'gsi_pale': { name: 'åœ°ç†é™¢åœ°å›³ï¼ˆæ·¡è‰²ï¼‰', url: 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', attribution: 'Â© å›½åœŸåœ°ç†é™¢', layer: null, maxZoom: 18 },
    'gsi_seamlessphoto': { name: 'åœ°ç†é™¢åœ°å›³ï¼ˆå†™çœŸï¼‰', url: 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', attribution: 'Â© å›½åœŸåœ°ç†é™¢', layer: null, maxZoom: 18 },
    'gsi_relief': { name: 'åœ°ç†é™¢åœ°å›³ï¼ˆè‰²åˆ¥æ¨™é«˜å›³ï¼‰', url: 'https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png', attribution: 'Â© å›½åœŸåœ°ç†é™¢', layer: null, maxZoom: 15 }
};

const MAP_DEFINITIONS = [ { id: 'gsi_std', name: 'åœ°ç†é™¢åœ°å›³', desc: 'å›½åœŸåœ°ç†é™¢ã®åŸºæœ¬åœ°å›³ã€‚æ¨™é«˜ã€åœ°å½¢ã€åœŸåœ°åˆ©ç”¨ãªã©', category: 'terrain', icon: 'ğŸ—ºï¸', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c0g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'gsi_time', name: 'åœ°ç†é™¢æ™‚ç³»åˆ—', desc: 'éå»ã‹ã‚‰ç¾åœ¨ã¾ã§ã®åœ°å›³ã‚’æ™‚ç³»åˆ—ã§æ¯”è¼ƒ', category: 'terrain', icon: 'â³', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&ls=gsi-compare-photo&lcd=gsi-compare-photo&vs=c0j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'gsi_flood', name: 'æ²»æ°´åœ°å½¢åˆ†é¡å›³', desc: 'æ²³å·å‘¨è¾ºã®åœ°å½¢ç‰¹æ€§ã¨æ´ªæ°´ãƒªã‚¹ã‚¯ã‚’æŠŠæ¡', category: 'terrain', icon: 'ğŸ–¼ï¸', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=lcmfc2%2C0.8%7Chillshademap&blend=01&disp=111&lcd=hillshademap&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'google_maps', name: 'Googleãƒãƒƒãƒ—', desc: 'ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚„çµŒè·¯æ¤œç´¢ã‚‚å¯èƒ½', category: 'terrain', icon: 'ğŸ“', noCoords: false, url: (lat, lon) => `https://maps.google.co.jp/maps?q=${lat},${lon}` }, { id: 'google_earth', name: 'Google Earth', desc: '3Dåœ°å½¢ã¨è¡›æ˜Ÿç”»åƒã§åœ°è¡¨ã‚’è©³ç´°ã«ç¢ºèª', category: 'terrain', icon: 'ğŸŒ', noCoords: false, url: (lat, lon, zoom) => `https://earth.google.com/web/@${lat},${lon},0a,${Math.round(300000*Math.pow(0.5,(parseInt(zoom,10)-1)/3))}d,0y,0h` }, { id: 'konjaku', name: 'ä»Šæ˜”ãƒãƒƒãƒ—', desc: 'æ˜æ²»ã‹ã‚‰ç¾ä»£ã¾ã§ã®åœ°å½¢å›³ã‚’ä¸¦ã¹ã¦è¡¨ç¤º', category: 'terrain', icon: 'ğŸ“œ', noCoords: false, url: (lat, lon, zoom) => `https://ktgis.net/kjmapw/kjmapw.html?lat=${lat}&lng=${lon}&zoom=${zoom}&dataset=&age=3&screen=2&scr1tile=k_cj4&scr2tile=k_cj4&scr3tile=k_cj4&mapOpacity=10&overGSItile=no&altitudeOpacity=2` }, { id: 'gsi_photos', name: 'åœ°å›³ãƒ»ç©ºä¸­å†™çœŸé–²è¦§', desc: 'éå»ã®ç©ºä¸­å†™çœŸã‚’é–²è¦§', category: 'terrain', icon: 'ğŸ“·', noCoords: false, url: (lat, lon, zoom) => `https://service.gsi.go.jp/map-photos/app/map?search=photo#${zoom}/${lat}/${lon}` }, { id: 'geonavi', name: 'åœ°è³ªå›³Navi', desc: 'æ—¥æœ¬å…¨å›½ã®åœ°è³ªæƒ…å ±ã‚’è©³ç´°ã«è¡¨ç¤º', category: 'geology', icon: 'â›ï¸', noCoords: false, url: (lat, lon, zoom) => `https://gbank.gsj.jp/geonavi/geonavi.php#${zoom},${lat},${lon}` }, { id: 'gsi_landslide', name: 'åœ°ã™ã¹ã‚Šåœ°å½¢åˆ†å¸ƒå›³', desc: 'å›½åœŸåœ°ç†é™¢ãŒæä¾›ã™ã‚‹åœ°ã™ã¹ã‚Šåœ°å½¢ã®åˆ†å¸ƒå›³', category: 'geology', icon: 'â›°ï¸', noCoords: false, url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=std%7Clandslide%2C0.75&blend=0&disp=11&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` }, { id: 'kunijiban', name: 'å›½åœŸåœ°ç›¤æƒ…å ± KuniJiban', desc: 'ãƒœãƒ¼ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãªã©åœ°ç›¤æƒ…å ±ã‚’æ¤œç´¢', category: 'geology', icon: 'ğŸ“Š', noCoords: true, url: () => `https://www.kunijiban.pwri.go.jp/viewer/` }, { id: 'ngic', name: 'å›½åœŸåœ°ç›¤æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼', desc: 'å…¨å›½ã®åœ°ç›¤æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', category: 'geology', icon: 'ğŸ“ˆ', noCoords: true, url: () => `https://publicweb.ngic.or.jp/viewer/` }, { id: 'geo_station', name: 'ã‚¸ã‚ªãƒ»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', desc: 'åœ°è³ªãƒ»åœ°ç›¤æƒ…å ±ã®çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„', category: 'geology', icon: 'ğŸ§­', noCoords: true, url: () => `https://www.geo-stn.bosai.go.jp/mapping_page.html` }, { id: 'gsj_activefault', name: 'æ´»æ–­å±¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', desc: 'ç”£æ¥­æŠ€è¡“ç·åˆç ”ç©¶æ‰€ãŒæä¾›ã™ã‚‹æ´»æ–­å±¤ã®æƒ…å ±ã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„', category: 'geology', icon: 'ã€°ï¸', noCoords: true, url: () => `https://gbank.gsj.jp/activefault/cgi/tyousati` }, { id: 'tokyo_jiban', name: 'æ±äº¬ã®åœ°ç›¤ï¼ˆGISï¼‰', desc: 'æ±äº¬éƒ½å†…ã®è©³ç´°ãªåœ°ç›¤ãƒ‡ãƒ¼ã‚¿ã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„', category: 'geology', icon: 'ğŸ¢', noCoords: true, url: () => `https://doboku.metro.tokyo.lg.jp/start/03-jyouhou/geo-web/geo-webmap.aspx` }, { id: 'hazard_map', name: 'é‡ã­ã‚‹ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—', desc: 'æ´ªæ°´ã€åœŸç ‚ç½å®³ã€æ´¥æ³¢ãªã©ã®å±é™ºåŒºåŸŸã‚’è¡¨ç¤º', category: 'disaster', icon: 'ğŸš¨', noCoords: false, url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=tameike_raster%2C0.75%7Cflood_list_l2%2C0.75%7Cdisaster1&disp=110&vs=c1j0l0u0` }, { id: 'hazard_flood_topo', name: 'ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆæ²»æ°´åœ°å½¢åˆ†é¡å›³ï¼‰', desc: 'æ²»æ°´åœ°å½¢åˆ†é¡å›³ã¨ãƒã‚¶ãƒ¼ãƒ‰æƒ…å ±ã®é‡ã­åˆã‚ã›', category: 'disaster', icon: 'ğŸš«', noCoords: false, url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=hillshademap%7CLCMFC02&disp=11&vs=c1j0l0u0t0h0z0` }, { id: 'river_bousai', name: 'å·ã®é˜²ç½æƒ…å ±', desc: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æ²³å·æ°´ä½ã¨é›¨é‡æƒ…å ±', category: 'disaster', icon: 'ğŸ’§', noCoords: false, url: (lat, lon, zoom) => { let s=4; if(zoom>=18)s=3; if(zoom<=15)s=5; if(zoom<=13)s=6; return `https://www.river.go.jp/kawabou/pc/ov?zm=${zoom}&fld=0&clat=${lat}&clon=${lon}&mapType=0&viewGrpStg=0&viewRd=1&viewRW=1&viewRiver=1&viewPoint=1`;} }, { id: 'jma_warnings', name: 'æ°—è±¡è­¦å ±ãƒ»æ³¨æ„å ±', desc: 'æ°—è±¡åºãŒç™ºè¡¨ã™ã‚‹è­¦å ±ãƒ»æ³¨æ„å ±ã‚’åœ°å›³ã§ç¢ºèª', category: 'disaster', icon: 'ğŸ“¢', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/map.html#${zoom}/${lat}/${lon}/&elem=all&contents=warning` }, { id: 'kikikuru', name: 'ã‚­ã‚­ã‚¯ãƒ«ï¼ˆå±é™ºåº¦åˆ†å¸ƒï¼‰', desc: 'åœŸç ‚ç½å®³ãƒ»æµ¸æ°´ãƒ»æ´ªæ°´ã®å±é™ºåº¦ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º', category: 'disaster', icon: 'â›ˆï¸', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/risk/#zoom:${zoom}/lat:${lat}/lon:${lon}/colordepth:deep/elements:land` }, { id: 'jma_nowcast', name: 'é«˜è§£åƒåº¦é™æ°´ãƒŠã‚¦ã‚­ãƒ£ã‚¹ãƒˆ', desc: 'æ°—è±¡åºãŒæä¾›ã™ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®é™æ°´äºˆå ±', category: 'disaster', icon: 'ğŸŒ§ï¸', noCoords: false, url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/nowc/#lat:${lat}/lon:${lon}/zoom:${zoom}/colordepth:normal/elements:hrpns&slmcs&slmcs_fcst` }, { id: 'kijunten', name: 'åŸºæº–ç‚¹é–²è¦§ã‚µãƒ¼ãƒ“ã‚¹', desc: 'ä¸‰è§’ç‚¹ãƒ»æ°´æº–ç‚¹ãªã©ã®åŸºæº–ç‚¹æƒ…å ±', category: 'survey', icon: 'ğŸ“', noCoords: false, url: (lat, lon, zoom) => `https://service.gsi.go.jp/kijunten/app/map/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c1z0f0` }, { id: 'suimon_suisitsu', name: 'æ°´æ–‡æ°´è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', desc: 'æ²³å·ã®æ°´ä½ãƒ»æµé‡ãƒ»æ°´è³ªãƒ‡ãƒ¼ã‚¿', category: 'survey', icon: 'ğŸ”¬', noCoords: false, url: (lat, lon, zoom) => { let s=4; if(zoom>=18)s=3; if(zoom<=15)s=5; if(zoom<=13)s=6; return `http://www1.river.go.jp/cgi-bin/SelectMap.do?cntX=${lon}&cntY=${lat}&scaleCd=${s}`;} }, { id: 'topo_profile', name: 'Webåœ°å½¢æ–­é¢ãƒ¡ãƒ¼ã‚«ãƒ¼', desc: '2ç‚¹é–“ã®åœ°å½¢æ–­é¢å›³ã‚’è‡ªå‹•ä½œæˆã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„', category: 'survey', icon: 'ã€½ï¸', noCoords: true, url: () => `https://ktgis.net/service/topoprofile/` }, { id: 'web_contour', name: 'Webç­‰é«˜ç·šãƒ¡ãƒ¼ã‚«ãƒ¼', desc: 'æŒ‡å®šç¯„å›²ã®ç­‰é«˜ç·šå›³ã‚’ä½œæˆã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„', category: 'survey', icon: 'ğŸ”ï¸', noCoords: true, url: () => `https://ktgis.net/service/webcontour/index.html` }, { id: 'yahoo_map', name: 'Yahooåœ°å›³', desc: 'é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚„æ··é›‘æƒ…å ±ã‚‚è¡¨ç¤ºå¯èƒ½', category: 'other', icon: 'â˜ï¸', noCoords: false, url: (lat, lon, zoom) => `https://map.yahoo.co.jp/?lat=${lat}&lon=${lon}&zoom=${zoom}&maptype=satellite` }, { id: 'mapion', name: 'Mapionï¼ˆãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ï¼‰', desc: 'ã‚«ãƒ¼ãƒŠãƒ“ç”¨ã®ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã€‚å³ã‚¯ãƒªãƒƒã‚¯â†’åœ°å›³URLã§ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º', category: 'other', icon: 'ğŸ“', noCoords: false, url: (lat, lon, zoom) => `https://www.mapion.co.jp/m2/${lat},${lon},${zoom}` }, { id: 'itsmo_navi', name: 'ã„ã¤ã‚‚NAVI', desc: 'ã‚¼ãƒ³ãƒªãƒ³ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ ãŒæä¾›ã™ã‚‹è©³ç´°ãªåœ°å›³', category: 'other', icon: 'ğŸš—', noCoords: false, url: (lat, lon, zoom) => { const tokyoCoords = convertWgs84ToTokyo(lat, lon);return `https://www.its-mo.com/maps/?lat=${tokyoCoords.lat}&lon=${tokyoCoords.lon}&z=${zoom}`; } }, { id: 'chika_map', name: 'åœ°ä¾¡ãƒãƒƒãƒ—', desc: 'å…¬ç¤ºåœ°ä¾¡ãƒ»åŸºæº–åœ°ä¾¡ã‚’åœ°å›³ä¸Šã«è¡¨ç¤º', category: 'other', icon: 'ğŸ’µ', noCoords: false, url: (lat, lon) => `https://www.chikamap.jp/chikamap/Map?mid=220&mps=2500&mpx=${parseFloat(lon)+0.002365}&mpy=${parseFloat(lat)-0.00328}&mtl=47,37,77,27,67,57&mcl=3,30,30,30;2,20,312,312;7,70,310,310;1,10,312,312;1,10,310,310;5,50,50,50;4,40,40,40&gprj=1&flgInit=1&vpc=0` }];

const $lat = document.getElementById('latitude'), $lon = document.getElementById('longitude'), $coordsDisplay = document.getElementById('currentCoords'), $zoom = document.getElementById('zoomLevel'), $zoomDisplay = document.getElementById('zoomLevelDisplay'), $container = document.getElementById('map-categories-container'), $notification = document.getElementById('notification'), $mapPreview = document.getElementById('mapPreview'), $previewContainer = document.getElementById('previewContainer'), $historyPopup = document.getElementById('historyPopup'), $historyList = document.getElementById('historyList'), $bookmarkPopup = document.getElementById('bookmarkPopup'), $bookmarkList = document.getElementById('bookmarkList'), $currentZoom = document.getElementById('currentZoom'), $addressInput = document.getElementById('addressInput'), $autocompleteList = document.getElementById('autocompleteList'), $coordFormatToggle = document.getElementById('coord-format-toggle'), $areaDisplay = document.getElementById('area-display'), $mainMapContainer = document.getElementById('mainMapContainer');
let MAX_HISTORY = 100;
const BOOKMARK_KEY = 'coordinateBookmarks', MYLINK_KEY = 'myCustomLinks', FAVORITE_SETS_KEY = 'favoriteSets', SETTINGS_KEY = 'geoLinkNaviSettings';
let osmMap = null, osmMarker = null, autocompleteTimer = null, currentAutocompleteResults = [], selectedAutocompleteIndex = -1, isDMSFormat = false, currentLatLon = { lat: 35.68107447, lon: 139.76784396 };
let navigationHistory = [], historyIndex = -1, MAX_NAV_HISTORY = 100;
let isFirstMapLoad = true;

const defaultSettings = { theme: 'light', defaultZoom: 16, coordFormat: 'decimal', historySize: 100, defaultLayer: 'gsi_std', panelState: 'closed' };
let currentSettings = {};

function loadSettings() {
    const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
    currentSettings = { ...defaultSettings, ...savedSettings };
    applySettings();
}

function applySettings() {
    document.body.classList.toggle('dark-mode', currentSettings.theme === 'dark');
    document.getElementById('modeToggle').textContent = currentSettings.theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    isDMSFormat = (currentSettings.coordFormat === 'dms');
    updateLatLonInputs(currentLatLon.lat, currentLatLon.lon);
    MAX_HISTORY = parseInt(currentSettings.historySize, 10);
    const historyHeader = $historyPopup.querySelector('h4');
    if(historyHeader) historyHeader.textContent = `åº§æ¨™å±¥æ­´ (æœ€æ–°${MAX_HISTORY}ä»¶)`;
    if (!location.search) {
        $zoom.value = currentSettings.defaultZoom;
        $zoomDisplay.textContent = currentSettings.defaultZoom;
    }
}

function populateLayerSettings() {
    const select = document.getElementById('settings-default-layer');
    select.innerHTML = '';
    for (const key in BASE_LAYERS) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = BASE_LAYERS[key].name;
        select.appendChild(option);
    }
}

function openSettingsModal() {
    document.getElementById('settings-zoom').value = currentSettings.defaultZoom;
    document.getElementById('settings-zoom-value').textContent = currentSettings.defaultZoom;
    document.getElementById('settings-default-layer').value = currentSettings.defaultLayer;
    document.getElementById('settings-theme').value = currentSettings.theme;
    document.getElementById('settings-coord-format').value = currentSettings.coordFormat;
    document.getElementById('settings-history-size').value = currentSettings.historySize;
    document.getElementById('settings-panel-state').value = currentSettings.panelState;
    document.getElementById('settings-modal').style.display = 'flex';
}

function closeSettingsModal() {
    document.getElementById('settings-modal').style.display = 'none';
}

function saveSettings(e) {
    e.preventDefault();
    currentSettings.defaultZoom = document.getElementById('settings-zoom').value;
    currentSettings.defaultLayer = document.getElementById('settings-default-layer').value;
    currentSettings.theme = document.getElementById('settings-theme').value;
    currentSettings.coordFormat = document.getElementById('settings-coord-format').value;
    currentSettings.historySize = document.getElementById('settings-history-size').value;
    currentSettings.panelState = document.getElementById('settings-panel-state').value;

    localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
    applySettings();
    closeSettingsModal();
    showNotification('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

function showNotification(message, type = 'success') { $notification.textContent = message; $notification.className = `notification ${type}`; $notification.style.display = 'block'; setTimeout(() => $notification.style.display = 'none', 3000); }
async function updateCurrentCoords(skipHistorySave = false, fromNav = false) {
let latNum, lonNum;
try {
if (isDMSFormat) { latNum = dmsToDecimal($lat.value); lonNum = dmsToDecimal($lon.value); }
else { latNum = parseFloat($lat.value); lonNum = parseFloat($lon.value); }
if (isNaN(latNum) || isNaN(lonNum)) throw new Error("Invalid number");
} catch (e) { return; }
const zoomNum = parseInt($zoom.value, 10);
if (latNum>=-90&&latNum<=90&&lonNum>=-180&&lonNum<=180) {
currentLatLon = { lat: latNum, lon: lonNum };
$coordsDisplay.textContent = `${latNum.toFixed(8)}Â°N, ${lonNum.toFixed(8)}Â°E`;
$currentZoom.textContent = zoomNum;
updateMapPreview(latNum, lonNum, zoomNum); // [å¤‰æ›´ç‚¹] ã‚ºãƒ¼ãƒ åŒæœŸã®ãŸã‚å¼•æ•°ã‚’æ¸¡ã™
initOSMClickMap(latNum, lonNum, zoomNum);

if (!fromNav) {
    if (historyIndex < navigationHistory.length - 1) {
        navigationHistory = navigationHistory.slice(0, historyIndex + 1);
    }
    navigationHistory.push({ lat: latNum, lon: lonNum, zoom: zoomNum });
    if (navigationHistory.length > MAX_NAV_HISTORY) {
        navigationHistory.shift();
    }
    historyIndex = navigationHistory.length - 1;
}

if (!skipHistorySave) await saveCoordinateToHistory(latNum, lonNum, zoomNum);
updateNavButtons();
}
}
async function initGeolocation() { if (navigator.geolocation) { showNotification('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™...'); navigator.geolocation.getCurrentPosition(async position => { updateLatLonInputs(position.coords.latitude, position.coords.longitude); await updateCurrentCoords(); showNotification('ç¾åœ¨åœ°ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸ'); }, () => { showNotification('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error'); updateCurrentCoords(true); }, { enableHighAccuracy: true }); } else { showNotification('ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹éå¯¾å¿œã§ã™', 'error'); } }

// [å¤‰æ›´ç‚¹] updateMapPreview ãŒã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´
function updateMapPreview(lat, lon, zoom) {
    const currentZoom = zoom || parseInt($zoom.value, 10);
    if (!isNaN(lat) && !isNaN(lon)) {
        $mapPreview.src = `https://maps.google.com/maps?q=${lat},${lon}&hl=ja&z=${currentZoom}&output=embed`;
    }
}


function togglePreview(event) {
    if (event.target.classList.contains('btn-copy')) {
        event.stopPropagation();
        return;
    }
    $previewContainer.classList.toggle('collapsed');
}

function toggleMainMap() {
    const isCollapsing = !$mainMapContainer.classList.contains('collapsed');
    $mainMapContainer.classList.toggle('collapsed');
    if (!isCollapsing && osmMap) {
        setTimeout(() => { osmMap.invalidateSize(); }, 350);
    }
}

function initOSMClickMap(lat, lon, zoom) {
const latlng = [lat, lon];
if (osmMap === null) {
osmMap = L.map('osmClickMap', { fullscreenControl: { title: { 'false': 'å…¨ç”»é¢', 'true': 'é€šå¸¸è¡¨ç¤º' } } }).setView(latlng, zoom);

L.control.scale({ imperial: false }).addTo(osmMap);

setupAnalysisTools();
const baseMaps = {};
for(const key in BASE_LAYERS) {
    const config = BASE_LAYERS[key];
    config.layer = L.tileLayer(config.url, { maxZoom: config.maxZoom || 19, attribution: config.attribution });
    baseMaps[config.name] = config.layer;
}
L.control.layers(baseMaps).addTo(osmMap);

const defaultLayerKey = currentSettings.defaultLayer || 'gsi_std';
BASE_LAYERS[defaultLayerKey].layer.addTo(osmMap);
osmMap.setMaxZoom(BASE_LAYERS[defaultLayerKey].maxZoom);

osmMap.on('baselayerchange', e => {
    for (const key in BASE_LAYERS) {
        if (BASE_LAYERS[key].name === e.name) {
            const newMaxZoom = BASE_LAYERS[key].maxZoom;
            osmMap.setMaxZoom(newMaxZoom);
            if (osmMap.getZoom() > newMaxZoom) {
                osmMap.setZoom(newMaxZoom);
            }
            break;
        }
    }
});

// [å¤‰æ›´ç‚¹] ã‚ºãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
osmMap.on('zoomend', () => {
    const newZoom = osmMap.getZoom();
    if (newZoom !== parseInt($zoom.value, 10)) {
        $zoom.value = newZoom;
        $zoomDisplay.textContent = newZoom;
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒƒãƒ—ã®ã‚ºãƒ¼ãƒ ã‚‚åŒæœŸ
        updateMapPreview(currentLatLon.lat, currentLatLon.lon, newZoom);
        $currentZoom.textContent = newZoom;
    }
});
osmMap.on('click', e => {
if (isMeasuring) return handleMeasureClick(e);
if (isMeasuringArea) return handleAreaMeasureClick(e);
updateLatLonInputs(e.latlng.lat, e.latlng.lng);
updateCurrentCoords();
showNotification('ã‚¯ãƒªãƒƒã‚¯åœ°ç‚¹ã®åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ');
});
osmMap.on('dblclick', e => {
if (isMeasuring) return handleMeasureDoubleClick(e);
if (isMeasuringArea) return handleAreaMeasureDoubleClick(e);
});
osmMap.on('mousemove', e => { if (isMeasuring) handleMeasureMouseMove(e); });
osmMarker = L.marker(latlng).addTo(osmMap);

const zoomSliderOverlay = document.querySelector('.zoom-slider-overlay');
if (zoomSliderOverlay) {
    L.DomEvent.disableClickPropagation(zoomSliderOverlay);
    L.DomEvent.disableScrollPropagation(zoomSliderOverlay);
}

new L.Control.Gpx(null, {
    async: true,
    marker_options: {
        startIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-start.png',
        endIconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-icon-end.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/pin-shadow.png'
    }
}).on('loaded', function(e) {
    osmMap.fitBounds(e.target.getBounds());
    analysisLayer.addLayer(e.target);
}).addTo(osmMap);

}
osmMap.setView(latlng, zoom);
osmMarker.setLatLng(latlng);
osmMap.invalidateSize();

if (isFirstMapLoad) {
    isFirstMapLoad = false;
    applyInitialPanelState();
}
}

function applyInitialPanelState() {
    if (window.innerWidth <= 1024) return;
    
    if (currentSettings.panelState === 'open') {
        const rightPanel = document.querySelector('.right-panel');
        if (rightPanel.classList.contains('hidden')) {
            toggleRightPanel();
        }
    } else if (currentSettings.panelState === 'pinned') {
        const mainLayout = document.querySelector('.main-layout');
        if (!mainLayout.classList.contains('pinned')) {
            togglePinPanel();
        }
    }
}

async function getAddressFromCoords(lat, lon) { try { const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&lang=ja`); const d = await r.json(); return d.display_name || `${lat}, ${lon}`; } catch (e) { return `${lat}, ${lon}`; } }
async function getCoordsFromAddress(address) { try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=jp`); const d = await r.json(); return d?.[0] ? { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) } : null; } catch (e) { return null; } }
async function getAddressSuggestions(query) { if (query.length < 2) return []; try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=jp`); return await r.json(); } catch (e) { return []; } }
async function saveCoordinateToHistory(lat, lon, zoom) { let history = JSON.parse(localStorage.getItem('coordinateHistory') || '[]'); const address = await getAddressFromCoords(lat, lon); const newEntry = { lat: lat.toFixed(8), lon: lon.toFixed(8), zoom, timestamp: new Date().toISOString(), address }; if (history[0]?.lat !== newEntry.lat || history[0]?.lon !== newEntry.lon) { history.unshift(newEntry); localStorage.setItem('coordinateHistory', JSON.stringify(history.slice(0, MAX_HISTORY))); renderHistoryList(history); } }
function renderHistoryList(history) { $historyList.innerHTML = history.length === 0 ? '<p>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' : history.map((item, index) => `<div class="history-item" data-index="${index}"><strong>${index + 1}. ${item.address}</strong><span>åº§æ¨™: ${item.lat}Â°N, ${item.lon}Â°E | ${new Date(item.timestamp).toLocaleString()}</span></div>`).join(''); }
function loadCoordinateFromHistory(item) { updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon)); $zoom.value = item.zoom; updateCurrentCoords(true); toggleHistoryPopup(false); showNotification(`å±¥æ­´ã€Œ${item.address}ã€ã‚’é©ç”¨`); }
function toggleHistoryPopup(open = true) { if (open && $historyPopup.style.display !== 'block') { renderHistoryList(JSON.parse(localStorage.getItem('coordinateHistory') || '[]')); $historyPopup.style.display = 'block'; $bookmarkPopup.style.display = 'none'; } else { $historyPopup.style.display = 'none'; } }
function clearHistory() { if (confirm('å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('coordinateHistory'); renderHistoryList([]); showNotification('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); toggleHistoryPopup(false); } }
function exportHistoryToCSV() { const d = JSON.parse(localStorage.getItem('coordinateHistory')||'[]'); if(d.length>0) exportToCSV(d, 'coordinate_history'); else showNotification('å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); }
function saveCurrentAsBookmark() { const name = prompt('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯åã‚’å…¥åŠ›:', ''); if (name) { addBookmark(name, currentLatLon.lat, currentLatLon.lon, $zoom.value); showNotification(`ã€Œ${name}ã€ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ`); renderBookmarkList(); } }
function addBookmark(name, lat, lon, zoom) { let b = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]'); b.unshift({ name, lat: lat.toFixed(8), lon: lon.toFixed(8), zoom: parseInt(zoom, 10), timestamp: new Date().toISOString() }); localStorage.setItem(BOOKMARK_KEY, JSON.stringify(b)); }
function renderBookmarkList() { const b = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]'); $bookmarkList.innerHTML = b.length === 0 ? '<p>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' : b.map((item, index) => `<div class="bookmark-item" data-index="${index}"><strong>${item.name}</strong><span>${item.lat}Â°N, ${item.lon}Â°E | ${new Date(item.timestamp).toLocaleString()}</span><div class="bookmark-actions"><button class="btn-bookmark-load">é©ç”¨</button><button class="btn-bookmark-open">åœ°å›³</button><button class="btn-bookmark-delete">å‰Šé™¤</button></div></div>`).join(''); }
function handleBookmarkAction(index, action) { const b = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]'), item = b[index]; if (!item) return; if (action === 'load') { updateLatLonInputs(parseFloat(item.lat), parseFloat(item.lon)); $zoom.value = item.zoom; updateCurrentCoords(true); toggleBookmarkPopup(false); showNotification(`ã€Œ${item.name}ã€ã‚’é©ç”¨`); } else if (action === 'open') { window.open(`https://maps.google.co.jp/maps?q=${item.lat},${item.lon}&z=${item.zoom}`, '_blank'); } else if (action === 'delete') { if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { b.splice(index, 1); localStorage.setItem(BOOKMARK_KEY, JSON.stringify(b)); renderBookmarkList(); showNotification('å‰Šé™¤ã—ã¾ã—ãŸ'); } } }
function toggleBookmarkPopup(open = true) { if (open && $bookmarkPopup.style.display !== 'block') { renderBookmarkList(); $bookmarkPopup.style.display = 'block'; $historyPopup.style.display = 'none'; } else { $bookmarkPopup.style.display = 'none'; } }
function clearBookmarks() { if (confirm('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(BOOKMARK_KEY); renderBookmarkList([]); showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); toggleBookmarkPopup(false); } }
function exportBookmarksToCSV() { const d = JSON.parse(localStorage.getItem(BOOKMARK_KEY)||'[]'); if(d.length>0) exportToCSV(d, 'bookmarks_export'); else showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); }
function exportToCSV(data, filename) { const headers = Object.keys(data[0]).join(','), rows = data.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(',')), csv = `${headers}\n${rows.join('\n')}`, bom = new Uint8Array([0xef, 0xbb, 0xbf]), blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' }), url = URL.createObjectURL(blob), a = document.createElement('a'); a.href = url; a.download = `${filename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`; a.click(); URL.revokeObjectURL(url); showNotification('CSVã§æ›¸ãå‡ºã—ã¾ã—ãŸ'); }
async function exportHistoryToKML() { exportToKML(JSON.parse(localStorage.getItem('coordinateHistory') || '[]'), 'åº§æ¨™å±¥æ­´', 'coordinate_history'); }
async function exportBookmarksToKML() { exportToKML(JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]'), 'åœ°ç‚¹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯', 'bookmarks_export'); }
async function exportToKML(data, docName, filename) { if (data.length === 0) return showNotification('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error'); let placemarks = ''; for (const item of data) placemarks += `<Placemark><name>${escapeXml(item.name||item.address||'ç„¡é¡Œ')}</name><Point><coordinates>${item.lon},${item.lat},0</coordinates></Point></Placemark>\n`; const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${docName}</name>${placemarks}</Document></kml>`, blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml;charset=utf-8;' }), url = URL.createObjectURL(blob), a = document.createElement('a'); a.href = url; a.download = `${filename}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.kml`; a.click(); URL.revokeObjectURL(url); showNotification('KMLã§æ›¸ãå‡ºã—ã¾ã—ãŸ'); }
function escapeXml(unsafe) { return unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'})[c]); }

function toggleDarkMode() {
    currentSettings.theme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
    applySettings();
}

async function searchAddress() { const address = $addressInput.value.trim(); if (!address) return showNotification('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); showNotification('æ¤œç´¢ä¸­...'); const coords = await getCoordsFromAddress(address); if (coords) { updateLatLonInputs(coords.lat, coords.lon); await updateCurrentCoords(); showNotification(`ã€Œ${address}ã€ã®åº§æ¨™ã‚’è¨­å®š`); } else { showNotification('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error'); } $autocompleteList.classList.remove('show'); }
function renderAutocompleteList(suggestions) { $autocompleteList.innerHTML = ''; selectedAutocompleteIndex = -1; if (suggestions.length === 0) return $autocompleteList.classList.remove('show'); currentAutocompleteResults = suggestions; suggestions.forEach((item, index) => { const li = document.createElement('div'); li.className = 'autocomplete-item'; li.innerHTML = `<strong>${item.display_name}</strong><span>${parseFloat(item.lat).toFixed(6)}, ${parseFloat(item.lon).toFixed(6)}</span>`; li.onclick = () => selectAutocompleteItem(index); $autocompleteList.appendChild(li); }); $autocompleteList.classList.add('show'); }
async function selectAutocompleteItem(index) { const selected = currentAutocompleteResults[index]; if(selected) { $addressInput.value = selected.display_name; updateLatLonInputs(parseFloat(selected.lat), parseFloat(selected.lon)); await updateCurrentCoords(); $autocompleteList.classList.remove('show'); } }
function openMap(mapData, showPopup=true) { const {lat,lon}=currentLatLon, zoom=Math.min(parseInt($zoom.value,10),18); if((isNaN(lat)||isNaN(lon))&&!mapData.noCoords) return showNotification('æœ‰åŠ¹ãªåº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); const url = mapData.isCustom ? mapData.url.replace('{lat}',lat).replace('{lon}',lon).replace('{z}',zoom) : mapData.url(lat,lon,zoom); if(showPopup)showNotification(`${mapData.name}ã‚’é–‹ã„ã¦ã„ã¾ã™...`); window.open(url,'_blank'); }
function openCheckedMaps(catKey) { const chks = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox:checked`); if (chks.length === 0) return showNotification('é–‹ããŸã„åœ°å›³ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚', 'error'); showNotification(`${chks.length}ä»¶ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã¾ã™ã€‚`); const allMaps = getCombinedMapDefinitions(); chks.forEach(cb => { const mapToOpen = allMaps.find(m => m.id === cb.dataset.mapId); if (mapToOpen) openMap(mapToOpen, false); }); }
function toggleAllCheckboxes(catKey, btn) {
const chks = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox`);
const allChecked = Array.from(chks).every(cb => cb.checked);
chks.forEach(cb => cb.checked = !allChecked);
btn.classList.toggle('checked', !allChecked);
}
function openGoogleMap() { const {lat,lon}=currentLatLon; if (isNaN(lat)||isNaN(lon))return; window.open(`https://maps.google.co.jp/maps?q=${lat},${lon}&z=${$zoom.value}`,'_blank'); }
async function pasteCoordinates() { try { const text = await navigator.clipboard.readText(), match = text.match(/^\s*(-?\d+\.?\d*)\s*[,\s]+\s*(-?\d+\.?\d*)\s*$/); if (match) { updateLatLonInputs(parseFloat(match[1]), parseFloat(match[2])); await updateCurrentCoords(); showNotification('åº§æ¨™ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ'); } else showNotification('å½¢å¼ãŒä¸æ­£ã§ã™','error'); } catch (err) { showNotification('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­å–å¤±æ•—','error'); } }
function toggleUsage() { document.getElementById('usageGuide').classList.toggle('show'); }
function toggleCategory(header) { header.classList.toggle('collapsed'); header.nextElementSibling.classList.toggle('hidden'); }
function getCombinedMapDefinitions() {
    const customLinks = JSON.parse(localStorage.getItem(MYLINK_KEY) || '[]').filter(l => l);
    const customMaps = customLinks.map(link => ({ ...link, category: 'mylink' }));
    return [...MAP_DEFINITIONS, ...customMaps];
}
function renderMapCards() {
$container.innerHTML = '';
const allMaps = getCombinedMapDefinitions();
const mapsById = allMaps.reduce((acc, map, index) => {
    map.id = map.id || (map.isCustom ? `mylink-${index}` : `map-${index}`);
    acc[map.id] = map;
    return acc;
}, {});
const mapsByCategory = allMaps.reduce((acc, map) => {
const cat = map.category || 'mylink';
if (!acc[cat]) acc[cat] = { meta: CATEGORY_META[cat], maps: [] };
acc[cat].maps.push(map);
return acc;
}, {});
const categoryOrder = ['terrain', 'geology', 'disaster', 'survey', 'other', 'mylink'];
for (const catKey of categoryOrder) {
if (!mapsByCategory[catKey] && catKey !== 'mylink') continue;
const catGroup = mapsByCategory[catKey] || { meta: CATEGORY_META.mylink, maps: [] };
const categoryDiv = document.createElement('div');
categoryDiv.className = 'category';
categoryDiv.setAttribute('data-category-key', catKey);
const categoryHeader = document.createElement('div');
categoryHeader.className = 'category-header';
categoryHeader.addEventListener('click', e => !e.target.closest('button') && toggleCategory(categoryHeader));
categoryHeader.innerHTML = `<div class="category-title-group"><div class="category-icon ${catGroup.meta.class}">${catGroup.meta.icon}</div><div class="category-title">${catGroup.meta.title}</div><span class="accordion-icon">â–¼</span></div>`;

const toggleBtn = document.createElement('button');
toggleBtn.className = 'btn-toggle-all-checks';
toggleBtn.setAttribute('title', 'å…¨é¸æŠ/è§£é™¤');
toggleBtn.onclick = () => toggleAllCheckboxes(catKey, toggleBtn);
categoryHeader.appendChild(toggleBtn);

const bulkOpenBtn = document.createElement('button');
bulkOpenBtn.className = 'btn-bulk-open';
bulkOpenBtn.setAttribute('title', 'ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä¸€æ‹¬ã§é–‹ã');
bulkOpenBtn.onclick = () => openCheckedMaps(catKey);
categoryHeader.appendChild(bulkOpenBtn);
categoryDiv.appendChild(categoryHeader);
const mapGrid = document.createElement('div');
mapGrid.className = 'map-grid';
catGroup.maps.forEach(map => mapGrid.appendChild(createMapCard(map, catKey, categoryHeader)));
if (catKey === 'mylink') {
const addBtn = document.createElement('button');
addBtn.className = 'btn-add-mylink';
addBtn.textContent = 'ï¼‹ æ–°ã—ã„ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ';
addBtn.onclick = () => openMyLinkModal();
mapGrid.appendChild(addBtn);
}
categoryDiv.appendChild(mapGrid);
$container.appendChild(categoryDiv);
}
}
function createMapCard(map, catKey, categoryHeader) {
    const card = document.createElement('div');
    card.className = 'map-card';
    card.dataset.category = catKey;
    card.dataset.mapId = map.id;
    card.onclick = e => !e.target.closest('.map-checkbox, .map-card-actions') && openMap(map);
    card.innerHTML = `<div class="map-header-with-check"><div class="map-title"><span class="map-icon-in-title">${map.icon || 'ğŸ”—'}</span> ${map.name}</div><input type="checkbox" class="map-checkbox" data-map-id="${map.id}"></div><div class="map-description">${map.desc || 'ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯'}</div>${map.noCoords ? '<div class="manual-input-warning">â€»æ‰‹å‹•è¨­å®šãŒå¿…è¦ã§ã™</div>' : ''}`;

    const checkbox = card.querySelector('.map-checkbox');

    checkbox.onclick = (e) => {
        e.stopPropagation();
    };

    checkbox.onchange = () => {
        const btn = categoryHeader.querySelector('.btn-toggle-all-checks');
        if(btn) {
            const allChecked = document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox:checked`).length === document.querySelectorAll(`.map-card[data-category="${catKey}"] .map-checkbox`).length;
            btn.classList.toggle('checked', allChecked);
        }
    };

    if (map.category === 'mylink') {
        const actions = document.createElement('div');
        actions.className = 'map-card-actions';
        actions.innerHTML = `<button class="btn-mylink-edit">âœï¸ ç·¨é›†</button><button class="btn-mylink-delete">ğŸ—‘ï¸ å‰Šé™¤</button>`;
        actions.querySelector('.btn-mylink-edit').onclick = (e) => { e.stopPropagation(); openMyLinkModal(map); };
        actions.querySelector('.btn-mylink-delete').onclick = (e) => { e.stopPropagation(); deleteMyLink(map.id); };
        card.appendChild(actions);
    }
    return card;
}


function decimalToDMS(dd, isLat) { const dir = dd < 0 ? (isLat ? 'S' : 'W') : (isLat ? 'N' : 'E'); dd = Math.abs(dd); const d = Math.floor(dd), m = Math.floor((dd - d) * 60), s = (((dd - d) * 60 - m) * 60).toFixed(3); return `${d}Â°${String(m).padStart(2,'0')}'${String(s).padStart(6,'0')}" ${dir}`; }
function dmsToDecimal(dms) { dms = String(dms).trim().toUpperCase(); const parts = dms.match(/(-?\d+\.?\d*)[Â°D\s]+(\d+)[`'â€™\s]+([\d.]+)[S"â€\s]*\s*([NSEW])?/); if (!parts) throw new Error("Invalid DMS format"); let dd = Math.abs(parseFloat(parts[1])) + parseFloat(parts[2])/60 + parseFloat(parts[3])/3600; if (parseFloat(parts[1]) < 0 || parts[4] === 'S' || parts[4] === 'W') dd = -dd; return dd; }
function toggleCoordFormat() {
    currentSettings.coordFormat = isDMSFormat ? 'decimal' : 'dms';
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
    applySettings();
}
function updateLatLonInputs(lat, lon) { currentLatLon = {lat, lon}; if (isDMSFormat) { $lat.value = decimalToDMS(lat, true); $lon.value = decimalToDMS(lon, false); } else { $lat.value = lat.toFixed(8); $lon.value = lon.toFixed(8); } }

function copyToClipboard(elementId) {
    let textToCopy = '';
    let notificationMessage = '';

    if (elementId === 'latitude' || elementId === 'longitude') {
        const input = document.getElementById(elementId);
        textToCopy = input.value;
        notificationMessage = `${elementId === 'latitude' ? 'ç·¯åº¦' : 'çµŒåº¦'}ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`;
    } else if (elementId === 'currentCoords') {
        textToCopy = `${currentLatLon.lat.toFixed(8)}, ${currentLatLon.lon.toFixed(8)}`;
        notificationMessage = 'åº§æ¨™ (lat, lon) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
    }

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showNotification(notificationMessage);
        }).catch(err => {
            showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        });
    } else {
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'absolute';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showNotification(notificationMessage);
        } catch (err) {
            showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
        document.body.removeChild(textArea);
    }
}

let isMeasuring = false, isMeasuringArea = false;
let measurePoints = [], tempMeasureLine = null, tempMeasureMarker = null, measureTooltip = null;
let areaPoints = [], tempAreaPolygon = null;
let analysisLayer;

function setupAnalysisTools() {
if (!osmMap) return;
analysisLayer = L.layerGroup().addTo(osmMap);

document.getElementById('measure-tool-btn').addEventListener('click', () => toggleMeasureMode());
document.getElementById('area-tool-btn').addEventListener('click', () => toggleAreaMeasureMode());
document.getElementById('buffer-tool-btn').addEventListener('click', () => {
const r = parseFloat(document.getElementById('buffer-radius-input').value);
if(r>0) L.circle(currentLatLon, {radius:r}).addTo(analysisLayer);
});
document.getElementById('clear-analysis-btn').addEventListener('click', () => {
if(analysisLayer) analysisLayer.clearLayers();
if(isMeasuring) toggleMeasureMode(true);
if(isMeasuringArea) toggleAreaMeasureMode(true);
});

const analysisTools = document.getElementById('analysis-tools');
const analysisToolsHeader = document.getElementById('analysis-tools-header');
if (analysisTools) L.DomEvent.disableClickPropagation(analysisTools);
if (analysisToolsHeader) analysisToolsHeader.addEventListener('click', () => analysisTools.classList.toggle('collapsed'));
}

function disableOtherModes(currentMode) {
if (currentMode !== 'measure' && isMeasuring) toggleMeasureMode(true);
if (currentMode !== 'area' && isMeasuringArea) toggleAreaMeasureMode(true);
}

function toggleMeasureMode(forceOff = false) {
isMeasuring = forceOff ? false : !isMeasuring;
if (isMeasuring) disableOtherModes('measure');
document.getElementById('measure-tool-btn').classList.toggle('active', isMeasuring);
osmMap.getContainer().style.cursor = isMeasuring ? 'crosshair' : '';
if (!isMeasuring) {
if(tempMeasureLine) analysisLayer.removeLayer(tempMeasureLine);
if(tempMeasureMarker) analysisLayer.removeLayer(tempMeasureMarker);
if(measureTooltip) osmMap.removeLayer(measureTooltip);
tempMeasureLine = tempMeasureMarker = measureTooltip = null;
}
measurePoints = [];
}
function handleMeasureClick(e) {
measurePoints.push(e.latlng);
L.circleMarker(e.latlng, { radius: 5, color: 'red' }).addTo(analysisLayer);
if (measurePoints.length > 1) {
L.polyline(measurePoints.slice(0, measurePoints.length), { color: 'blue' }).addTo(analysisLayer);
updateMeasureTooltip(e.latlng);
}
if (measurePoints.length === 1) {
tempMeasureMarker = L.circleMarker(e.latlng, { radius: 5, color: 'red', opacity: 0.5 }).addTo(analysisLayer);
measureTooltip = L.tooltip({permanent: true}).setLatLng(e.latlng).setContent('ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ç‚¹ã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§çµ‚äº†').addTo(osmMap);
}
}
function handleMeasureMouseMove(e) {
if (measurePoints.length === 0) return;
const currentPoints = [...measurePoints, e.latlng];
if (tempMeasureLine) {
analysisLayer.removeLayer(tempMeasureLine);
}
tempMeasureLine = L.polyline(currentPoints, { color: 'blue', dashArray: '5, 5' }).addTo(analysisLayer);
if(tempMeasureMarker) tempMeasureMarker.setLatLng(e.latlng);
updateMeasureTooltip(e.latlng);
}
function handleMeasureDoubleClick(e) {
if (measurePoints.length < 1) {
toggleMeasureMode(true);
return;
}
measurePoints.push(e.latlng);
const finalLine = L.polyline(measurePoints, { color: 'blue' }).addTo(analysisLayer);
const totalDistance = calculateTotalDistance(measurePoints);
const distText = totalDistance > 1000 ? (totalDistance / 1000).toFixed(2) + ' km' : totalDistance.toFixed(1) + ' m';
finalLine.bindPopup(`<b>ç·è·é›¢:</b> ${distText}`).openPopup();
toggleMeasureMode(true);
}
function updateMeasureTooltip(latlng) {
if (!measureTooltip) return;
const totalDistance = calculateTotalDistance([...measurePoints, latlng]);
const distText = totalDistance > 1000 ? (totalDistance / 1000).toFixed(2) + ' km' : totalDistance.toFixed(1) + ' m';
measureTooltip.setLatLng(latlng).setContent(`ç·è·é›¢: ${distText}<br>ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§çµ‚äº†`);
}
function calculateTotalDistance(points) {
let totalDistance = 0;
for (let i = 0; i < points.length - 1; i++) {
totalDistance += points[i].distanceTo(points[i + 1]);
}
return totalDistance;
}

function toggleAreaMeasureMode(forceOff = false) {
isMeasuringArea = forceOff ? false : !isMeasuringArea;
if(isMeasuringArea) disableOtherModes('area');
document.getElementById('area-tool-btn').classList.toggle('active', isMeasuringArea);
osmMap.getContainer().style.cursor = isMeasuringArea ? 'crosshair' : '';
if (isMeasuringArea) {
areaPoints = [];
if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
tempAreaPolygon = null;
$areaDisplay.style.display = 'inline';
$areaDisplay.textContent = '--- mÂ²';
} else {
if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
tempAreaPolygon = null;
$areaDisplay.style.display = 'none';
}
}
function handleAreaMeasureClick(e) {
areaPoints.push(e.latlng);
L.circleMarker(e.latlng, { radius: 5, color: '#9C27B0' }).addTo(analysisLayer);
if (tempAreaPolygon) analysisLayer.removeLayer(tempAreaPolygon);
if (areaPoints.length > 1) {
tempAreaPolygon = L.polygon(areaPoints, { color: '#9C27B0', weight: 2, fillOpacity: 0.1 }).addTo(analysisLayer);
}
if (areaPoints.length >= 3) {
const area = calculatePolygonArea(areaPoints);
const areaText = area > 1000000 ? `${(area / 1000000).toFixed(3)} kmÂ²` : `${area.toFixed(2)} mÂ²`;
$areaDisplay.textContent = `é¢ç©: ${areaText}`;
} else {
$areaDisplay.textContent = '--- mÂ²';
}
}
function handleAreaMeasureDoubleClick() {
if (!isMeasuringArea || areaPoints.length < 3) return;
const finalPolygon = L.polygon(areaPoints, { color: '#9C27B0' }).addTo(analysisLayer);
const area = calculatePolygonArea(areaPoints);
const areaText = area > 1000000 ? `${(area / 1000000).toFixed(3)} kmÂ²` : `${area.toFixed(2)} mÂ²`;
finalPolygon.bindPopup(`<b>é¢ç©:</b> ${areaText}`).openPopup();
toggleAreaMeasureMode(true);
}
function calculatePolygonArea(latlngs) {
if (latlngs.length < 3) return 0;
const centralLon = latlngs.reduce((sum, p) => sum + p.lng, 0) / latlngs.length;
const utmZone = Math.floor((centralLon + 180) / 6) + 1;
const utmProj = `+proj=utm +zone=${utmZone} +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
try {
const projectedPoints = latlngs.map(p => proj4('EPSG:4326', utmProj, [p.lng, p.lat]));
let area = 0;
for (let i = 0, j = projectedPoints.length - 1; i < projectedPoints.length; j = i++) {
area += (projectedPoints[j][0] + projectedPoints[i][0]) * (projectedPoints[j][1] - projectedPoints[i][1]);
}
return Math.abs(area / 2);
} catch (e) {
console.error("Area calculation error:", e);
return 0;
}
}

function updateNavButtons() {
    document.getElementById('navBack').disabled = historyIndex <= 0;
    document.getElementById('navForward').disabled = historyIndex >= navigationHistory.length - 1;
}

const $mylinkModal = document.getElementById('mylink-modal'), $mylinkForm = document.getElementById('mylink-form');
function openMyLinkModal(linkToEdit = null) {
$mylinkForm.reset();
document.getElementById('modal-title').textContent = linkToEdit ? 'ãƒªãƒ³ã‚¯ã‚’ç·¨é›†' : 'æ–°ã—ã„ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ';
if(linkToEdit) {
document.getElementById('mylink-id').value = linkToEdit.id;
document.getElementById('mylink-name').value = linkToEdit.name;
document.getElementById('mylink-url').value = linkToEdit.url;
document.getElementById('mylink-desc').value = linkToEdit.desc;
}
$mylinkModal.style.display = 'flex';
}
function closeMyLinkModal() { $mylinkModal.style.display = 'none'; }
function saveMyLink(e) { e.preventDefault(); let links = JSON.parse(localStorage.getItem(MYLINK_KEY) || '[]'); const linkId = document.getElementById('mylink-id').value, newLink = { id: linkId || `mylink-${Date.now()}`, name: document.getElementById('mylink-name').value, url: document.getElementById('mylink-url').value, desc: document.getElementById('mylink-desc').value }; if (linkId) links = links.map(l => l.id === linkId ? newLink : l); else links.push(newLink); localStorage.setItem(MYLINK_KEY, JSON.stringify(links)); renderMapCards(); closeMyLinkModal(); showNotification('ãƒã‚¤ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }
function deleteMyLink(linkId) { if (confirm('ã“ã®ãƒã‚¤ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { let links = JSON.parse(localStorage.getItem(MYLINK_KEY) || '[]').filter(l => l.id !== linkId); localStorage.setItem(MYLINK_KEY, JSON.stringify(links)); renderMapCards(); showNotification('ãƒã‚¤ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); } }

// [å¤‰æ›´ç‚¹] å…±æœ‰URLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢
function getShareUrl() {
    const p = new URLSearchParams({ lat: currentLatLon.lat.toFixed(8), lon: currentLatLon.lon.toFixed(8), zoom: $zoom.value });
    const c = Array.from(document.querySelectorAll('.map-checkbox:checked')).map(cb => cb.dataset.mapId).join(',');
    if (c) p.append('checked', c);
    return `${location.origin}${location.pathname}?${p.toString()}`;
}
function generateShareUrl() {
    navigator.clipboard.writeText(getShareUrl()).then(() => showNotification('å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'), () => showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—', 'error'));
}

// [è¿½åŠ ] QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰ã¨ç”Ÿæˆ
function openQrModal() {
    const modal = document.getElementById('qr-modal');
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = ''; // æ—¢å­˜ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢

    new QRCode(qrContainer, {
        text: getShareUrl(),
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });

    modal.style.display = 'flex';
}
function closeQrModal() {
    document.getElementById('qr-modal').style.display = 'none';
}


function applyStateFromUrl() { const p = new URLSearchParams(location.search); const lat=p.get('lat'),lon=p.get('lon'),zoom=p.get('zoom'),chk=p.get('checked'); if (lat&&lon) { updateLatLonInputs(parseFloat(lat),parseFloat(lon)); if(zoom)$zoom.value=zoom; if(chk) chk.split(',').forEach(i=>{const c=document.querySelector(`.map-checkbox[data-map-id="${i}"]`);if(c)c.checked=true;}); history.replaceState(null,'',location.pathname); return true; } return false; }

function convertUrlToTemplate() {
    const exampleUrl = document.getElementById('mylink-example-url').value.trim();
    if (!exampleUrl) {
        showNotification('URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }
    const coordRegex = /(-?\d+\.\d{4,})\D+(-?\d+\.\d{4,})/;
    const match = exampleUrl.match(coordRegex);
    if (match && match.length >= 3) {
        const num1Str = match[1];
        const num2Str = match[2];
        const num1 = parseFloat(num1Str);
        const num2 = parseFloat(num2Str);
        let latStr, lonStr;
        const isNum1Lat = num1 >= -90 && num1 <= 90;
        const isNum2Lon = num2 >= -180 && num2 <= 180;
        const isNum1Lon = num1 >= -180 && num1 <= 180;
        const isNum2Lat = num2 >= -90 && num2 <= 90;
        if (isNum1Lat && isNum2Lon) {
            latStr = num1Str;
            lonStr = num2Str;
        } else if (isNum1Lon && isNum2Lat) {
            lonStr = num1Str;
            latStr = num2Str;
        } else {
            showNotification('URLã‹ã‚‰æœ‰åŠ¹ãªç·¯åº¦çµŒåº¦ã®ãƒšã‚¢ã‚’åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
            return;
        }
        let template = exampleUrl.replace(latStr, '{lat}');
        template = template.replace(lonStr, '{lon}');
        document.getElementById('mylink-url').value = template;
        showNotification('URLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
    } else {
        showNotification('URLå†…ã«ç·¯åº¦çµŒåº¦ã‚‰ã—ã„æ•°å€¤ã®ãƒšã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
    }
}

function loadFavoriteSets() {
    const sets = JSON.parse(localStorage.getItem(FAVORITE_SETS_KEY) || '{}');
    const select = document.getElementById('favorite-sets');
    select.innerHTML = '<option value="">ã‚»ãƒƒãƒˆã‚’é¸æŠ...</option>';
    for (const setName in sets) {
        const option = document.createElement('option');
        option.value = setName;
        option.textContent = setName;
        select.appendChild(option);
    }
}

function applyFavoriteSet() {
    const sets = JSON.parse(localStorage.getItem(FAVORITE_SETS_KEY) || '{}');
    const select = document.getElementById('favorite-sets');
    const selectedSet = sets[select.value];
    if (selectedSet) {
        document.querySelectorAll('.map-checkbox').forEach(cb => {
            cb.checked = selectedSet.includes(cb.dataset.mapId);
        });
        showNotification(`ã‚»ãƒƒãƒˆã€Œ${select.value}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚`);
    }
}

function openFavoriteSet() {
    const select = document.getElementById('favorite-sets');
    const setName = select.value;
    if (!setName) {
        showNotification('é–‹ããŸã„ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }

    const sets = JSON.parse(localStorage.getItem(FAVORITE_SETS_KEY) || '{}');
    const mapIdsToOpen = sets[setName];

    if (!mapIdsToOpen || mapIdsToOpen.length === 0) {
        showNotification(`ã‚»ãƒƒãƒˆã€Œ${setName}ã€ã«åœ°å›³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`, 'error');
        return;
    }

    showNotification(`ã‚»ãƒƒãƒˆã€Œ${setName}ã€ã®åœ°å›³ ${mapIdsToOpen.length} ä»¶ã‚’é–‹ãã¾ã™...`);
    const allMaps = getCombinedMapDefinitions();
    mapIdsToOpen.forEach(mapId => {
        const mapToOpen = allMaps.find(m => m.id === mapId);
        if (mapToOpen) {
            openMap(mapToOpen, false);
        }
    });
}

function saveFavoriteSet() {
    const setName = prompt('ä¿å­˜ã™ã‚‹ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!setName) return;

    const checkedIds = Array.from(document.querySelectorAll('.map-checkbox:checked')).map(cb => cb.dataset.mapId);
    if (checkedIds.length === 0) {
        showNotification('åœ°å›³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
        return;
    }

    const sets = JSON.parse(localStorage.getItem(FAVORITE_SETS_KEY) || '{}');
    sets[setName] = checkedIds;
    localStorage.setItem(FAVORITE_SETS_KEY, JSON.stringify(sets));
    loadFavoriteSets();
    document.getElementById('favorite-sets').value = setName;
    showNotification(`ã‚»ãƒƒãƒˆã€Œ${setName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
}

function deleteFavoriteSet() {
    const select = document.getElementById('favorite-sets');
    const setName = select.value;
    if (!setName) {
        showNotification('å‰Šé™¤ã™ã‚‹ã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
    }
    if (confirm(`ã‚»ãƒƒãƒˆã€Œ${setName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const sets = JSON.parse(localStorage.getItem(FAVORITE_SETS_KEY) || '{}');
        delete sets[setName];
        localStorage.setItem(FAVORITE_SETS_KEY, JSON.stringify(sets));
        loadFavoriteSets();
        showNotification(`ã‚»ãƒƒãƒˆã€Œ${setName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
    }
}

function toggleRightPanel() {
    const rightPanel = document.querySelector('.right-panel');
    const btn = document.getElementById('toggleRightPanelBtn');
    const overlay = document.getElementById('panelOverlay');

    rightPanel.classList.toggle('hidden');
    const isHidden = rightPanel.classList.contains('hidden');

    if (isHidden) {
        btn.innerHTML = 'â—€';
        btn.title = 'ãƒ‘ãƒãƒ«ã‚’é–‹ã';
        overlay.classList.remove('show');
    } else {
        btn.innerHTML = 'â–¶';
        btn.title = 'ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹';
        overlay.classList.add('show');
    }

    setTimeout(() => {
        if (window.osmMap) window.osmMap.invalidateSize();
    }, 400);
}

function togglePinPanel() {
    const mainLayout = document.querySelector('.main-layout');
    const pinBtn = document.getElementById('pinPanelBtn');
    const rightPanel = document.querySelector('.right-panel');
    const toggleBtn = document.getElementById('toggleRightPanelBtn');

    const isPinned = mainLayout.classList.toggle('pinned');
    pinBtn.classList.toggle('pinned', isPinned);
    
    if (toggleBtn) {
        toggleBtn.disabled = isPinned;
    }

    if (isPinned) {
        pinBtn.innerHTML = 'ğŸ“ å›ºå®šä¸­';
        pinBtn.title = 'ãƒ‘ãƒãƒ«ã®å›ºå®šã‚’è§£é™¤';
    } else {
        pinBtn.innerHTML = 'ğŸ“Œ ãƒ”ãƒ³ç•™ã‚';
        pinBtn.title = 'ãƒ‘ãƒãƒ«ã‚’å›ºå®š';
    }

    if (isPinned) {
        rightPanel.classList.remove('hidden');
        document.getElementById('panelOverlay').classList.remove('show');
        if (toggleBtn) {
            toggleBtn.innerHTML = 'â–¶';
            toggleBtn.title = 'ãƒ‘ãƒãƒ«ã¯å›ºå®šã•ã‚Œã¦ã„ã¾ã™';
        }
    } else {
        rightPanel.classList.add('hidden');
        if (toggleBtn) {
            toggleBtn.innerHTML = 'â—€';
            toggleBtn.title = 'ãƒ‘ãƒãƒ«ã‚’é–‹ã';
        }
    }

    setTimeout(() => {
        if (window.osmMap) {
            window.osmMap.invalidateSize();
        }
    }, 450);
}


document.addEventListener('DOMContentLoaded', () => {
loadSettings();
populateLayerSettings();
renderMapCards();
loadFavoriteSets();

const today = new Date();
document.getElementById('lastUpdated').textContent = `æœ€çµ‚æ›´æ–°æ—¥: ${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

if (applyStateFromUrl()) {
    updateCurrentCoords(true, true);
} else {
    updateCurrentCoords(true, true);
    initGeolocation();
}
$lat.addEventListener('change', () => updateCurrentCoords());
$lon.addEventListener('change', () => updateCurrentCoords());
$zoom.addEventListener('input', e => $zoomDisplay.textContent = e.target.value);
// [å¤‰æ›´ç‚¹] ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œå®Œäº†æ™‚ã«ã‚‚ã‚ºãƒ¼ãƒ åŒæœŸ
$zoom.addEventListener('change', e => {
    const newZoom = parseInt(e.target.value, 10);
    if(osmMap) osmMap.setZoom(newZoom);
    updateMapPreview(currentLatLon.lat, currentLatLon.lon, newZoom);
    $currentZoom.textContent = newZoom;
});
$coordFormatToggle.addEventListener('click', toggleCoordFormat);
$addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); selectedAutocompleteIndex !== -1 ? selectAutocompleteItem(selectedAutocompleteIndex) : searchAddress(); } });
$addressInput.addEventListener('input', () => { clearTimeout(autocompleteTimer); if ($addressInput.value.trim().length<2) return renderAutocompleteList([]); autocompleteTimer = setTimeout(async () => renderAutocompleteList(await getAddressSuggestions($addressInput.value.trim())), 300); });
$addressInput.addEventListener('keydown', e => { const items = $autocompleteList.querySelectorAll('.autocomplete-item'); if(items.length===0)return; if (e.key==='ArrowDown') selectedAutocompleteIndex=(selectedAutocompleteIndex+1)%items.length; else if (e.key==='ArrowUp') selectedAutocompleteIndex=(selectedAutocompleteIndex-1+items.length)%items.length; else return; e.preventDefault(); items.forEach((item,i)=>item.classList.toggle('selected',i===selectedAutocompleteIndex)); if(items[selectedAutocompleteIndex]) items[selectedAutocompleteIndex].scrollIntoView({block:'nearest'}); });
document.addEventListener('click', e => { if (!e.target.closest('.input-wrapper')) $autocompleteList.classList.remove('show'); if (!e.target.closest('.header-button-wrapper, .usage-button')) { $historyPopup.style.display = 'none'; $bookmarkPopup.style.display = 'none'; } if(!e.target.closest('.usage-button, .usage-guide')) { document.getElementById('usageGuide').classList.remove('show'); } });
$historyList.addEventListener('click', e => { const i = e.target.closest('.history-item')?.dataset.index; if (i) loadCoordinateFromHistory(JSON.parse(localStorage.getItem('coordinateHistory'))[i]); });
$bookmarkList.addEventListener('click', e => { const i = e.target.closest('.bookmark-item')?.dataset.index, a = e.target.closest('button')?.className.split('-').pop(); if(i&&a) handleBookmarkAction(parseInt(i), a); });
$mylinkForm.addEventListener('submit', saveMyLink);
document.getElementById('btn-mylink-modal-cancel').addEventListener('click', closeMyLinkModal);
$mylinkModal.addEventListener('click', e => e.target === $mylinkModal && closeMyLinkModal());

document.getElementById('btn-convert-url').addEventListener('click', convertUrlToTemplate);
document.getElementById('modeToggle').addEventListener('click', toggleDarkMode);

const $settingsModal = document.getElementById('settings-modal');
document.getElementById('settingsButton').addEventListener('click', openSettingsModal);
document.getElementById('settings-form').addEventListener('submit', saveSettings);
document.getElementById('btn-settings-modal-cancel').addEventListener('click', closeSettingsModal);
$settingsModal.addEventListener('click', e => e.target === $settingsModal && closeSettingsModal());
document.getElementById('settings-zoom').addEventListener('input', e => {
    document.getElementById('settings-zoom-value').textContent = e.target.value;
});

document.getElementById('navBack').addEventListener('click', () => {
    if (historyIndex > 0) {
        historyIndex--;
        const state = navigationHistory[historyIndex];
        updateLatLonInputs(state.lat, state.lon);
        $zoom.value = state.zoom;
        updateCurrentCoords(true, true);
    }
});

document.getElementById('navForward').addEventListener('click', () => {
    if (historyIndex < navigationHistory.length - 1) {
        historyIndex++;
        const state = navigationHistory[historyIndex];
        updateLatLonInputs(state.lat, state.lon);
        $zoom.value = state.zoom;
        updateCurrentCoords(true, true);
    }
});

document.getElementById('expandAllCategories').addEventListener('click', () => {
    document.querySelectorAll('.category-header').forEach(header => {
        header.classList.remove('collapsed');
        header.nextElementSibling.classList.remove('hidden');
    });
});

document.getElementById('collapseAllCategories').addEventListener('click', () => {
    document.querySelectorAll('.category-header').forEach(header => {
        header.classList.add('collapsed');
        header.nextElementSibling.classList.add('hidden');
    });
});

document.getElementById('favorite-sets').addEventListener('change', applyFavoriteSet);
document.getElementById('save-set').addEventListener('click', saveFavoriteSet);
document.getElementById('delete-set').addEventListener('click', deleteFavoriteSet);
document.getElementById('clear-all-checks').addEventListener('click', () => {
    document.querySelectorAll('.map-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('favorite-sets').value = '';
    showNotification('ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
});
document.getElementById('open-set').addEventListener('click', openFavoriteSet);


window.addEventListener('resize', () => {
if (osmMap) {
osmMap.invalidateSize();
}
});
});
</script>
</body>
</html>