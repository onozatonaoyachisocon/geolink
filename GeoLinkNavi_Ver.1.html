<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geoé€£æºãƒŠãƒ“</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet.fullscreen plugin -->
<link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>

<style>
    :root {
        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¤‰æ•° */
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --bg-light: #f8f9fa;
        --bg-page: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        --bg-container: white;
        --text-dark: #333;
        --text-medium: #666;
        --border-color: #e0e0e0;
        --card-bg: white;
        --shadow-base: 0 20px 60px rgba(0,0,0,0.3);
        --shadow-hover: 0 8px 24px rgba(0,0,0,0.12); /* æ–°ã—ã„ã‚·ãƒ£ãƒ‰ã‚¦å¤‰æ•° */

        /* å…±é€š */
        --radius-base: 12px;
        --red-alert: #E64A19;
        --btn-bulk: #1976D2; 
        --btn-bulk-hover: #1565C0;
        --success-color: #1a621c; 
        --error-color: #E64A19; 
        --bookmark-color: #FFC107; /* ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç”¨ */

        /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼å¤‰æ•° */
        --btn-current-location-bg: #A1C9FA; /* â† å¤‰æ›´(æ·¡ã„é’è‰²) */
        --btn-current-location-hover-bg: #2563EB;
        --btn-googlemap-bg: #98D7B1;      /* â† å¤‰æ›´(æ·¡ã„ç·‘è‰²) */
        --btn-googlemap-hover-bg: #2d8e47;
        --btn-paste-bg: #B1B9F5;          /* â† å¤‰æ›´(æ·¡ã„ç´«è‰²) */
        --btn-paste-hover-bg: #5568d3;
        --btn-save-bookmark-bg: #FFE082;      /* â† å¤‰æ›´(æ·¡ã„é»„è‰²) */
        --btn-save-bookmark-hover-bg: #e6b000;
        --btn-address-search-bg: #607D8B;
        --btn-address-search-hover-bg: #455A64;

        /* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®å¤‰æ•° */
        --autocomplete-bg: var(--card-bg);
        --autocomplete-border: var(--border-color);
        --autocomplete-item-hover-bg: var(--bg-light);

        /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚·ãƒ£ãƒ‰ã‚¦ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰) */
        --shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.3);   /* #4CAF50 */
        --shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.3);  /* #FF5722 */
        --shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.3);  /* #FF9800 */
        --shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.3);  /* #2196F3 */
        --shadow-other: 0 8px 24px rgba(156, 39, 176, 0.3);   /* #9C27B0 */
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¤‰æ•° */
    body.dark-mode {
        --primary-color: #4f46e5;
        --secondary-color: #a855f7;
        --bg-light: #1f2937; /* Darker secondary background */
        --bg-page: #111827; /* Dark blue background */
        --bg-container: #1f2937; /* Main container background */
        --text-dark: #f3f4f6; /* Light text */
        --text-medium: #d1d5db; /* Lighter text */
        --border-color: #374151;
        --card-bg: #374151;
        --shadow-base: 0 10px 30px rgba(0,0,0,0.6);
        --shadow-hover: 0 8px 24px rgba(255,255,255,0.1); /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚·ãƒ£ãƒ‰ã‚¦ */

        /* ãƒœã‚¿ãƒ³ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        --btn-current-location-bg: #3B82F6;
        --btn-current-location-hover-bg: #2563EB;
        --btn-googlemap-bg: #34A853;
        --btn-googlemap-hover-bg: #2d8e47;
        --btn-paste-bg: var(--primary-color);
        --btn-paste-hover-bg: #5568d3;
        --btn-save-bookmark-bg: var(--bookmark-color);
        --btn-save-bookmark-hover-bg: #e6b000;
        --btn-address-search-bg: #607D8B;
        --btn-address-search-hover-bg: #455A64;

        /* ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        --autocomplete-bg: var(--card-bg);
        --autocomplete-border: var(--border-color);
        --autocomplete-item-hover-bg: #2d3748; /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å°‘ã—æ˜ã‚‹ã„ãƒ›ãƒãƒ¼è‰² */

        /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚·ãƒ£ãƒ‰ã‚¦ã‚«ãƒ©ãƒ¼å¤‰æ•° (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰) */
        --shadow-terrain: 0 8px 24px rgba(76, 175, 80, 0.4);   /* #4CAF50 (æ¿ƒãã™ã‚‹) */
        --shadow-disaster: 0 8px 24px rgba(255, 87, 34, 0.4);  /* #FF5722 (æ¿ƒãã™ã‚‹) */
        --shadow-geology: 0 8px 24px rgba(255, 152, 0, 0.4);  /* #FF9800 (æ¿ƒãã™ã‚‹) */
        --shadow-survey: 0 8px 24px rgba(33, 150, 243, 0.4);  /* #2196F3 (æ¿ƒãã™ã‚‹) */
        --shadow-other: 0 8px 24px rgba(156, 39, 176, 0.4);   /* #9C27B0 (æ¿ƒãã™ã‚‹) */
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
        background: var(--bg-page);
        padding: 20px;
        min-height: 100vh;
        color: var(--text-dark);
        transition: background 0.5s, color 0.5s;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--bg-container);
        border-radius: 20px;
        box-shadow: var(--shadow-base);
        overflow: hidden;
        transition: background 0.5s, box-shadow 0.5s;
    }
    
    .header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 10px 20px;
        position: relative;
    }
    
    .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .header p {
        opacity: 0.9;
        font-size: 14px;
    }

    .header-buttons {
        position: absolute;
        top: 25px;
        right: 20px;
        display: flex;
        gap: 10px;
    }

    .mode-toggle, .history-button, .bookmark-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }
    
    .mode-toggle:hover, .history-button:hover, .bookmark-button:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.05);
    }

    .history-popup, .bookmark-popup {
        position: absolute;
        top: 70px;
        background: var(--bg-container);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-base);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        width: 320px;
        max-height: 450px;
        padding: 10px;
        z-index: 1050; /* ãƒãƒƒãƒ—ã‚„ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚ˆã‚Šã‚‚é«˜ãè¨­å®š */
        display: none;
        color: var(--text-dark);
    }

    .history-popup { right: 15px; z-index: 1050; }
    .bookmark-popup { right: 70px; z-index: 1050; }
    
    .history-popup h4, .bookmark-popup h4 {
        margin-bottom: 10px;
        padding: 5px;
        border-bottom: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-size: 14px;
    }
    
    .popup-buttons {
        display: flex; 
        gap: 5px; 
        margin: 0 5px 10px; 
        flex-wrap: wrap; 
    }
    .popup-buttons button {
        flex: 1; 
        min-width: 100px;
        padding: 8px 10px;
        font-size: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        border: none;
        color: white; 
    }
    
    .btn-clear-history, .btn-clear-bookmarks { background-color: var(--error-color); }
    .btn-clear-history:hover, .btn-clear-bookmarks:hover { background-color: #C62828; }
    
    .btn-export-csv { background-color: var(--primary-color); }
    .btn-export-csv:hover { background-color: #5568d3; }

    #historyList, #bookmarkList {
        max-height: 360px; 
        overflow-y: auto;
    }

    .history-item, .bookmark-item {
        padding: 8px 10px;
        margin-bottom: 5px;
        border-radius: 8mm;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
        border: 1px solid transparent;
    }
    .history-item:hover, .bookmark-item:hover {
        background-color: var(--bg-light);
        border-color: var(--primary-color);
    }
    
    .bookmark-actions {
        margin-top: 5px;
        display: flex;
        gap: 5px;
    }

    .bookmark-actions button {
        flex: 1;
        padding: 6px 8px;
        font-size: 11px;
        font-weight: 700;
        border-radius: 6mm;
        border: none;
        transition: opacity 0.2s;
        color: white;
    }

    .btn-bookmark-load { background-color: var(--primary-color); }
    .btn-bookmark-open { background-color: var(--success-color); }
    .btn-bookmark-delete { background-color: var(--error-color); }
    
    .btn-bookmark-load:hover, .btn-bookmark-open:hover, .btn-bookmark-delete:hover { opacity: 0.8; }


    .history-item strong, .bookmark-item strong {
        display: block;
        font-weight: 600;
        color: var(--text-dark); 
    }
    
    .history-item span, .bookmark-item span {
        color: var(--text-medium);
        font-size: 12px;
        display: block; 
        margin-top: 3px;
    }
    
    /* ä½¿ã„æ–¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .usage-toggle { margin-top: 15px; }
    .toggle-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 8mm;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .toggle-btn:hover { background: rgba(255, 255, 255, 0.3); }
    .toggle-icon { transition: transform 0.3s; transform: rotate(0deg); }
    .toggle-icon.open { transform: rotate(90deg); }
    .usage-guide {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        padding: 15px 20px;
        margin-top: 10px;
        font-size: 13px;
        display: none;
        animation: slideDown 0.3s ease;
        color: white;
    }
    .usage-guide.show { display: block; }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .popup-warning {
        color: #FFF3CD;
        background-color: var(--red-alert);
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
        font-weight: 700;
    }
    .usage-guide ul {
        list-style: disc inside;
        padding-left: 20px;
        margin-top: 10px;
    }
    .usage-guide li {
        margin-bottom: 5px;
        line-height: 1.5;
    }
    
    .input-section {
        background: var(--bg-light);
        padding: 10px 20px;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.5s, border-color 0.5s;
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .filter-row {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .filter-row label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 14px;
    }

    .category-filter-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .category-filter-checkboxes label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--card-bg);
        transition: all 0.2s;
        color: var(--text-dark);
        font-weight: bold;
        font-size: 14px;
    }
    .category-filter-checkboxes label:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    .category-filter-checkboxes input[type="checkbox"] {
        margin-right: 8px;
        width: 16px;
        height: 16px;
        accent-color: var(--primary-color);
    }
    
    .input-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .input-group { 
        flex: 1; 
        min-width: 180px;
        position: relative;
    }
    .input-row > .input-group:nth-child(5),
    .input-row > .input-group:nth-child(6) {
        flex: 1; 
    }
    .input-row > .input-group:nth-child(7) {
        flex: 2;
        min-width: 250px;
    }

    .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 14px; transition: color 0.5s; }
    .input-group input, .input-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s;
        background-color: var(--card-bg); 
        color: var(--text-dark); 
        height: 48px;
    }
    
    .input-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-base {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        color: white;
        min-width: 120px;
        height: 48px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-icon {
        min-width: 0;
        width: 48px;
        padding: 0;
        font-size: 26px;
    }

    .btn-current-location { background: var(--btn-current-location-bg); } 
    .btn-current-location:hover { background: var(--btn-current-location-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }

    .btn-paste { background: var(--btn-paste-bg); }
    .btn-paste:hover { background: var(--btn-paste-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    
    .btn-googlemap { background: var(--btn-googlemap-bg); }
    .btn-googlemap:hover { background: var(--btn-googlemap-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4); }

    .btn-save-bookmark { background: var(--btn-save-bookmark-bg); color: var(--text-dark); }
    .btn-save-bookmark:hover { background: var(--btn-save-bookmark-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4); }

    .btn-address-search { background: var(--btn-address-search-bg); }
    .btn-address-search:hover { background: var(--btn-address-search-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(96, 125, 139, 0.4); }
    .btn-address-search {
        font-size: 18px;
    }
    
    .settings-row {
        margin-top: 5px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    /* ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« */
    /* åœ°å›³ã®å³ä¸‹ã«é…ç½®ã™ã‚‹ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
    .zoom-slider-overlay {
        position: absolute;
        bottom: 10px; /* åœ°å›³ã®ä¸‹ç«¯ã‹ã‚‰ã®è·é›¢ */
        right: 10px; /* åœ°å›³ã®å³ç«¯ã‹ã‚‰ã®è·é›¢ */
        background: rgba(255, 255, 255, 0.8); /* åŠé€æ˜ã®èƒŒæ™¯ */
        border-radius: 10px;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 1000; /* ãƒãƒƒãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚ˆã‚Šä¸Š */
        color: var(--text-dark);
        transition: background 0.5s, color 0.5s, box-shadow 0.5s;
    }

    body.dark-mode .zoom-slider-overlay {
        background: rgba(31, 41, 55, 0.8);
        box-shadow: 0 2px 8px rgba(0,0,0,0.6);
        color: var(--text-dark);
    }

    .zoom-slider-overlay label {
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
    }
    .zoom-slider-overlay input[type="range"] {
        width: 120px; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å¹…ã‚’èª¿æ•´ */
        height: 8px; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®é«˜ã• */
        -webkit-appearance: none;
        appearance: none;
        background: var(--border-color);
        border-radius: 4px;
        outline: none;
        transition: background 0.2s;
        padding: 0;
        margin: 0;
        cursor: pointer;
    }
    .zoom-slider-overlay input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        border: 2px solid var(--bg-container);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .zoom-slider-overlay input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        border: 2px solid var(--bg-container);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .zoom-slider-overlay input[type="range"]:hover::-webkit-slider-thumb,
    .zoom-slider-overlay input[type="range"]:active::-webkit-slider-thumb {
        background: var(--secondary-color);
        transform: scale(1.1);
    }
    .zoom-slider-overlay input[type="range"]:hover::-moz-range-thumb,
    .zoom-slider-overlay input[type="range"]:active::-moz-range-thumb {
        background: var(--secondary-color);
        transform: scale(1.1);
    }
    .zoom-slider-overlay #zoomLevelDisplay {
        font-weight: 700;
        color: var(--primary-color); /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰² */
        width: 25px; /* è¡¨ç¤ºé ˜åŸŸã®å¹…ã‚’å›ºå®š */
        text-align: center;
        font-size: 14px;
    }
    body.dark-mode .zoom-slider-overlay #zoomLevelDisplay {
        color: var(--text-dark); /* â˜… ã“ã“ã‚’è¿½åŠ /å¤‰æ›´ã—ã¾ã—ãŸ â˜… */
    }


    /* åº§æ¨™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ */
    .map-preview-container { margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border-color); transition: border-color 0.5s; }
    .preview-header { display: flex; align-items: center; font-size: 16px; color: var(--text-dark); margin-bottom: 10px; cursor: pointer; transition: color 0.5s; }
    .preview-header h3 { font-size: 16px; margin: 0; padding-right: 10px; }
    .preview-accordion-icon { font-size: 14px; transition: transform 0.3s; }
    .map-preview-wrapper { max-height: 400px; overflow: hidden; transition: max-height 0.3s ease-in-out; }
    .map-preview-container.collapsed .map-preview-wrapper { max-height: 0; }
    .map-preview-container.collapsed .preview-accordion-icon { transform: rotate(-90deg); }
    #mapPreview { width: 100%; height: 400px; border: 3px solid var(--secondary-color); border-radius: var(--radius-base); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

    /* OSMãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #osmClickMap {
        position: relative; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã«å¿…è¦ */
        width: 100%; 
        height: 500px;
        border: 3px solid var(--secondary-color); 
        border-radius: var(--radius-base);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—åˆ‡æ›¿ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .osm-map-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    .content { padding: 10px; transition: background 0.5s; }
    .category { margin-bottom: 25px; }
    
    /* ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ */
    .category-header { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 15px; 
        padding: 10px 0; 
        border-bottom: 3px solid var(--border-color); 
        cursor: pointer; 
        transition: border-bottom-color 0.3s; 
        flex-wrap: wrap; 
        gap: 10px; 
    }
    .category-header:hover { border-bottom-color: var(--primary-color); }
    .category-title-group { display: flex; align-items: center; flex-grow: 1; }
    .category-title { font-size: 20px; font-weight: 700; color: var(--text-dark); display: flex; align-items: center; gap: 10px; transition: color 0.5s; }
    .category-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; color: white; flex-shrink: 0; }
    .accordion-icon { font-size: 20px; font-weight: 900; margin-left: 15px; transition: transform 0.3s; }
    .category-header.collapsed .accordion-icon { transform: rotate(-90deg); }
    .btn-bulk-open { 
        background: var(--btn-bulk); 
        color: white; 
        border: none; 
        padding: 8px 15px; 
        border-radius: 8px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s; 
        font-size: 13px; 
        white-space: nowrap; 
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-bulk-open:hover { background: var(--btn-bulk-hover); box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3); }

    /* å…¨é¸æŠ/å…¨è§£é™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-toggle-all-checks {
        background: #00897B; /* ä¾‹: Teal */
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 13px;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .btn-toggle-all-checks:hover {
        background: #00695C; /* ä¾‹: Darker Teal */
        box-shadow: 0 4px 8px rgba(0, 137, 123, 0.3);
    }

    .map-grid.hidden { display: none; }

    /* ã‚¢ã‚¤ã‚³ãƒ³ã®èƒŒæ™¯è‰² (ç¶­æŒ) */
    .terrain-icon { background: linear-gradient(135deg, #4CAF50, #45a049); }
    .disaster-icon { background: linear-gradient(135deg, #FF5722, #E64A19); }
    .geology-icon { background: linear-gradient(135deg, #FF9800, #F57C00); }
    .survey-icon { background: linear-gradient(135deg, #2196F3, #1976D2); }
    .other-icon { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }


    .map-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
        transition: all 0.3s ease-out;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .map-card { 
        background: var(--card-bg); 
        border: 2px solid var(--border-color); 
        border-radius: var(--radius-base); 
        padding: 20px; 
        transition: all 0.3s; 
        position: relative; 
        color: inherit; 
        display: flex; 
        flex-direction: column; 
        cursor: pointer; 
    }
    .map-card:hover { 
        transform: translateY(-4px); 
        border-color: transparent; 
    }
    /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ›ãƒãƒ¼ã‚·ãƒ£ãƒ‰ã‚¦ */
    .map-card[data-category="terrain"]:hover { box-shadow: var(--shadow-terrain); }
    .map-card[data-category="disaster"]:hover { box-shadow: var(--shadow-disaster); }
    .map-card[data-category="geology"]:hover { box-shadow: var(--shadow-geology); }
    .map-card[data-category="survey"]:hover { box-shadow: var(--shadow-survey); } 
    .map-card[data-category="other"]:hover { box-shadow: var(--shadow-other); }

    .map-card[data-category="terrain"] { border-left: 4px solid #4CAF50; }
    .map-card[data-category="disaster"] { border-left: 4px solid #FF5722; }
    .map-card[data-category="geology"] { border-left: 4px solid #FF9800; }
    .map-card[data-category="survey"] { border-left: 4px solid #2196F3; } 
    .map-card[data-category="other"] { border-left: 4px solid #9C27B0; }
    .map-header-with-check { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-right: 5px; }
    .map-title { font-weight: 600; font-size: 16px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; margin-bottom: 0; transition: color 0.5s; }
    .map-checkbox { width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; margin-left: 10px; z-index: 10; }
    .map-description { font-size: 13px; color: var(--text-medium); line-height: 1.5; flex-grow: 1; transition: color 0.5s; }
    .manual-input-warning { color: var(--red-alert); font-size: 11px; margin-top: 5px; font-weight: 600; }
    
    .status-bar { background: var(--bg-light); padding: 15px 40px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-medium); transition: background 0.5s, border-color 0.5s, color 0.5s; gap: 15px; }
    .status-bar strong { color: var(--text-dark); transition: color 0.5s; }


    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color); 
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
        animation: slideIn 0.3s ease;
        z-index: 1000;
        font-weight: 600;
    }
    
    .notification.error { background: var(--error-color); }

    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    #autocompleteList {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--autocomplete-bg);
        border: 1px solid var(--autocomplete-border);
        border-radius: var(--radius-base);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1001;
        list-style: none;
        padding: 5px 0;
        margin-top: 5px;
        display: none;
    }

    #autocompleteList.show {
        display: block;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-dark);
        transition: background-color 0.2s;
    }

    .autocomplete-item:hover, .autocomplete-item.selected {
        background-color: var(--autocomplete-item-hover-bg);
    }

    .autocomplete-item span {
        display: block;
        font-size: 12px;
        color: var(--text-medium);
        margin-top: 2px;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (ä¸€éƒ¨çœç•¥ãƒ»èª¿æ•´) */
    @media (max-width: 768px) {
        .input-section, .content, .header, .status-bar { padding: 20px; }
        .input-row { flex-direction: column; gap: 10px; }
        .input-group { min-width: 100%; }
        .btn-base { width: 100%; min-width: auto; }
        .settings-row { flex-direction: column; align-items: flex-start; gap: 10px; }
        .status-bar { flex-direction: column; align-items: flex-start; gap: 5px; }
        .category-header { flex-wrap: wrap; gap: 10px; }
        .btn-bulk-open, .btn-toggle-all-checks { width: 100%; order: 1; }
        .category-title-group { order: 0; width: 100%; }
        
        .header-buttons { right: 10px; top: 15px; gap: 5px; }
        .mode-toggle, .history-button, .bookmark-button { width: 35px; height: 35px; font-size: 16px; }
        
        .history-popup, .bookmark-popup {
            width: 90%;
            right: 5%;
            top: 60px;
        }
        .filter-row { flex-direction: column; align-items: flex-start; }
        .category-filter-checkboxes { width: 100%; }

        #autocompleteList {
            width: calc(100% - 40px);
            left: 20px;
            right: 20px;
            z-index: 1001;
        }

        /* ã‚ºãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
        .zoom-slider-overlay {
            bottom: 5px;
            right: 5px;
            padding: 6px 10px;
            gap: 5px;
        }
        .zoom-slider-overlay label {
            font-size: 12px;
        }
        .zoom-slider-overlay input[type="range"] {
            width: 80px;
            height: 6px;
        }
        .zoom-slider-overlay input[type="range"]::-webkit-slider-thumb,
        .zoom-slider-overlay input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
        }
        .zoom-slider-overlay #zoomLevelDisplay {
            width: 20px;
            font-size: 13px;
        }
    }
</style>
</head>
<body class="light-mode">
<div class="notification" id="notification">ãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ã„ã¾ã™...</div>

<div class="container">
    <div class="header">
        <h1>ğŸ—ºï¸ Geoé€£æºãƒŠãƒ“ / Geo Link Navi</h1>
        
        <div class="header-buttons">
            <button class="bookmark-button" id="bookmarkButton" onclick="toggleBookmarkPopup()" aria-label="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º">â­</button>
            <button class="history-button" id="historyButton" onclick="toggleHistoryPopup()" aria-label="å±¥æ­´" title="å±¥æ­´ã‚’è¡¨ç¤º">â±ï¸</button>
            <button class="mode-toggle" id="modeToggle" onclick="toggleDarkMode()" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ" title="ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>
        </div>
        
        <div class="history-popup" id="historyPopup">
            <h4>åº§æ¨™å±¥æ­´ (æœ€æ–°100ä»¶)</h4>
            <div class="popup-buttons">
                <button class="btn-clear-history" onclick="clearHistory()">ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
                <button class="btn-export-csv" onclick="exportHistoryToCSV()">ğŸ’¾ CSVã§æ›¸ãå‡ºã™</button>
            </div>
            <div id="historyList"></div>
        </div>

        <div class="bookmark-popup" id="bookmarkPopup">
            <h4>â­ åœ°ç‚¹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h4>
            <div class="popup-buttons">
                <button class="btn-clear-bookmarks" onclick="clearBookmarks()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                <button class="btn-export-csv" onclick="exportBookmarksToCSV()">ğŸ’¾ CSVã§æ›¸ãå‡ºã™</button>
            </div>
            <div id="bookmarkList"></div>
        </div>

        <div class="usage-toggle">
            <button class="toggle-btn" onclick="toggleUsage()">
                ğŸ’¡ ä½¿ã„æ–¹ã‚’è¦‹ã‚‹
                <span class="toggle-icon" id="toggleIcon">â–¶</span>
            </button>
            <div class="usage-guide" id="usageGuide">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å…¥åŠ›ã—ãŸç·¯åº¦ãƒ»çµŒåº¦ã‚’ã‚‚ã¨ã«ã€å„ç¨®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åœ°å›³ã‚„å›³é¢ã‚µã‚¤ãƒˆãªã©ã®æƒ…å ±ãƒšãƒ¼ã‚¸ã¸ã€ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ã§ã™ã€‚</p>
                <p class="popup-warning">âš ï¸ **æ³¨æ„:** è¤‡æ•°ã®åœ°å›³ã‚’ä¸€æ‹¬ã§é–‹ãã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ï¼‰ã—ã¦ãã ã•ã„ã€‚</p>
                <ul>
                    <li>ã€ŒğŸ“ç¾åœ¨åœ°ã€ãƒœã‚¿ãƒ³:ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã®ä½ç½®æƒ…å ±æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€ç¾åœ¨åœ°ã®åº§æ¨™ã‚’è‡ªå‹•ã§å…¥åŠ›ã—ã¾ã™ã€‚ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</li>
                    <li>ã€ŒğŸŒGoogleãƒãƒƒãƒ—ã§æ¢ã™ã€ãƒœã‚¿ãƒ³ï¼šãƒãƒƒãƒ—ã‚’é–‹ã„ã¦èª¿ã¹ãŸã„å ´æ‰€ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ åº§æ¨™ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</li>
                    <li>ã€ŒğŸ“„ è²¼ã‚Šä»˜ã‘ã€ãƒœã‚¿ãƒ³ï¼šã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç·¯åº¦ãƒ»çµŒåº¦ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚</li>
                    <li>ã€Œâ­ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ï¼šãŠæ°—ã«å…¥ã‚Šã®å ´æ‰€ã«åå‰ã‚’ã¤ã‘ã¦ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜ã§ãã¾ã™ã€‚</li>
                    <li>ã€ŒğŸ”ä½æ‰€æ¤œç´¢ã€ãƒœã‚¿ãƒ³:ä½æ‰€ã‚„ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãªã©ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã™ã‚‹ã¨ã€ãã“ã®ç·¯åº¦ãƒ»çµŒåº¦ã‚’åœ°å›³ã«åæ˜ ã§ãã¾ã™ã€‚**å…¥åŠ›ä¸­ã«å€™è£œãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚**</li>
                    <li>ğŸ—ºï¸ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å–å¾— åœ°å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã®åº§æ¨™ã‚’ç·¯åº¦çµŒåº¦ã«åæ˜ ã—ã¾ã™ã€‚åº§æ¨™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®Googleãƒãƒƒãƒ—ã®åŸ‹ã‚è¾¼ã¿åœ°å›³ã‚‚æ›´æ–°ã•ã‚Œã¾ã™ã€‚</li>
                    <li>å„ç¨®åœ°å›³ã‚«ãƒ¼ãƒ‰:ç”»é¢ä¸‹éƒ¨ã®ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã€åˆ©ç”¨ã—ãŸã„åœ°å›³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…¥åŠ›åº§æ¨™ã‚’ä¸­å¿ƒã¨ã—ãŸåœ°å›³ãŒæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚</li>
                    <li>ä¸€æ‹¬é¸æŠãƒ»ã‚ªãƒ¼ãƒ—ãƒ³:å„ã‚«ãƒ†ã‚´ãƒªã®ã€Œâ–¶ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä¸€æ‹¬ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å°ã‚’ä»˜ã‘ãŸè¤‡æ•°ã®åœ°å›³ã‚’ä¸€åº¦ã«é–‹ãã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    <li>å…¨é¸æŠ/å…¨è§£é™¤ãƒœã‚¿ãƒ³:å„ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ã‚‹ã€Œâœ… å…¨é¸æŠ/è§£é™¤ã€ãƒœã‚¿ãƒ³ã§ã€ãã®ã‚«ãƒ†ã‚´ãƒªå†…ã®ã™ã¹ã¦ã®åœ°å›³ã‚«ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li>
                    <li>ã€Œâ±ï¸åº§æ¨™å±¥æ­´ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯:åº§æ¨™å±¥æ­´ã€ã¯ã‚¯ãƒªãƒƒã‚¯ä½ç½®ãŒè‡ªå‹•ã§ä¿å­˜ã•ã‚Œã€ã€Œâ­ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€ã¯ä»»æ„ã®åœ°ç‚¹ã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã§ãã¾ã™ã€‚</li>
                </ul>
                </div>
        </div>
    </div>
    
    <div class="input-section">
        <div class="input-row">
            <button class="btn-base btn-icon btn-current-location" onclick="initGeolocation()" title="ç¾åœ¨åœ°ã‚’å–å¾—" aria-label="ç¾åœ¨åœ°ã‚’å–å¾—">ğŸ“</button>
            <button class="btn-base btn-icon btn-googlemap" onclick="openGoogleMap()" title="Googleãƒãƒƒãƒ—ã§æ¢ã™" aria-label="Googleãƒãƒƒãƒ—ã§æ¢ã™">ğŸŒ</button>
            <button class="btn-base btn-icon btn-paste" onclick="pasteCoordinates()" title="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘" aria-label="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘">ğŸ“„</button>
            <button class="btn-base btn-icon btn-save-bookmark" onclick="saveCurrentAsBookmark()" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜" aria-label="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«ä¿å­˜">â­</button>
            
            <div class="input-group">
                <label for="latitude">ğŸ“ ç·¯åº¦ (Latitude)</label>
                <input type="text" id="latitude" placeholder="ä¾‹: 35.681074471219006" value="35.681074471219006">
            </div>
            <div class="input-group">
                <label for="longitude">ğŸ“ çµŒåº¦ (Longitude)</label>
                <input type="text" id="longitude" placeholder="ä¾‹: 139.7678439654698" value="139.7678439654698">
            </div>
            <div class="input-group" style="position: relative;">
                <label for="addressInput">ğŸ  ä½æ‰€ã‚„åç§°ãªã©ã‹ã‚‰æ¤œç´¢</label>
                <input type="text" id="addressInput" placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1ã€æ±äº¬ã‚¿ãƒ¯ãƒ¼">
                <div id="autocompleteList" class="autocomplete-list"></div>
            </div>
            <button class="btn-base btn-address-search" onclick="searchAddress()" title="ä½æ‰€ã‚’æ¤œç´¢" aria-label="ä½æ‰€ã‚’æ¤œç´¢">ğŸ” æ¤œç´¢</button>
        </div>
        
        <!-- ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¯åœ°å›³å†…ã«ç§»å‹•ã™ã‚‹ãŸã‚ã€ã“ã“ã‹ã‚‰å‰Šé™¤ -->

        <div style="margin-top: 5px; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <div class="osm-map-header">
                <h3 style="font-size: 16px; margin: 0; color: var(--text-dark);">ğŸ—ºï¸ ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™å–å¾— / åœ°å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            </div>
            <div id="osmClickMap">
                <!-- ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’åœ°å›³å†…ã«é…ç½® -->
                <div class="zoom-slider-overlay">
                    <label for="zoomLevel">ã‚ºãƒ¼ãƒ :</label>
                    <input type="range" id="zoomLevel" value="16" min="1" max="20">
                    <span id="zoomLevelDisplay">16</span>
                </div>
            </div>
            <p style="margin-top: 10px; font-size: 0.85em; color: var(--text-medium);">åœ°å›³ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ç·¯åº¦çµŒåº¦ãŒå…¥åŠ›æ¬„ã«åæ˜  â†’ ä¸‹ã®Googleãƒãƒƒãƒ—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚è‡ªå‹•æ›´æ–°</p>
        </div>
        
        <div class="map-preview-container collapsed" id="previewContainer">
            <div class="preview-header" onclick="togglePreview()">
                <h3>ğŸ—ºï¸ ç¾åœ¨ã®åº§æ¨™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Google): <strong id="currentCoords">...</strong> (Zoom: <strong id="currentZoom">...</strong>)</h3>
                <span class="preview-accordion-icon">â–¼</span>
            </div>
            <div class="map-preview-wrapper">
                <iframe id="mapPreview" width="100%" height="400" frameborder="0" allowfullscreen="" aria-hidden="false" tabindex="0" src="about:blank"></iframe>
            </div>
        </div>

        <div class="filter-row" style="margin-top: 5px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <label>ğŸ” åœ°å›³ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿:</label>
            <div class="category-filter-checkboxes" id="categoryFilterCheckboxes">
            </div>
        </div>

    </div>
    
    <div class="content" id="map-categories-container">
    </div>
    
    <div class="status-bar">
        <span id="lastUpdated">æœ€çµ‚æ›´æ–°æ—¥: 2025å¹´10æœˆ21æ—¥</span>
    </div>
</div>

<script>
    // =========================================================
    // 1. åœ°å›³ãƒ‡ãƒ¼ã‚¿å®šç¾© (ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿å¤‰æ›´)
    // =========================================================
    const CATEGORY_META = {
        'all': { title: 'ã™ã¹ã¦ã®åœ°å›³', icon: 'ğŸŒ', class: '' }, 
        'terrain': { title: 'åœ°å›³ãƒ»åœ°ç†æƒ…å ±', icon: 'ğŸ—»', class: 'terrain-icon' },
        'geology': { title: 'åœ°è³ªãƒ»åœ°ç›¤æƒ…å ±', icon: 'ğŸ”ï¸', class: 'geology-icon' },
        'disaster': { title: 'é˜²ç½ãƒ»ãƒã‚¶ãƒ¼ãƒ‰æƒ…å ±', icon: 'âš ï¸', class: 'disaster-icon' },
        'survey': { title: 'æ¸¬é‡ãƒ»è§£æãƒ„ãƒ¼ãƒ«', icon: 'ğŸ“', class: 'survey-icon' },
        'other': { title: 'ãã®ä»–ã®æƒ…å ±', icon: 'ğŸ’¡', class: 'other-icon' }
    };

    const BASE_LAYERS = {
        'osm': {
            name: 'OpenStreetMap',
            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            attribution: 'Â© OpenStreetMap contributors',
            layer: null
        },
        'gsi_std': {
            name: 'åœ°ç†é™¢åœ°å›³ï¼ˆæ¨™æº–ï¼‰',
            url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
            attribution: 'Â© å›½åœŸåœ°ç†é™¢',
            layer: null
        },
        'gsi_pale': {
            name: 'åœ°ç†é™¢åœ°å›³ï¼ˆæ·¡è‰²ï¼‰',
            url: 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
            attribution: 'Â© å›½åœŸåœ°ç†é™¢',
            layer: null
        }
    };

    const MAP_DEFINITIONS = [
        { name: 'åœ°ç†é™¢åœ°å›³', desc: 'å›½åœŸåœ°ç†é™¢ã®åŸºæœ¬åœ°å›³ã€‚æ¨™é«˜ã€åœ°å½¢ã€åœŸåœ°åˆ©ç”¨ãªã©', category: 'terrain', icon: 'ğŸ—ºï¸', noCoords: false,
          url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c0g1j0h0k0l0u0t0z0r0s0m0f1&d=m` },
        { name: 'åœ°ç†é™¢æ™‚ç³»åˆ—', desc: 'éå»ã‹ã‚‰ç¾åœ¨ã¾ã§ã®åœ°å›³ã‚’æ™‚ç³»åˆ—ã§æ¯”è¼ƒ', category: 'terrain', icon: 'â³', noCoords: false,
          url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&ls=gsi-compare-photo&lcd=gsi-compare-photo&vs=c0j0h0k0l0u0t0z0r0s0m0f1&d=m` },
        { name: 'æ²»æ°´åœ°å½¢åˆ†é¡å›³', desc: 'æ²³å·å‘¨è¾ºã®åœ°å½¢ç‰¹æ€§ã¨æ´ªæ°´ãƒªã‚¹ã‚¯ã‚’æŠŠæ¡', category: 'terrain', icon: 'ğŸ–¼ï¸', noCoords: false,
          url: (lat, lon, zoom) => `https://maps.gsi.go.jp/#${zoom}/${lat}/${lon}/&base=std&ls=lcmfc2%2C0.8%7Chillshademap&blend=01&disp=111&lcd=hillshademap&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m` },
        { name: 'Googleãƒãƒƒãƒ—', desc: 'ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã‚„çµŒè·¯æ¤œç´¢ã‚‚å¯èƒ½', category: 'terrain', icon: 'ğŸ“', noCoords: false,
          url: (lat, lon) => `https://maps.google.co.jp/maps?q=${lat},${lon}` }, 
        { name: 'Google Earth', desc: '3Dåœ°å½¢ã¨è¡›æ˜Ÿç”»åƒã§åœ°è¡¨ã‚’è©³ç´°ã«ç¢ºèª', category: 'terrain', icon: 'ğŸŒ', noCoords: false,
          url: (lat, lon, zoom) => {
            const zoomNum = parseInt(zoom, 10);
            const baseAlt = 300000;
            const alt = Math.round(baseAlt * Math.pow(0.5, (zoomNum - 1) / 3)); 
            return `https://earth.google.com/web/@${lat},${lon},0a,${alt}d,0y,0h`;
          }
        },
        { name: 'ä»Šæ˜”ãƒãƒƒãƒ—', desc: 'æ˜æ²»ã‹ã‚‰ç¾ä»£ã¾ã§ã®åœ°å½¢å›³ã‚’ä¸¦ã¹ã¦è¡¨ç¤º', category: 'terrain', icon: 'ğŸ“œ', noCoords: false,
          url: (lat, lon, zoom) => `https://ktgis.net/kjmapw/kjmapw.html?lat=${lat}&lng=${lon}&zoom=${zoom}&dataset=&age=3&screen=2&scr1tile=k_cj4&scr2tile=k_cj4&scr3tile=k_cj4&mapOpacity=10&overGSItile=no&altitudeOpacity=2` },
        { name: 'åœ°å›³ãƒ»ç©ºä¸­å†™çœŸé–²è¦§', desc: 'éå»ã®ç©ºä¸­å†™çœŸã‚’é–²è¦§', category: 'terrain', icon: 'ğŸ“·', noCoords: false,
          url: (lat, lon, zoom) => `https://service.gsi.go.jp/map-photos/app/map?search=photo#${zoom}/${lat}/${lon}` },
        
        { name: 'åœ°è³ªå›³Navi', desc: 'æ—¥æœ¬å…¨å›½ã®åœ°è³ªæƒ…å ±ã‚’è©³ç´°ã«è¡¨ç¤º', category: 'geology', icon: 'â›ï¸', noCoords: false,
          url: (lat, lon, zoom) => `https://gbank.gsj.jp/geonavi/geonavi.php#${zoom},${lat},${lon}` },
        { name: 'å›½åœŸåœ°ç›¤æƒ…å ± KuniJiban', desc: 'ãƒœãƒ¼ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãªã©åœ°ç›¤æƒ…å ±ã‚’æ¤œç´¢', category: 'geology', icon: 'ğŸ“Š', noCoords: true,
          url: () => `https://www.kunijiban.pwri.go.jp/viewer/` },
        { name: 'å›½åœŸåœ°ç›¤æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼', desc: 'å…¨å›½ã®åœ°ç›¤æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', category: 'geology', icon: 'ğŸ“ˆ', noCoords: true,
          url: () => `https://publicweb.ngic.or.jp/viewer/` },
        { name: 'ã‚¸ã‚ªãƒ»ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', desc: 'åœ°è³ªãƒ»åœ°ç›¤æƒ…å ±ã®çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„', category: 'geology', icon: 'ğŸ§­', noCoords: true,
          url: () => `https://www.geo-stn.bosai.go.jp/mapping_page.html` },
        { name: 'æ±äº¬ã®åœ°ç›¤ï¼ˆGISï¼‰', desc: 'æ±äº¬éƒ½å†…ã®è©³ç´°ãªåœ°ç›¤ãƒ‡ãƒ¼ã‚¿ã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„', category: 'geology', icon: 'ğŸ¢', noCoords: true,
          url: () => `https://doboku.metro.tokyo.lg.jp/start/03-jyouhou/geo-web/geo-webmap.aspx` },

        { name: 'é‡ã­ã‚‹ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—', desc: 'æ´ªæ°´ã€åœŸç ‚ç½å®³ã€æ´¥æ³¢ãªã©ã®å±é™ºåŒºåŸŸã‚’è¡¨ç¤º', category: 'disaster', icon: 'ğŸš¨', noCoords: false,
          url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=tameike_raster%2C0.75%7Cflood_list_l2%2C0.75%7Cdisaster1&disp=110&vs=c1j0l0u0` },
        { name: 'ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆæ²»æ°´åœ°å½¢åˆ†é¡å›³ï¼‰', desc: 'æ²»æ°´åœ°å½¢åˆ†é¡å›³ã¨ãƒã‚¶ãƒ¼ãƒ‰æƒ…å ±ã®é‡ã­åˆã‚ã›', category: 'disaster', icon: 'ğŸš«', noCoords: false,
          url: (lat, lon, zoom) => `https://disaportal.gsi.go.jp/maps/?ll=${lat},${lon}&z=${zoom}&base=pale&ls=hillshademap%7CLCMFC02&disp=11&vs=c1j0l0u0t0h0z0` },
        { name: 'å·ã®é˜²ç½æƒ…å ±', desc: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®æ²³å·æ°´ä½ã¨é›¨é‡æƒ…å ±', category: 'disaster', icon: 'ğŸ’§', noCoords: false,
          url: (lat, lon, zoom) => {
            let scaleCd = 4;
            if (zoom >= 18) scaleCd = 3; 
            if (zoom <= 15) scaleCd = 5; 
            if (zoom <= 13) scaleCd = 6;
            return `https://www.river.go.jp/kawabou/pc/ov?zm=${zoom}&fld=0&clat=${lat}&clon=${lon}&mapType=0&viewGrpStg=0&viewRd=1&viewRW=1&viewRiver=1&viewPoint=1`;
          }
        },
        { name: 'ã‚­ã‚­ã‚¯ãƒ«ï¼ˆå±é™ºåº¦åˆ†å¸ƒï¼‰', desc: 'åœŸç ‚ç½å®³ãƒ»æµ¸æ°´ãƒ»æ´ªæ°´ã®å±é™ºåº¦ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º', category: 'disaster', icon: 'â›ˆï¸', noCoords: false,
          url: (lat, lon, zoom) => `https://www.jma.go.jp/bosai/risk/#zoom:${zoom}/lat:${lat}/lon:${lon}/colordepth:deep/elements:land` },

        { name: 'åŸºæº–ç‚¹é–²è¦§ã‚µãƒ¼ãƒ“ã‚¹', desc: 'ä¸‰è§’ç‚¹ãƒ»æ°´æº–ç‚¹ãªã©ã®åŸºæº–ç‚¹æƒ…å ±', category: 'survey', icon: 'ğŸ“', noCoords: false,
          url: (lat, lon, zoom) => `https://service.gsi.go.jp/kijunten/app/map/#${zoom}/${lat}/${lon}/&base=std&ls=std&disp=1&vs=c1z0f0` },
        { name: 'æ°´æ–‡æ°´è³ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', desc: 'æ²³å·ã®æ°´ä½ãƒ»æµé‡ãƒ»æ°´è³ªãƒ‡ãƒ¼ã‚¿', category: 'survey', icon: 'ğŸ”¬', noCoords: false,
          url: (lat, lon, zoom) => {
            let scaleCd = 4;
            if (zoom >= 18) scaleCd = 3; 
            if (zoom <= 15) scaleCd = 5; 
            if (zoom <= 13) scaleCd = 6; 
            return `http://www1.river.go.jp/cgi-bin/SelectMap.do?cntX=${lon}&cntY=${lat}&scaleCd=${scaleCd}&systemVer=1697436971854`;
          }
        },
        { name: 'Webåœ°å½¢æ–­é¢ãƒ¡ãƒ¼ã‚«ãƒ¼', desc: '2ç‚¹é–“ã®åœ°å½¢æ–­é¢å›³ã‚’è‡ªå‹•ä½œæˆã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„', category: 'survey', icon: 'ã€½ï¸', noCoords: true,
          url: () => `https://ktgis.net/service/topoprofile/` },
        { name: 'Webç­‰é«˜ç·šãƒ¡ãƒ¼ã‚«ãƒ¼', desc: 'æŒ‡å®šç¯„å›²ã®ç­‰é«˜ç·šå›³ã‚’ä½œæˆã€‚é–‹ã„ãŸå¾Œã«ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„', category: 'survey', icon: 'ğŸ”ï¸', noCoords: true,
          url: () => `https://ktgis.net/service/webcontour/index.html` },

        { name: 'Yahooåœ°å›³', desc: 'é›¨é›²ãƒ¬ãƒ¼ãƒ€ãƒ¼ã‚„æ··é›‘æƒ…å ±ã‚‚è¡¨ç¤ºå¯èƒ½', category: 'other', icon: 'â˜ï¸', noCoords: false,
          url: (lat, lon, zoom) => `https://map.yahoo.co.jp/?lat=${lat}&lon=${lon}&zoom=${zoom}&maptype=satellite` },
        { name: 'Mapionï¼ˆãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ï¼‰', desc: 'ã‚«ãƒ¼ãƒŠãƒ“ç”¨ã®ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã€‚å³ã‚¯ãƒªãƒƒã‚¯â†’åœ°å›³URLã§ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º', category: 'other', icon: 'ğŸ“', noCoords: false,
          url: (lat, lon, zoom) => `https://www.mapion.co.jp/m2/${lat},${lon},${zoom}` },
        { name: 'åœ°ä¾¡ãƒãƒƒãƒ—', desc: 'å…¬ç¤ºåœ°ä¾¡ãƒ»åŸºæº–åœ°ä¾¡ã‚’åœ°å›³ä¸Šã«è¡¨ç¤º', category: 'other', icon: 'ğŸ’µ', noCoords: false,
          url: (lat, lon) => {
              const adjLat = parseFloat(lat) - 0.003280000;
              const adjLon = parseFloat(lon) + 0.002365000;
              return `https://www.chikamap.jp/chikamap/Map?mid=220&mps=2500&mpx=${adjLon}&mpy=${adjLat}&mtl=47,37,77,27,67,57&mcl=3,30,30,30;2,20,312,312;7,70,310,310;1,10,312,312;1,10,310,310;5,50,50,50;4,40,40,40&gprj=1&flgInit=1&vpc=0`;
          }
        },
    ];

    // =========================================================
    // 2. DOMè¦ç´ ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // =========================================================
    const $lat = document.getElementById('latitude');
    const $lon = document.getElementById('longitude');
    const $coordsDisplay = document.getElementById('currentCoords');
    const $zoom = document.getElementById('zoomLevel');
    const $zoomDisplay = document.getElementById('zoomLevelDisplay');
    const $container = document.getElementById('map-categories-container');
    const $notification = document.getElementById('notification');
    const $mapPreview = document.getElementById('mapPreview'); 
    const $previewContainer = document.getElementById('previewContainer'); 
    const $historyPopup = document.getElementById('historyPopup');
    const $historyList = document.getElementById('historyList');
    const $bookmarkPopup = document.getElementById('bookmarkPopup'); 
    const $bookmarkList = document.getElementById('bookmarkList'); 
    const $currentZoom = document.getElementById('currentZoom'); 
    const $addressInput = document.getElementById('addressInput');
    const $categoryFilterCheckboxes = document.getElementById('categoryFilterCheckboxes');
    const $autocompleteList = document.getElementById('autocompleteList');
    const $historyButton = document.getElementById('historyButton'); // æ–°ã—ãè¿½åŠ 
    const $bookmarkButton = document.getElementById('bookmarkButton'); // æ–°ã—ãè¿½åŠ 

    const MAX_HISTORY = 100; 
    const BOOKMARK_KEY = 'coordinateBookmarks'; 
    
    let osmMap = null; 
    let osmMarker = null;
    let currentBaseLayer = null; 
    let autocompleteTimer = null;
    let currentAutocompleteResults = [];
    let selectedAutocompleteIndex = -1;

    /**
     * é€šçŸ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
     */
    function showNotification(message, type = 'success') {
        $notification.textContent = message;
        $notification.classList.remove('error');
        if (type === 'error') {
            $notification.classList.add('error');
        }
        $notification.style.display = 'block';
        
        setTimeout(() => {
            $notification.style.display = 'none';
        }, 3000);
    }

    /**
     * ç·¯åº¦çµŒåº¦è¡¨ç¤ºã‚’æ›´æ–°ã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã€å±¥æ­´ã«ä¿å­˜
     */
    async function updateCurrentCoords(skipHistorySave = false) {
        const lat = $lat.value;
        const lon = $lon.value;
        const zoom = $zoom.value;
        
        const latNum = parseFloat(lat);
        const lonNum = parseFloat(lon);
        const zoomNum = parseInt(zoom, 10);
        
        if (!isNaN(latNum) && !isNaN(lonNum) && latNum >= -90 && latNum <= 90 && lonNum >= -180 && lonNum <= 180) {
            
            $coordsDisplay.textContent = 
                `${latNum.toFixed(8)}Â°N, ${lonNum.toFixed(8)}Â°E`;
            $currentZoom.textContent = zoomNum;
            $zoomDisplay.textContent = zoomNum;

            updateMapPreview(latNum, lonNum); 
            
            initOSMClickMap(latNum, lonNum, zoomNum);

            if (!skipHistorySave) {
                await saveCoordinateToHistory(latNum, lonNum, zoomNum);
            }
        } else {
            $coordsDisplay.textContent = 'åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        }
    }
    
    /**
     * Geolocation APIã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨åœ°ã‚’è‡ªå‹•å–å¾—ã™ã‚‹
     */
    async function initGeolocation() {
        if (navigator.geolocation) {
            showNotification('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™...', 'success');
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude.toFixed(8);
                    const lon = position.coords.longitude.toFixed(8);
                    
                    $lat.value = lat;
                    $lon.value = lon;
                    await updateCurrentCoords();
                    
                    showNotification('ç¾åœ¨åœ°ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸ', 'success');
                },
                (error) => {
                    console.warn(`Geolocation Error(${error.code}): ${error.message}`);
                    let errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ã‚’æ‹’å¦ã¾ãŸã¯å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                    if (error.code === 1) { 
                         errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
                    }
                    showNotification(errorMessage, 'error');
                    updateCurrentCoords(true);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            showNotification('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
        }
    }

    /**
     * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åœ°å›³ï¼ˆGoogle Maps Embed APIï¼‰ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateMapPreview(lat, lon) {
        const zoom = $zoom.value; 
        if (isNaN(lat) || isNaN(lon)) return;
        const previewUrl = `https://maps.google.com/maps?q=${lat},${lon}&hl=ja&z=${zoom}&output=embed`; 
        $mapPreview.src = previewUrl;
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½
    function togglePreview() {
        $previewContainer.classList.toggle('collapsed');
    }

    /**
     * OpenStreetMap (Leaflet) ã®åˆæœŸåŒ–ã¨æ›´æ–°
     */
    function initOSMClickMap(lat, lon, zoom) {
        const latlng = [lat, lon];
        const zoomNum = parseInt(zoom, 10);
        
        if (osmMap === null) {
            osmMap = L.map('osmClickMap', {
                fullscreenControl: {
                    title: {
                        'false': 'å…¨ç”»é¢ã§è¡¨ç¤º',
                        'true': 'é€šå¸¸è¡¨ç¤ºã«æˆ»ã‚‹'
                    }
                }
            }).setView(latlng, zoomNum);

            osmMap.on('enterfullscreen', function () {
                osmMap.one('click', function () {
                    osmMap.toggleFullscreen();
                });
            });

            const baseMaps = {};
            for(const key in BASE_LAYERS) {
                const config = BASE_LAYERS[key];
                config.layer = L.tileLayer(config.url, {
                    maxZoom: 19,
                    attribution: config.attribution
                });
                baseMaps[config.name] = config.layer;
            }

            L.control.layers(baseMaps).addTo(osmMap);

            const initialLayerKey = localStorage.getItem('osmBaseMap') || 'osm';
            BASE_LAYERS[initialLayerKey].layer.addTo(osmMap);

            osmMap.on('baselayerchange', function (e) {
                for (const key in BASE_LAYERS) {
                    if (BASE_LAYERS[key].name === e.name) {
                        localStorage.setItem('osmBaseMap', key);
                        break;
                    }
                }
            });

            osmMap.on('moveend', function() {
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è‡ªå‹•æ›´æ–°ã¯è¡Œã‚ãªã„
            });

            osmMap.on('zoomend', function() { 
                const newZoom = osmMap.getZoom();
                const currentZoom = parseInt($zoom.value, 10);
                
                if (newZoom !== currentZoom) {
                    $zoom.value = newZoom;
                    $zoomDisplay.textContent = newZoom;
                }
            });

            osmMap.on('click', function(e) {
                const newLat = e.latlng.lat.toFixed(8);
                const newLon = e.latlng.lng.toFixed(8);
                const newZoom = osmMap.getZoom();
                
                $lat.value = newLat;
                $lon.value = newLon;
                $zoom.value = newZoom; 
                $zoomDisplay.textContent = newZoom;
                
                updateCurrentCoords();
                
                showNotification('åœ°å›³ä¸Šã®ã‚¯ãƒªãƒƒã‚¯åœ°ç‚¹ã®åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ');
            });

            osmMarker = L.marker(latlng).addTo(osmMap)
                .bindPopup(`ç¾åœ¨ã®åº§æ¨™: ${lat}Â°N, ${lon}Â°E`).openPopup();

        } else {
            osmMap.setView(latlng, zoomNum);
            if (osmMarker) {
                osmMarker.setLatLng(latlng);
                osmMarker.setPopupContent(`ç¾åœ¨ã®åº§æ¨™: ${lat}Â°N, ${lon}Â°E`).openPopup();
            }
        }
    }
    
    /**
     * Nominatim API (OpenStreetMap)ã‚’ä½¿ã£ã¦åº§æ¨™ã‹ã‚‰ä½æ‰€ã‚’å–å¾—ã™ã‚‹
     */
    async function getAddressFromCoords(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&lang=ja`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.display_name) {
                const fullAddress = data.display_name;
                const parts = fullAddress.split(',').map(p => p.trim());
                const filteredParts = parts.filter(part => {
                    return !part.includes('æ—¥æœ¬') && part !== 'Japan' && !/^\d{3}-\d{4}$/.test(part);
                });
                const majorParts = filteredParts.slice(-3);
                const resultAddress = majorParts.reverse().join('').trim();
                
                return resultAddress || fullAddress.split(',').slice(0, 3).join(', ').trim() || `${lat}, ${lon}`;
            }
            return `${lat}, ${lon}`; 
        } catch (error) {
            console.error('Reverse Geocoding failed:', error);
            return `${lat}, ${lon}`; 
        }
    }

    /**
     * ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã™ã‚‹ (Geocoding) - å˜ä¸€çµæœç”¨
     */
    async function getCoordsFromAddress(address) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1&countrycodes=jp`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                return { lat, lon };
            }
            return null; 
        } catch (error) {
            console.error('Geocoding failed:', error);
            return null;
        }
    }

    /**
     * ä½æ‰€ã‹ã‚‰æ¤œç´¢å€™è£œã‚’å–å¾—ã™ã‚‹ (ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç”¨)
     * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒª
     * @returns {Array<Object>} æ¤œç´¢çµæœã®é…åˆ—
     */
    async function getAddressSuggestions(query) {
        if (query.length < 2) return [];

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&countrycodes=jp`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.map(item => ({
                display_name: item.display_name,
                lat: parseFloat(item.lat),
                lon: parseFloat(item.lon)
            }));
        } catch (error) {
            console.error('Address suggestion failed:', error);
            return [];
        }
    }
    
    /**
     * åº§æ¨™ã‚’å±¥æ­´ã«ä¿å­˜
     */
    async function saveCoordinateToHistory(lat, lon, zoom) {
        const historyKey = 'coordinateHistory';
        let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        const address = await getAddressFromCoords(lat, lon);
        
        const newEntry = {
            lat: lat.toFixed(8),
            lon: lon.toFixed(8),
            zoom: zoom,
            timestamp: new Date().toISOString(),
            address: address 
        };

        const isDuplicate = history.length > 0 && 
                            history[0].lat === newEntry.lat && 
                            history[0].lon === newEntry.lon && 
                            history[0].zoom === newEntry.zoom;
        
        if (!isDuplicate) {
            history.unshift(newEntry);
            history = history.slice(0, MAX_HISTORY); 
            
            localStorage.setItem(historyKey, JSON.stringify(history));
            renderHistoryList(history);
        }
    }

    /**
     * å±¥æ­´ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderHistoryList(history) {
        $historyList.innerHTML = '';
        
        if (history.length === 0) {
            $historyList.innerHTML = '<p style="font-size: 13px; color: var(--text-medium); padding: 10px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        history.forEach((item, index) => { 
            const date = new Date(item.timestamp);
            const timeString = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'history-item';
            itemDiv.dataset.index = index; // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã®ãŸã‚ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
            
            const strong = document.createElement('strong');
            strong.textContent = `${index + 1}. ${item.address || `${item.lat}Â°N, ${item.lon}Â°E`}`;
            itemDiv.appendChild(strong);

            const span = document.createElement('span');
            span.textContent = `åº§æ¨™: ${item.lat}Â°N, ${item.lon}Â°E | Zoom: ${item.zoom} | ${timeString}`;
            itemDiv.appendChild(span);

            $historyList.appendChild(itemDiv);
        });
    }

    /**
     * å±¥æ­´ã‹ã‚‰åº§æ¨™ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
     */
    function loadCoordinateFromHistory(item) {
        $lat.value = item.lat;
        $lon.value = item.lon;
        $zoom.value = item.zoom;
        $zoomDisplay.textContent = item.zoom;
        
        updateCurrentCoords(true); 
        toggleHistoryPopup(false); 
        showNotification(`${item.address || 'åº§æ¨™'}ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
    }

    /**
     * å±¥æ­´ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleHistoryPopup(openIfClosed = true) {
        const isOpen = $historyPopup.style.display === 'block';
        
        if (!isOpen && openIfClosed) {
            const historyKey = 'coordinateHistory';
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            renderHistoryList(history);
            $historyPopup.style.display = 'block';
            $bookmarkPopup.style.display = 'none'; 
        } else {
            $historyPopup.style.display = 'none';
        }
    }

    /**
     * åº§æ¨™å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤
     */
    function clearHistory() {
        if (confirm('åº§æ¨™å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('coordinateHistory');
            renderHistoryList([]); 
            showNotification('åº§æ¨™å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            $historyPopup.style.display = 'none';
        }
    }
    
    /**
     * åº§æ¨™å±¥æ­´ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã™
     */
    function exportHistoryToCSV() {
        const historyKey = 'coordinateHistory';
        const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
        
        if (history.length === 0) {
            showNotification('æ›¸ãå‡ºã™å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
            return;
        }

        const headers = ['ä½æ‰€', 'ç·¯åº¦', 'çµŒåº¦', 'ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«', 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—'];
        let csv = headers.join(',') + '\n';

        const escapeCSV = (str) => {
            if (str === null || str === undefined) return '';
            str = String(str).replace(/"/g, '""'); 
            if (str.includes(',') || str.includes('\n') || str.includes('\r') || str.includes('"')) {
                return `"${str}"`; 
            }
            return str;
        };
        
        history.forEach(item => {
            const row = [
                escapeCSV(item.address || `${item.lat}, ${item.lon}`), 
                item.lat,
                item.lon,
                item.zoom,
                item.timestamp
            ];
            csv += row.join(',') + '\n';
        });

        const bom = new Uint8Array([0xef, 0xbb, 0xbf]); 
        const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        a.download = `coordinate_history_${dateStr}.csv`;
        
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
        
        showNotification('åº§æ¨™å±¥æ­´ã‚’CSVã§æ›¸ãå‡ºã—ã¾ã—ãŸ', 'success');
    }


    // =========================================================
    // 4. åœ°ç‚¹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ©Ÿèƒ½
    // =========================================================
    
    /**
     * ç¾åœ¨ã®åº§æ¨™ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¨ã—ã¦ä¿å­˜
     */
    function saveCurrentAsBookmark() {
        const lat = $lat.value;
        const lon = $lon.value;
        const zoom = $zoom.value;

        if (!lat || !lon || isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
            showNotification('æœ‰åŠ¹ãªåº§æ¨™ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }
        
        const name = prompt('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '');
        
        if (!name) {
            showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚', 'error');
            return;
        }

        addBookmark(name, lat, lon, zoom);
        showNotification(`ã€Œ${name}ã€ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ`, 'success');
        renderBookmarkList(); 
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’LocalStorageã«ä¿å­˜
     */
    function addBookmark(name, lat, lon, zoom) {
        let bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        
        const newEntry = {
            name: name,
            lat: parseFloat(lat).toFixed(8),
            lon: parseFloat(lon).toFixed(8),
            zoom: parseInt(zoom, 10),
            timestamp: new Date().toISOString()
        };

        bookmarks.unshift(newEntry);
        localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderBookmarkList() {
        $bookmarkList.innerHTML = '';
        const bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        
        if (bookmarks.length === 0) {
            $bookmarkList.innerHTML = '<p style="font-size: 13px; color: var(--text-medium); padding: 10px;">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        bookmarks.forEach((item, index) => { 
            const date = new Date(item.timestamp);
            const timeString = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bookmark-item';
            itemDiv.dataset.index = index; // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã®ãŸã‚ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
            
            const strong = document.createElement('strong');
            strong.textContent = item.name;
            itemDiv.appendChild(strong);

            const span = document.createElement('span');
            span.textContent = `åº§æ¨™: ${item.lat}Â°N, ${item.lon}Â°E | Zoom: ${item.zoom} | ${timeString}`;
            itemDiv.appendChild(span);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'bookmark-actions';
            
            const loadButton = document.createElement('button');
            loadButton.className = 'btn-bookmark-load';
            loadButton.textContent = 'é©ç”¨';
            actionsDiv.appendChild(loadButton);

            const openButton = document.createElement('button');
            openButton.className = 'btn-bookmark-open';
            openButton.textContent = 'åœ°å›³ã‚’é–‹ã';
            actionsDiv.appendChild(openButton);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn-bookmark-delete';
            deleteButton.textContent = 'å‰Šé™¤';
            actionsDiv.appendChild(deleteButton);

            itemDiv.appendChild(actionsDiv);
            $bookmarkList.appendChild(itemDiv);
        });
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰åº§æ¨™ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
     */
    function loadBookmark(index) {
        const bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        const item = bookmarks[index];
        if (!item) return;

        $lat.value = item.lat;
        $lon.value = item.lon;
        $zoom.value = item.zoom;
        $zoomDisplay.textContent = item.zoom;
        
        updateCurrentCoords(true); 
        toggleBookmarkPopup(false); 
        showNotification(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€Œ${item.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
    }
    
    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰Google Mapã‚’é–‹ã
     */
    function openBookmarkMap(index) {
        const bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        const item = bookmarks[index];
        if (!item) return;
        
        const url = `https://maps.google.co.jp/maps?q=${item.lat},${item.lon}&z=${item.zoom}`;
        window.open(url, '_blank');
        showNotification(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€Œ${item.name}ã€ã®åœ°å›³ã‚’é–‹ãã¾ã™...`);
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
     */
    function deleteBookmark(index) {
        let bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        const itemToDelete = bookmarks[index];
        if (!itemToDelete) return;

        if (confirm(`ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€Œ${itemToDelete.name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            bookmarks.splice(index, 1);
            localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
            renderBookmarkList();
            showNotification(`ã€Œ${itemToDelete.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
        }
    }
    
    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleBookmarkPopup(openIfClosed = true) {
        const isOpen = $bookmarkPopup.style.display === 'block';

        if (!isOpen && openIfClosed) {
            renderBookmarkList();
            $bookmarkPopup.style.display = 'block';
            $historyPopup.style.display = 'none'; 
        } else {
            $bookmarkPopup.style.display = 'none';
        }
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã™ã¹ã¦å‰Šé™¤
     */
    function clearBookmarks() {
        if (confirm('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem(BOOKMARK_KEY);
            renderBookmarkList();
            showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
            $bookmarkPopup.style.display = 'none';
        }
    }

    /**
     * ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã™
     */
    function exportBookmarksToCSV() {
        const bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
        
        if (bookmarks.length === 0) {
            showNotification('æ›¸ãå‡ºã™ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
            return;
        }

        const headers = ['ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å', 'ç·¯åº¦', 'çµŒåº¦', 'ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«', 'ä¿å­˜æ—¥æ™‚'];
        let csv = headers.join(',') + '\n';

        const escapeCSV = (str) => {
            if (str === null || str === undefined) return '';
            str = String(str).replace(/"/g, '""'); 
            if (str.includes(',') || str.includes('\n') || str.includes('\r') || str.includes('"')) {
                return `"${str}"`; 
            }
            return str;
        };
        
        bookmarks.forEach(item => {
            const row = [
                escapeCSV(item.name),
                item.lat,
                item.lon,
                item.zoom,
                item.timestamp
            ];
            csv += row.join(',') + '\n';
        });

        const bom = new Uint8Array([0xef, 0xbb, 0xbf]); 
        const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        a.download = `bookmarks_export_${dateStr}.csv`;
        
        document.body.appendChild(a); 
        a.click();
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
        
        showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’CSVã§æ›¸ãå‡ºã—ã¾ã—ãŸ', 'success');
    }


    // =========================================================
    // 5. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½
    // =========================================================
    
    /**
     * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleDarkMode() {
        const body = document.body;
        const toggleButton = document.getElementById('modeToggle');
        
        if (body.classList.contains('dark-mode')) {
            body.classList.remove('dark-mode');
            body.classList.add('light-mode');
            toggleButton.textContent = 'ğŸŒ™';
            localStorage.setItem('colorMode', 'light');
        } else {
            body.classList.remove('light-mode');
            body.classList.add('dark-mode');
            toggleButton.textContent = 'â˜€ï¸';
            localStorage.setItem('colorMode', 'dark');
        }
    }

    /**
     * ä¿å­˜ã•ã‚ŒãŸè¨­å®šã«åŸºã¥ã„ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
     */
    function setInitialMode() {
        const savedMode = localStorage.getItem('colorMode');
        const body = document.body;
        const toggleButton = document.getElementById('modeToggle');
        
        if (savedMode === 'dark') {
            body.classList.add('dark-mode');
            body.classList.remove('light-mode');
            toggleButton.textContent = 'â˜€ï¸';
        } else {
            body.classList.add('light-mode');
            body.classList.remove('dark-mode');
            toggleButton.textContent = 'ğŸŒ™';
        }
    }

    // =========================================================
    // 6. ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã®é–¢æ•°å®šç¾© + ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° + ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
    // =========================================================
    
    /**
     * ä½æ‰€æ¤œç´¢æ©Ÿèƒ½ (æ‰‹å‹•æ¤œç´¢ãƒœã‚¿ãƒ³ç”¨)
     */
    async function searchAddress() {
        const address = $addressInput.value.trim();
        if (!address) {
            showNotification('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        showNotification('ä½æ‰€ã‚’æ¤œç´¢ä¸­ã§ã™...', 'success');
        const coords = await getCoordsFromAddress(address);

        if (coords) {
            $lat.value = coords.lat.toFixed(8);
            $lon.value = coords.lon.toFixed(8);
            await updateCurrentCoords();
            showNotification(`ã€Œ${address}ã€ã®åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸã€‚`);
        } else {
            showNotification('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ˆã‚Šå…·ä½“çš„ãªä½æ‰€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
        }
        $autocompleteList.classList.remove('show');
    }

    /**
     * ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå€™è£œã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹
     * @param {Array<Object>} suggestions - æ¤œç´¢å€™è£œã®é…åˆ—
     */
    function renderAutocompleteList(suggestions) {
        $autocompleteList.innerHTML = '';
        selectedAutocompleteIndex = -1;

        if (suggestions.length === 0 || $addressInput.value.trim() === '') {
            $autocompleteList.classList.remove('show');
            return;
        }

        currentAutocompleteResults = suggestions;

        suggestions.forEach((item, index) => {
            const li = document.createElement('div');
            li.className = 'autocomplete-item';
            li.innerHTML = `
                <strong>${item.display_name.split(',').slice(0, 3).join(', ').trim()}</strong>
                <span>${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}</span>
            `;
            li.addEventListener('click', () => selectAutocompleteItem(index));
            $autocompleteList.appendChild(li);
        });

        $autocompleteList.classList.add('show');
    }

    /**
     * ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®é …ç›®ã‚’é¸æŠã™ã‚‹
     * @param {number} index - é¸æŠã•ã‚ŒãŸå€™è£œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    async function selectAutocompleteItem(index) {
        if (index >= 0 && index < currentAutocompleteResults.length) {
            const selected = currentAutocompleteResults[index];
            $addressInput.value = selected.display_name.split(',').slice(0, 3).join(', ').trim();
            $lat.value = selected.lat.toFixed(8);
            $lon.value = selected.lon.toFixed(8);
            await updateCurrentCoords();
            $autocompleteList.classList.remove('show');
            showNotification(`ã€Œ${$addressInput.value}ã€ã®åº§æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸã€‚`);
        }
    }

    /**
     * åœ°å›³ãƒªãƒ³ã‚¯ã‚’é–‹ã
     */
    function openMap(mapIndex, showPopupNotification = true) {
        const map = MAP_DEFINITIONS[mapIndex];
        const lat = $lat.value;
        const lon = $lon.value;
        const zoom = $zoom.value; 
        const zoomForUrl = Math.min(parseInt(zoom, 10), 18);            

        if ((!lat || !lon || isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) && !map.noCoords) {
            if (showPopupNotification) {
                showNotification('ç·¯åº¦ã¨çµŒåº¦ã‚’æœ‰åŠ¹ãªæ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            }
            return;
        }

        const url = map.url(lat, lon, zoomForUrl);
        
        if (showPopupNotification) { 
            showNotification(`${map.name} ã‚’é–‹ã„ã¦ã„ã¾ã™...`);
        }
        
        window.open(url, '_blank');
    }

    /**
     * ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªå†…ã§ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸåœ°å›³ãƒªãƒ³ã‚¯ã‚’ä¸€æ‹¬ã§é–‹ã
     */
    function openCheckedMaps(categoryKey) {
        const checkedCheckboxes = document.querySelectorAll(`.map-card[data-category="${categoryKey}"] .map-checkbox:checked`);
        
        if (checkedCheckboxes.length === 0) {
            showNotification(`${CATEGORY_META[categoryKey].title}å†…ã§ã€é–‹ããŸã„åœ°å›³ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚`, 'error');
            return;
        }

        const lat = $lat.value;
        const lon = $lon.value;
        
        if (!lat || !lon || isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
            showNotification('ç·¯åº¦ã¨çµŒåº¦ã‚’æœ‰åŠ¹ãªæ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        showNotification(`${CATEGORY_META[categoryKey].title}ã®${checkedCheckboxes.length}ä»¶ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã¾ã™ã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã”æ³¨æ„ãã ã•ã„ã€‚`);

        let openCount = 0;
        
        checkedCheckboxes.forEach(($checkbox) => {
            const mapIndex = parseInt($checkbox.dataset.mapIndex, 10);
            openMap(mapIndex, false);
            openCount++;
        });

        setTimeout(() => {
            if (openCount > 1 && !localStorage.getItem('popupWarningShown')) {
                alert('ã‚‚ã—è¤‡æ•°ã®ã‚¿ãƒ–ãŒé–‹ã‹ãªã‹ã£ãŸå ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚');
                localStorage.setItem('popupWarningShown', 'true');
            }
        }, 2500); 
    }

    /**
     * ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªå†…ã®å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹
     */
    function toggleAllCheckboxes(categoryKey) {
        const checkboxes = document.querySelectorAll(`.map-card[data-category="${categoryKey}"] .map-checkbox`);
        let allChecked = true;
        
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                allChecked = false;
            }
        });

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });

        if (!allChecked) {
            showNotification(`${CATEGORY_META[categoryKey].title}ã®é …ç›®ã‚’ã™ã¹ã¦é¸æŠã—ã¾ã—ãŸ`);
        } else {
            showNotification(`${CATEGORY_META[categoryKey].title}ã®é …ç›®ã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã—ãŸ`);
        }
    }
    
    /**
     * Googleãƒãƒƒãƒ—ã‚’é–‹ã
     */
    function openGoogleMap() {
        const lat = $lat.value;
        const lon = $lon.value;
        const zoom = $zoom.value;

        if (!lat || !lon || isNaN(parseFloat(lat)) || isNaN(parseFloat(lon))) {
            showNotification('ç·¯åº¦ã¨çµŒåº¦ã‚’æœ‰åŠ¹ãªæ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        const url = `https://maps.google.co.jp/maps?q=${lat},${lon}&z=${zoom}`;
        
        window.open(url, '_blank');
    }
    
    /**
     * ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰åº§æ¨™ã‚’è²¼ã‚Šä»˜ã‘
     */
    async function pasteCoordinates() {
        try {
            const text = await navigator.clipboard.readText();
            const regex = /^\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*$/;
            const match = text.match(regex);

            if (match) {
                const lat = match[1];
                const lon = match[2];
                
                $lat.value = lat;
                $lon.value = lon;
                await updateCurrentCoords();
                
                showNotification('åº§æ¨™ã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ');
            } else {
                showNotification('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å†…å®¹ãŒæœ‰åŠ¹ãªåº§æ¨™å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹: 35.6810, 139.7678', 'error');
            }
        } catch (err) {
            showNotification('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            console.error('Clipboard access failed:', err);
        }
    }
    
    /**
     * ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function toggleUsage() {
        const guide = document.getElementById('usageGuide');
        const icon = document.getElementById('toggleIcon');
        
        if (guide.classList.contains('show')) {
            guide.classList.remove('show');
            icon.classList.remove('open');
        } else {
            guide.classList.add('show');
            icon.classList.add('open');
        }
    }
    
    /**
     * ã‚«ãƒ†ã‚´ãƒªã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã®ãƒˆã‚°ãƒ«
     */
    function toggleCategory(headerElement) {
        headerElement.classList.toggle('collapsed');
        const mapGrid = headerElement.nextElementSibling;
        mapGrid.classList.toggle('hidden');
    }

    /**
     * åœ°å›³ã‚«ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     */
    function renderMapCards() {
        $container.innerHTML = ''; 

        const mapsByCategory = MAP_DEFINITIONS.reduce((acc, map, index) => {
            const cat = map.category;
            if (!acc[cat]) { acc[cat] = { meta: CATEGORY_META[cat], maps: [] }; }
            acc[cat].maps.push({ ...map, index });
            return acc;
        }, {});

        for (const catKey in mapsByCategory) {
            if (catKey === 'all') continue; 

            const catGroup = mapsByCategory[catKey];
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.setAttribute('data-category-key', catKey);
            
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.addEventListener('click', (e) => {
                if (e.target.closest('.btn-bulk-open') || e.target.closest('.btn-toggle-all-checks')) return;
                toggleCategory(categoryHeader);
            });

            const categoryTitleGroup = document.createElement('div');
            categoryTitleGroup.className = 'category-title-group';

            const categoryIcon = document.createElement('div');
            categoryIcon.className = `category-icon ${catGroup.meta.class}`;
            categoryIcon.textContent = catGroup.meta.icon;
            categoryTitleGroup.appendChild(categoryIcon);

            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'category-title';
            categoryTitle.textContent = catGroup.meta.title;
            categoryTitleGroup.appendChild(categoryTitle);
            
            const accordionIcon = document.createElement('span');
            accordionIcon.className = 'accordion-icon';
            accordionIcon.textContent = 'â–¼';
            categoryTitleGroup.appendChild(accordionIcon);

            categoryHeader.appendChild(categoryTitleGroup);

            const toggleAllChecksButton = document.createElement('button');
            toggleAllChecksButton.className = 'btn-toggle-all-checks';
            toggleAllChecksButton.textContent = 'âœ… å…¨é¸æŠ/å…¨è§£é™¤';
            toggleAllChecksButton.onclick = () => toggleAllCheckboxes(catKey);
            categoryHeader.appendChild(toggleAllChecksButton);

            const bulkOpenButton = document.createElement('button');
            bulkOpenButton.className = 'btn-bulk-open';
            bulkOpenButton.textContent = 'â–¶ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã‚’ä¸€æ‹¬ã§é–‹ã';
            bulkOpenButton.dataset.category = catKey;
            bulkOpenButton.onclick = () => openCheckedMaps(catKey);
            categoryHeader.appendChild(bulkOpenButton);
            
            categoryDiv.appendChild(categoryHeader);

            const mapGrid = document.createElement('div');
            mapGrid.className = 'map-grid';
            
            catGroup.maps.forEach(map => {
                const card = document.createElement('div'); 
                card.className = 'map-card';
                card.setAttribute('data-category', catKey); 
                card.setAttribute('data-map-index', map.index);
                
                card.onclick = (e) => {
                    if (e.target.classList.contains('map-checkbox') || e.target.closest('.map-checkbox')) {
                        return; 
                    }
                    openMap(map.index);
                };

                const mapHeaderWithCheck = document.createElement('div');
                mapHeaderWithCheck.className = 'map-header-with-check';

                const mapTitleGroupDiv = document.createElement('div');
                mapTitleGroupDiv.className = 'map-title-group';
                
                const mapTitleDiv = document.createElement('div');
                mapTitleDiv.className = 'map-title';
                mapTitleDiv.appendChild(document.createTextNode(`${map.icon} `));
                mapTitleDiv.appendChild(document.createTextNode(map.name));
                mapTitleGroupDiv.appendChild(mapTitleDiv);
                mapHeaderWithCheck.appendChild(mapTitleGroupDiv);

                const mapCheckbox = document.createElement('input');
                mapCheckbox.type = 'checkbox';
                mapCheckbox.className = 'map-checkbox';
                mapCheckbox.setAttribute('data-map-index', map.index);
                mapCheckbox.setAttribute('aria-label', `${map.name}ã®åœ°å›³ã‚’é–‹ã`);
                mapHeaderWithCheck.appendChild(mapCheckbox);
                card.appendChild(mapHeaderWithCheck);

                const mapDescriptionDiv = document.createElement('div');
                mapDescriptionDiv.className = 'map-description';
                mapDescriptionDiv.textContent = map.desc; // descã‚‚textContentã§å®‰å…¨ã«æŒ¿å…¥
                card.appendChild(mapDescriptionDiv);
                
                if (map.noCoords) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'manual-input-warning';
                    warningDiv.textContent = 'â€»é–‹ã„ãŸå¾Œã«ä½ç½®æƒ…å ±ï¼ˆçµŒç·¯åº¦ï¼‰ã‚’æ‰‹å‹•ã§æ¤œç´¢ãƒ»è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
                    card.appendChild(warningDiv);
                }
                mapGrid.appendChild(card);
            });
            categoryDiv.appendChild(mapGrid);
            $container.appendChild(categoryDiv);
        }
        filterMapCards(); 
    }

    /**
     * ãƒãƒƒãƒ—ã‚«ãƒ†ã‚´ãƒªã§åœ°å›³ã‚«ãƒ¼ãƒ‰ã‚’çµã‚Šè¾¼ã‚€
     */
    function filterMapCards() {
        const selectedCategories = Array.from(document.querySelectorAll('.category-filter-checkboxes input[type="checkbox"]:checked'))
                                        .map(cb => cb.value);
        const categoryDivs = document.querySelectorAll('.category');

        categoryDivs.forEach(div => {
            const categoryKey = div.getAttribute('data-category-key');
            
            if (selectedCategories.length === 0 || selectedCategories.includes('all') || selectedCategories.includes(categoryKey)) {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        });
    }
    
    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
     */
    function populateFilterCheckboxes() {
        $categoryFilterCheckboxes.innerHTML = ''; 

        const uniqueCategories = new Set(MAP_DEFINITIONS.map(map => map.category));
        uniqueCategories.add('all'); 

        const sortedCategories = Object.keys(CATEGORY_META).filter(key => uniqueCategories.has(key));

        sortedCategories.forEach(key => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = key;
            checkbox.checked = (key === 'all');
            checkbox.addEventListener('change', () => {
                if (checkbox.value === 'all' && checkbox.checked) {
                    Array.from(document.querySelectorAll('.category-filter-checkboxes input[type="checkbox"]'))
                         .forEach(cb => {
                             if (cb.value !== 'all') cb.checked = false;
                         });
                } else if (checkbox.value !== 'all' && checkbox.checked) {
                    document.querySelector('.category-filter-checkboxes input[value="all"]').checked = false;
                }
                const anyChecked = Array.from(document.querySelectorAll('.category-filter-checkboxes input[type="checkbox"]:checked')).some(cb => cb.value !== 'all');
                if (!anyChecked && !document.querySelector('.category-filter-checkboxes input[value="all"]').checked) {
                     document.querySelector('.category-filter-checkboxes input[value="all"]').checked = true;
                }

                filterMapCards();
            });

            label.appendChild(checkbox);
            const iconSpan = document.createElement('span');
            iconSpan.textContent = CATEGORY_META[key].icon + ' ';
            label.appendChild(iconSpan);
            label.appendChild(document.createTextNode(CATEGORY_META[key].title));
            $categoryFilterCheckboxes.appendChild(label);
        });
    }
    
    // =========================================================
    // 7. åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
    // =========================================================
    document.addEventListener('DOMContentLoaded', () => {
        setInitialMode(); 
        populateFilterCheckboxes();
        renderMapCards(); 

        initGeolocation(); 

        $lat.addEventListener('input', () => updateCurrentCoords());
        $lon.addEventListener('input', () => updateCurrentCoords());
        
        $zoom.addEventListener('input', (e) => {
            const val = parseInt(e.target.value, 10);
            $zoomDisplay.textContent = val;
            // Leafletãƒãƒƒãƒ—ã®ã‚ºãƒ¼ãƒ ã‚‚åŒæœŸ
            if (osmMap) {
                osmMap.setZoom(val);
            }
            updateCurrentCoords(true); // å±¥æ­´ä¿å­˜ã¯ã—ãªã„
        });
        $zoomDisplay.textContent = $zoom.value;

        $addressInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (selectedAutocompleteIndex !== -1) {
                    selectAutocompleteItem(selectedAutocompleteIndex);
                } else {
                    searchAddress();
                }
            }
        });

        $lat.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateCurrentCoords();
            }
        });

        $lon.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateCurrentCoords();
            }
        });

        $addressInput.addEventListener('input', () => {
            clearTimeout(autocompleteTimer);
            const query = $addressInput.value.trim();
            if (query.length < 2) {
                renderAutocompleteList([]);
                return;
            }
            autocompleteTimer = setTimeout(async () => {
                const suggestions = await getAddressSuggestions(query);
                renderAutocompleteList(suggestions);
            }, 300);
        });

        $addressInput.addEventListener('keydown', (e) => {
            const items = $autocompleteList.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedAutocompleteIndex = (selectedAutocompleteIndex + 1) % items.length;
                highlightAutocompleteItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedAutocompleteIndex = (selectedAutocompleteIndex - 1 + items.length) % items.length;
                highlightAutocompleteItem(items);
            } else if (e.key === 'Escape') {
                $autocompleteList.classList.remove('show');
                selectedAutocompleteIndex = -1;
            }
        });

        document.addEventListener('click', (e) => {
            // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒªã‚¹ãƒˆã®é–‹é–‰
            if (!e.target.closest('.input-group') || !e.target.closest('#addressInput')) {
                $autocompleteList.classList.remove('show');
                selectedAutocompleteIndex = -1;
            }
            
            // å±¥æ­´ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é–‹é–‰
            const isClickInsideHistoryPopup = $historyPopup.contains(e.target);
            const isClickInsideBookmarkPopup = $bookmarkPopup.contains(e.target);
            const isClickOnHistoryButton = $historyButton.contains(e.target);
            const isClickOnBookmarkButton = $bookmarkButton.contains(e.target);

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã¦ã€ã‹ã¤ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªèº«ã§ã‚‚ãƒœã‚¿ãƒ³ã§ã‚‚ãªã„å ´æ‰€ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            if (($historyPopup.style.display === 'block' && !isClickInsideHistoryPopup && !isClickOnHistoryButton) ||
                ($bookmarkPopup.style.display === 'block' && !isClickInsideBookmarkPopup && !isClickOnBookmarkButton)) {
                
                $historyPopup.style.display = 'none';
                $bookmarkPopup.style.display = 'none';
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šå±¥æ­´ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $historyList.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.history-item');
            if (itemDiv) {
                const index = parseInt(itemDiv.dataset.index, 10);
                const history = JSON.parse(localStorage.getItem('coordinateHistory') || '[]');
                if (history[index]) {
                    loadCoordinateFromHistory(history[index]);
                }
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $bookmarkList.addEventListener('click', (e) => {
            const itemDiv = e.target.closest('.bookmark-item');
            if (itemDiv) {
                const index = parseInt(itemDiv.dataset.index, 10);
                
                if (e.target.classList.contains('btn-bookmark-load')) {
                    loadBookmark(index);
                } else if (e.target.classList.contains('btn-bookmark-open')) {
                    openBookmarkMap(index);
                } else if (e.target.classList.contains('btn-bookmark-delete')) {
                    deleteBookmark(index);
                } else {
                    // ã‚¢ã‚¤ãƒ†ãƒ è‡ªä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼ˆã“ã‚Œã¯ç¾çŠ¶ã®onclickã¨åŒæ§˜ï¼‰
                    loadBookmark(index);
                }
            }
        });


        function highlightAutocompleteItem(items) {
            items.forEach((item, i) => {
                item.classList.remove('selected');
                if (i === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }


        if (parseFloat($lat.value) && parseFloat($lon.value)) {
            updateCurrentCoords(); 
        }
    });
</script>
</body>
</html>